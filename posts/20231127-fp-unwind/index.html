<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>fp unwind - åŒ—é‚™å±±ä¹‹å…‰çš„ Blog</title><meta name="Description" content=""><meta property="og:url" content="http://PTrainbow.github.io/posts/20231127-fp-unwind/">
  <meta property="og:site_name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
  <meta property="og:title" content="fp unwind">
  <meta property="og:description" content="ä¸ºäº†å…¬å¸å†…éƒ¨å†™ä¸€ç¯‡è½¯æ–‡ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« é‡å†™äº†ä¸€ä¸‹~~
æ­£æ–‡ ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ç§ arm64 å¹³å°ä¸‹æ ˆå›æº¯çš„æ–¹å¼ â€”â€” fp(frame pointer) å›æº¯ï¼ŒåŒæ—¶ä¼šä»‹ç»ä¸€äº›åŸºç¡€æ¦‚å¿µå’Œå®ç°åŸç†
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ ˆå›æº¯æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ
å…¶å®å°±æ˜¯ç”¨äºè·å–å½“å‰ thread çš„è°ƒç”¨å †æ ˆçš„">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-11-27T00:00:00+00:00">
    <meta property="article:tag" content="C/C&#43;&#43;">
    <meta property="og:image" content="http://PTrainbow.github.io/posts/20231127-fp-unwind/fp_unwind.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://PTrainbow.github.io/posts/20231127-fp-unwind/fp_unwind.png">
  <meta name="twitter:title" content="fp unwind">
  <meta name="twitter:description" content="ä¸ºäº†å…¬å¸å†…éƒ¨å†™ä¸€ç¯‡è½¯æ–‡ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« é‡å†™äº†ä¸€ä¸‹~~
æ­£æ–‡ ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ç§ arm64 å¹³å°ä¸‹æ ˆå›æº¯çš„æ–¹å¼ â€”â€” fp(frame pointer) å›æº¯ï¼ŒåŒæ—¶ä¼šä»‹ç»ä¸€äº›åŸºç¡€æ¦‚å¿µå’Œå®ç°åŸç†
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ ˆå›æº¯æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ
å…¶å®å°±æ˜¯ç”¨äºè·å–å½“å‰ thread çš„è°ƒç”¨å †æ ˆçš„">
<meta name="application-name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
<meta name="apple-mobile-web-app-title" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrainbow.github.io/posts/20231127-fp-unwind/" /><link rel="prev" href="http://PTrainbow.github.io/posts/%E8%B5%84%E6%BA%90%E5%8E%BB%E9%87%8D/" /><link rel="next" href="http://PTrainbow.github.io/posts/20231208-Kotlin-Native/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "fp unwind",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrainbow.github.io\/posts\/20231127-fp-unwind\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/PTrainbow.github.io\/posts\/20231127-fp-unwind\/fp_unwind.png",
                            "width":  1184 ,
                            "height":  1075 
                        }],"genre": "posts","keywords": "C\/C\u002b\u002b","wordcount":  2641 ,
        "url": "http:\/\/PTrainbow.github.io\/posts\/20231127-fp-unwind\/","datePublished": "2023-11-27T00:00:00+00:00","dateModified": "2023-11-27T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "åŒ—é‚™å±±ä¹‹å…‰"},"author": {
                "@type": "Person",
                "name": "åŒ—é‚™å±±ä¹‹å…‰"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/20231127-fp-unwind/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a>
                <a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/20231127-fp-unwind/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a>
        </div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">fp unwind</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>åŒ—é‚™å±±ä¹‹å…‰</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-11-27">2023-11-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 2641 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 6 åˆ†é’Ÿ&nbsp;
            </div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/20231127-fp-unwind/fp_unwind.png"
        data-srcset="/posts/20231127-fp-unwind/fp_unwind.png, /posts/20231127-fp-unwind/fp_unwind.png 1.5x, /posts/20231127-fp-unwind/fp_unwind.png 2x"
        data-sizes="auto"
        alt="/posts/20231127-fp-unwind/fp_unwind.png"
        title="/posts/20231127-fp-unwind/fp_unwind.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#æ­£æ–‡">æ­£æ–‡</a></li>
    <li><a href="#ä»€ä¹ˆæ˜¯æ ˆå¸§">ä»€ä¹ˆæ˜¯æ ˆå¸§</a></li>
    <li><a href="#frame-pointer-çš„åŸç†">frame pointer çš„åŸç†</a>
      <ul>
        <li><a href="#arm64-å¯„å­˜å™¨">arm64 å¯„å­˜å™¨</a></li>
        <li><a href="#c-å‡½æ•°è°ƒç”¨è¿‡ç¨‹">c å‡½æ•°è°ƒç”¨è¿‡ç¨‹</a></li>
      </ul>
    </li>
    <li><a href="#å›æº¯åŸç†">å›æº¯åŸç†</a>
      <ul>
        <li><a href="#signal-handler">signal handler</a></li>
        <li><a href="#stack-range">stack range</a></li>
        <li><a href="#no-return">no return</a></li>
      </ul>
    </li>
    <li><a href="#ç»“å°¾">ç»“å°¾</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>ä¸ºäº†å…¬å¸å†…éƒ¨å†™ä¸€ç¯‡è½¯æ–‡ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« é‡å†™äº†ä¸€ä¸‹~~</p>
<h2 id="æ­£æ–‡">æ­£æ–‡</h2>
<p>ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ç§ arm64 å¹³å°ä¸‹æ ˆå›æº¯çš„æ–¹å¼ â€”â€” fp(frame pointer) å›æº¯ï¼ŒåŒæ—¶ä¼šä»‹ç»ä¸€äº›åŸºç¡€æ¦‚å¿µå’Œå®ç°åŸç†</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ ˆå›æº¯æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ<br>
å…¶å®å°±æ˜¯ç”¨äºè·å–å½“å‰ thread çš„è°ƒç”¨å †æ ˆçš„</p>
<p>æ ˆå›æº¯çš„å®ç°æœ‰å¤šç§ï¼Œfp å›æº¯çš„ä¼˜ç‚¹æ˜¯ï¼šé€Ÿåº¦æå¿«ï¼Œç›¸åº”å°±ä¼šæœ‰ç¼ºç‚¹ï¼šå ç”¨å¯„å­˜å™¨ ä¿¡æ¯å°‘(åªèƒ½å›æº¯å‡ºå‡½æ•°åœ°å€) å¹¶ä¸” Android ä¸­å›æº¯ä¼šè¢« libart ä¸­æ–­</p>
<p>åŒæ—¶ï¼Œå› ä¸º fp å›æº¯ä¸ä¾èµ– .eh_frame ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥å¯ä»¥è£å‰ªæ‰ so ä¸­çš„ .eh_frame ä»¥ç¼©å‡ so ä½“ç§¯ï¼Œç›¸åº”çš„ï¼Œå› ä¸º .eh_frame çš„è£å‰ªï¼Œandroid ç³»ç»Ÿè‡ªå¸¦çš„ unwind å°†æ— æ³•è¿›è¡Œå †æ ˆå›æº¯</p>
<p>é‚£ä½•æ—¶æœ‰æ ˆå›æº¯çš„éœ€æ±‚å‘¢ï¼Ÿ<br>
å…¶å®è¿˜æ˜¯å¾ˆå¤šçš„<br>
æ¯”å¦‚ï¼š</p>
<ol>
<li>crash æ—¶çš„å †æ ˆæ•è·</li>
<li>ç‰¹æ®Šæ–¹æ³•çš„æºå¤´è¿½è¸ªï¼Œå¦‚ malloc pthread_create ç­‰</li>
</ol>
<p>é‚£æˆ‘ä»¬åˆæ˜¯å¦‚ä½•è·å–åˆ°å‡½æ•°çš„è°ƒç”¨å †æ ˆçš„å‘¢ï¼Ÿ<br>
è¿™å°±éœ€è¦æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ arm64 ä¸‹ frame pointer çš„åŸç†å’Œä¸€äº›æ ˆå¸§çš„åŸç†äº†(åç»­ä¼šä»‹ç»)</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå³ä½¿åŒæ ·ä¸º frame pointerï¼Œä½†æ˜¯å„ä¸ªç¼–è¯‘å™¨æœ€ç»ˆçš„å®ç°å¯èƒ½ä¹Ÿå¹¶ä¸ä¸€è‡´ï¼Œä½†æ˜¯ä¸å½±å“ä½¿ç”¨ï¼ˆç±»æ¯”ï¼šjvm æœ‰å¤šç§å®ç°ï¼Œä½†æ˜¯å¹¶ä¸å½±å“ä¸Šå±‚ java ä»£ç çš„ç»“æœï¼‰</p>
<h2 id="ä»€ä¹ˆæ˜¯æ ˆå¸§">ä»€ä¹ˆæ˜¯æ ˆå¸§</h2>
<p>æ— è®ºæˆ‘ä»¬ä½¿ç”¨ c/c++ è¿˜æ˜¯ä½¿ç”¨ java ç­‰è¯­è¨€ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¬åˆ°æ ˆå¸§çš„æ¦‚å¿µã€‚ç”šè‡³æœ‰å…³åç¨‹çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¹Ÿç»å¸¸å¬åˆ°æœ‰æ ˆåç¨‹(stackful coroutines)å’Œæ— æ ˆåç¨‹(stackless coroutines)çš„åŒºåˆ«</p>
<p>é‚£ä¹ˆæ ˆå¸§(stack frame)ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ<br>
å¯ä»¥æŸ¥çœ‹ <a href="https://en.wikipedia.org/wiki/Call_stack#STACK-FRAME" target="_blank" rel="noopener noreffer">wiki</a><br>
ç®€å•æ¥è¯´ï¼Œæ ˆå¸§å­˜å‚¨äº†ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œæ‰€éœ€è¦çš„æ•°æ®ã€‚å¦‚æœå­˜åœ¨æ–¹æ³•è°ƒç”¨ï¼Œä¼šåœ¨æ ˆä¸­å½¢æˆå¤šä¸ªæ ˆå¸§ï¼Œç±»ä¼¼ wiki ä¸­çš„å›¾<br>
ä½†æ˜¯è¿˜æ˜¯é‚£å¥è¯ï¼šæ ˆå¸§åªæ˜¯ä¸€å¥—æ ‡å‡†ï¼Œå…·ä½“å®ç°è¿˜æ˜¯çœ‹ç¼–è¯‘å™¨</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“ä¸€ä¸ªç‚¹ï¼š<strong>æ ˆæ˜¯å¾€ä½åœ°å€æ‹“å±•çš„</strong></p>
<p>é‚£ä¹ˆä¸€ä¸ª c å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ç©¶ç«Ÿæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ<br>
å¦‚æœï¼Œè¦å®Œå…¨çš„è®²é€šä¸€ä¸ª c å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œè¿˜æ˜¯ååˆ†å¤æ‚çš„<br>
å‚æ•°å­˜å–éƒ¨åˆ†ï¼Œå°±è¦æ¶‰åŠåˆ°è°ƒç”¨çº¦å®š(calling convention)ï¼Œå› ä¸ºå„æ¶æ„ä¸‹çš„è§„åˆ™æ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™å—æ²¡æ³•ç»†è¯´ï¼Œåªèƒ½é ç†Ÿè¯» cpu æ‰‹å†Œ <br>
æŠ›å¼€è¿™äº›ï¼Œæˆ‘ä»¬ä¸‹é¢å¯ä»¥ä¸€èµ·åˆ†æä¸€ä¸‹ arm64 ä¸‹çš„ç®€å•çš„ c å‡½æ•°çš„è°ƒç”¨æƒ…å†µ</p>
<blockquote>
<p>å¦‚æœæ˜¯ c++ å‡½æ•°ï¼Œè¿˜å¯èƒ½æœ‰å¼‚å¸¸ç›¸å…³çš„å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†(<strong>æ‰€ä»¥ c++ çš„å¼‚å¸¸æŠ›å‡ºå’Œæ•è·æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿjava å‘¢ï¼Ÿ</strong>)</p>
</blockquote>
<h2 id="frame-pointer-çš„åŸç†">frame pointer çš„åŸç†</h2>
<p>å½“æˆ‘ä»¬çš„ç¼–è¯‘å‚æ•°åŠ ä¸Š fno-omit-frame-pointer æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬ä¿ç•™ frame pointer ç›¸å…³æŒ‡ä»¤(æ‰€ä»¥ fp å›æº¯ï¼Œä¾èµ–é“¾è·¯ä¸Šçš„ so éƒ½å¼€å¯äº†ç›¸åº”çš„ç¼–è¯‘å‚æ•°)</p>
<p>ä»¥ä¸‹åˆ†æä¹Ÿå‡åŸºäºæ­¤</p>
<h3 id="arm64-å¯„å­˜å™¨">arm64 å¯„å­˜å™¨</h3>
<p>äº†è§£ frame pointerï¼Œä¹Ÿè¦å…ˆäº†è§£ arm64 å¯„å­˜å™¨</p>
<p>å¦‚ä¸‹(copy from <a href="https://learn.microsoft.com/zh-cn/cpp/build/arm64-windows-abi-conventions?view=msvc-170" target="_blank" rel="noopener noreffer">learn.microsoft</a>)ï¼š<br>
AArch64 ä½“ç³»ç»“æ„æ”¯æŒ 32 ä¸ªæ•´æ•°å¯„å­˜å™¨(è¿˜æœ‰ PC å’Œ SP)</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">æ³¨å†Œ</th>
          <th style="text-align: center">æ³¢åŠ¨</th>
          <th style="text-align: center">è§’è‰²</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">x0-x8</td>
          <td style="text-align: center">æ˜“å¤±çš„</td>
          <td style="text-align: center">å‚æ•°/ç»“æœä¸´æ—¶å¯„å­˜å™¨</td>
      </tr>
      <tr>
          <td style="text-align: center">x9-x15</td>
          <td style="text-align: center">æ˜“å¤±çš„</td>
          <td style="text-align: center">ä¸´æ—¶å¯„å­˜å™¨</td>
      </tr>
      <tr>
          <td style="text-align: center">x16-x17</td>
          <td style="text-align: center">æ˜“å¤±çš„</td>
          <td style="text-align: center">è¿‡ç¨‹å†…éƒ¨è°ƒç”¨ä¸´æ—¶å¯„å­˜å™¨</td>
      </tr>
      <tr>
          <td style="text-align: center">x18</td>
          <td style="text-align: center">ä¸å¯ç”¨</td>
          <td style="text-align: center">ä¿ç•™çš„å¹³å°å¯„å­˜å™¨ï¼šåœ¨å†…æ ¸æ¨¡å¼ä¸‹ï¼ŒæŒ‡å‘å½“å‰å¤„ç†å™¨çš„ KPCRï¼›åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼ŒæŒ‡å‘ TEB</td>
      </tr>
      <tr>
          <td style="text-align: center">x19-x28</td>
          <td style="text-align: center">éæ˜“å¤±æ€§çš„</td>
          <td style="text-align: center">ä¸´æ—¶å¯„å­˜å™¨</td>
      </tr>
      <tr>
          <td style="text-align: center">x29/fp</td>
          <td style="text-align: center">éæ˜“å¤±æ€§çš„</td>
          <td style="text-align: center">å¸§æŒ‡é’ˆ</td>
      </tr>
      <tr>
          <td style="text-align: center">x30/lr</td>
          <td style="text-align: center">æ¨é€ã€è¯·æ±‚å’ŒåŒ¿å</td>
          <td style="text-align: center">é“¾æ¥å¯„å­˜å™¨ï¼šè¢«è°ƒç”¨æ–¹å‡½æ•°å¿…é¡»ä¿ç•™å®ƒç”¨äºå…¶è‡ªå·±çš„è¿”å›ï¼Œä½†è°ƒç”¨æ–¹çš„å€¼å°†ä¸¢å¤±ã€‚</td>
      </tr>
  </tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦è®°ä½çš„æ˜¯ï¼š</p>
<ol>
<li>x29 å³æ˜¯å¸§æŒ‡é’ˆ<br>
ç”¨äºå­˜å‚¨ fp åœ°å€</li>
<li>x30 è¢«ç§°ä¸º lr<br>
ç”¨äºå­˜å‚¨å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œä¹Ÿå°±æ˜¯ç¡®å®šäº†å‡½æ•°è¿”å›åæ‰§è¡Œçš„åœ°å€(å…·ä½“æŸ¥çœ‹ bl æŒ‡ä»¤ï¼Œbl æŒ‡ä»¤ä¼šä¿®æ”¹ x30)ã€‚</li>
<li>pc å¯„å­˜å™¨<br>
æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</li>
<li>sp å¯„å­˜å™¨<br>
æŒ‡å‘æ ˆå¸§é¡¶éƒ¨(ä½åœ°å€)</li>
</ol>
<h3 id="c-å‡½æ•°è°ƒç”¨è¿‡ç¨‹">c å‡½æ•°è°ƒç”¨è¿‡ç¨‹</h3>
<p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ c å‡½æ•°è°ƒç”¨</p>
<p>c ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">xc_test_call_2</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//ç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">xc_test_call_1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">xc_test_call_2</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">xc_test_call_1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸å¼€å¯ä»»ä½•ä¼˜åŒ–ï¼Œå¯¹åº”æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">main</span><span class="err">`</span><span class="no">main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100003b9c</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">sub</span>    <span class="no">sp</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003ba0</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">stp</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">x30</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x20]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003ba4</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">add</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003ba8</span> <span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">w8</span><span class="p">,</span> <span class="c1">#0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bac</span> <span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">str</span>    <span class="no">w8</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bb0</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">stur</span>   <span class="no">wzr</span><span class="p">,</span> <span class="p">[</span><span class="no">x29</span><span class="p">,</span> <span class="c1">#-0x4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bb4</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">stur</span>   <span class="no">w0</span><span class="p">,</span> <span class="p">[</span><span class="no">x29</span><span class="p">,</span> <span class="c1">#-0x8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bb8</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">str</span>    <span class="no">x1</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x10]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bbc</span> <span class="err">&lt;+</span><span class="mi">32</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">bl</span>     <span class="mi">0x100003b74</span>               <span class="c1">; xc_test_call_1 at main.m:51
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bc0</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">x8</span><span class="p">,</span> <span class="no">x0</span>
</span></span><span class="line"><span class="cl">    <span class="err">0</span><span class="nf">x100003bc4</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ldr</span>    <span class="no">w0</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bc8</span> <span class="err">&lt;+</span><span class="mi">44</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">str</span>    <span class="no">w8</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0xc]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bcc</span> <span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ldp</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">x30</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x20]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bd0</span> <span class="err">&lt;+</span><span class="mi">52</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">add</span>    <span class="no">sp</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003bd4</span> <span class="err">&lt;+</span><span class="mi">56</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ret</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">main</span><span class="err">`</span><span class="no">xc_test_call_1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100003b74</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">sub</span>    <span class="no">sp</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b78</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">stp</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">x30</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x10]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b7c</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">add</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b80</span> <span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">w0</span><span class="p">,</span> <span class="c1">#0x1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b84</span> <span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">bl</span>     <span class="mi">0x100003b44</span>               <span class="c1">; xc_test_call_2 at main.m:46
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b88</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">stur</span>   <span class="no">w0</span><span class="p">,</span> <span class="p">[</span><span class="no">x29</span><span class="p">,</span> <span class="c1">#-0x4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b8c</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ldur</span>   <span class="no">w0</span><span class="p">,</span> <span class="p">[</span><span class="no">x29</span><span class="p">,</span> <span class="c1">#-0x4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b90</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ldp</span>    <span class="no">x29</span><span class="p">,</span> <span class="no">x30</span><span class="p">,</span> <span class="p">[</span><span class="no">sp</span><span class="p">,</span> <span class="c1">#0x10]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b94</span> <span class="err">&lt;+</span><span class="mi">32</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">add</span>    <span class="no">sp</span><span class="p">,</span> <span class="no">sp</span><span class="p">,</span> <span class="c1">#0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">0</span><span class="nf">x100003b98</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ret</span>    
</span></span></code></pre></div><p>æˆ‘ä»¬å…ˆæ¥çœ‹ main å‡½æ•°çš„æ‰§è¡Œ</p>
<ol>
<li>å°† sp å‘ä¸‹æ‹“å±• 0x30 48å­—èŠ‚</li>
<li>å°† x29 å’Œ x30 æ­¤æ—¶çš„å€¼ï¼Œå­˜å‚¨åˆ° sp åç§» 0x20 32å­—èŠ‚ ä½ç½®(stp æŒ‡ä»¤å°±åšäº†è¿™ä¸ªäº‹æƒ…)</li>
<li>å°† x29 çš„å€¼æ›´æ–°ï¼Œæ›´æ–°ä¸º sp åç§» 0x20 çš„åœ°å€å€¼(è¿™ä¸ªä½ç½®åˆšå¥½æ˜¯ä¸Šé¢å­˜çš„ä¹‹å‰çš„ x29 çš„å€¼)</li>
</ol>
<p>æ­¤æ—¶ï¼Œæ—§çš„ x29 x30 çš„å€¼è¢«å­˜å‚¨åœ¨äº† sp + 0x20 çš„ä½ç½®ï¼Œè€Œæ–°çš„ x29 å­˜å‚¨çš„å°±æ˜¯ sp + 0x20 çš„åœ°å€</p>
<p>ç»“åˆå›¾æ¥çœ‹ï¼š
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/main_stack.png"
        data-srcset="/img/in-post/main_stack.png, /img/in-post/main_stack.png 1.5x, /img/in-post/main_stack.png 2x"
        data-sizes="auto"
        alt="/img/in-post/main_stack.png"
        title="/img/in-post/main_stack.png" /></p>
<p>å½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œbl æŒ‡ä»¤è·³è½¬åˆ° xc_test_call_1(0x100003b74) å¤„ï¼ŒåŒæ—¶ bl æŒ‡ä»¤ä¼šä¿®æ”¹ x30 çš„å€¼ï¼ŒæŒ‡å‘ bl çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€(0x100003bc0)</p>
<p>ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ xc_test_call_1 çš„æ‰§è¡Œï¼Œå¼€å¤´åŒ main ä¸€è‡´(å…¶å® frame pointer å°±æ˜¯é è¿™å‡ æ¡æŒ‡ä»¤å®ç°çš„)</p>
<ol>
<li>å°† sp å‘ä¸‹æ‹“å±• 0x20 32å­—èŠ‚</li>
<li>å°† x29 å’Œ x30 æ­¤æ—¶çš„å€¼ï¼Œå­˜å‚¨åˆ° sp åç§» 0x10 16å­—èŠ‚ ä½ç½®(æ­¤æ—¶ x30 æŒ‡å‘çš„æ˜¯ main å‡½æ•°ä¸­ bl çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œx29 æ˜¯ main å‡½æ•° stack frame ä¸­çš„ fp çš„åœ°å€)</li>
<li>å°† x29 çš„å€¼æ›´æ–°ï¼Œæ›´æ–°ä¸º sp åç§» 0x10 çš„åœ°å€å€¼(åŒä¸Šï¼Œåˆšå¥½å°±æ˜¯ç°åœ¨çš„ xc_test_call_1 fp çš„åœ°å€)</li>
</ol>
<p>ç»“åˆå›¾æ¥çœ‹ï¼š
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/call_1_stack_frame.png"
        data-srcset="/img/in-post/call_1_stack_frame.png, /img/in-post/call_1_stack_frame.png 1.5x, /img/in-post/call_1_stack_frame.png 2x"
        data-sizes="auto"
        alt="/img/in-post/call_1_stack_frame.png"
        title="/img/in-post/call_1_stack_frame.png" /></p>
<p>æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ï¼Œæ­¤æ—¶ x29 å­˜å‚¨äº†å½“å‰ xc_test_call_1 fp çš„åœ°å€ï¼Œæˆ‘ä»¬è¯»å‡ºè¿™ä¸ªåœ°å€çš„å€¼ï¼Œä¼šå‘ç°ä»–å…¶å®æŒ‡å‘çš„æ˜¯ main çš„ fp çš„åœ°å€</p>
<p>fp å°±è¿™æ ·å¯ä»¥å¸®åŠ©æˆ‘ä»¬é“¾æ¥ä¸¤ä¸ªæ ˆå¸§ï¼Œè€Œåç»­è°ƒç”¨çš†æ˜¯å¦‚æ­¤ï¼Œåªè¦æˆ‘ä»¬æ‰¾åˆ°å½“å‰çš„ x29ï¼Œå°±å¯ä»¥é€šè¿‡ fp ä¸æ–­å‘ä¸Šå›æº¯</p>
<h2 id="å›æº¯åŸç†">å›æº¯åŸç†</h2>
<p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä¸æ–­çš„æ‹¿åˆ° fp çš„å€¼äº†ï¼Œåˆå› ä¸º lr æ°¸è¿œåœ¨ fp çš„é«˜8å­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥è·å–åˆ° lr çš„å€¼</p>
<p>lr å°±æ˜¯æˆ‘ä»¬çš„å‡½æ•°æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œé€šè¿‡ lr çš„åœ°å€ï¼ŒæŠŠåœ°å€è§£ææˆå‡½æ•°ç¬¦å·ï¼Œå³å®Œæˆäº†æ•´ä¸ªå›æº¯è¿‡ç¨‹(å½“ç„¶ï¼Œåœ°å€è§£æä¸ºç¬¦å·åˆæ˜¯ä¸€å—å†…å®¹äº†)</p>
<p>è¿™å°±æ˜¯ fp å›æº¯çš„æ•´ä¸ªçš„åŸç†äº†</p>
<p>åœ¨ binoic libc ä¸­ä¹Ÿæœ‰ç®€å•çš„å®ç°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">__attribute__</span><span class="p">((</span><span class="nf">no_sanitize</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="s">&#34;hwaddress&#34;</span><span class="p">)))</span> <span class="kt">size_t</span> <span class="nf">android_unsafe_frame_pointer_chase</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uintptr_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">num_entries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Disable MTE checks for the duration of this function, since we can&#39;t be sure that following
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// next_frame pointers won&#39;t cause us to read from tagged memory. ASAN/HWASAN are disabled here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// for the same reason.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ScopedDisableMTE</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">frame_record</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uintptr_t</span> <span class="n">next_frame</span><span class="p">,</span> <span class="n">return_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="nf">__builtin_frame_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="nf">__get_thread_stack_top</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">stack_t</span> <span class="n">ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">sigaltstack</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">ss_flags</span> <span class="o">&amp;</span> <span class="n">SS_ONSTACK</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">end</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">ss_sp</span><span class="p">)</span> <span class="o">+</span> <span class="n">ss</span><span class="p">.</span><span class="n">ss_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(__riscv)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// Frame addresses seem to have been implemented incorrectly for RISC-V.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// See https://reviews.llvm.org/D87579. We did at least manage to get this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// documented in the RISC-V psABI though:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// https://github.com/riscv-non-isa/riscv-elf-psabi-doc/blob/master/riscv-cc.adoc#frame-pointer-convention
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">frame_record</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">begin</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">auto</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">frame_record</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">num_frames</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">uintptr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">__bionic_clear_pac_bits</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">return_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span><span class="p">[</span><span class="n">num_frames</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">num_frames</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span> <span class="o">&lt;</span> <span class="n">begin</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame_record</span><span class="p">)</span> <span class="o">||</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">begin</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">num_frames</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç ï¼Œç®€å•ä½¿ç”¨æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æœ‰ä¸‹é¢å‡ ä¸ªé—®é¢˜éœ€è¦æ³¨æ„</p>
<h3 id="signal-handler">signal handler</h3>
<p>å¦‚æœä½¿ç”¨ signalhandler æ¥åš crash æ•è·ï¼Œæ­¤æ—¶æƒ³æŠ“å–å †æ ˆçš„è¯ï¼Œåˆ«å¿˜è®°å…ˆæŠŠå½“å‰çš„ pc å€¼ä½œä¸ºç¬¬ä¸€å±‚å †æ ˆ</p>
<p>ç„¶åè¦ä½¿ç”¨ signalhandler çš„ context å»è·å– x29 çš„å€¼ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ __builtin_frame_address(0)</p>
<h3 id="stack-range">stack range</h3>
<p>æˆ‘ä»¬çŸ¥é“å¯ä»¥é€šè¿‡ fp çš„å€¼ï¼Œä¸æ–­è·å–å…¶ä»– fp çš„å€¼ï¼Œä½†æ˜¯ç»ˆæ­¢æ¡ä»¶æ˜¯å¦‚ä½•çš„å‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯ stack çš„èŒƒå›´çš„é—®é¢˜</p>
<p>æˆ‘ä»¬éœ€è¦ç¡®è®¤ stack çš„æ­£ç¡®èŒƒå›´</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">pthread_attr_t</span> <span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">pthread_getattr_np</span><span class="p">(</span><span class="nf">pthread_self</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">thread_stack_high</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">stack_base</span><span class="p">)</span> <span class="o">+</span> <span class="n">attr</span><span class="p">.</span><span class="n">stack_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">thread_stack_low</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">stack_base</span><span class="p">);</span>
</span></span></code></pre></div><p>åŒæ—¶ï¼Œå¦‚æœä½äº signal handler ä¸­ï¼Œè¦è€ƒè™‘ signal stack</p>
<h3 id="no-return">no return</h3>
<p>æˆ‘ä»¬ä¹‹å‰ä¸€ç›´è¯´çš„æ˜¯ï¼Œé€šè¿‡ fp è·å– lrï¼Œè¿›è€Œé€šè¿‡ lr è§£æä¸ºå¯¹åº”çš„å‡½æ•°ç¬¦å·</p>
<p>ä½†æ˜¯ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µéœ€è¦å…¼å®¹</p>
<p>æ¯”å¦‚ bl æŒ‡ä»¤å°±æ˜¯å½“å‰å‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤ï¼Œæ²¡æœ‰ ret æŒ‡ä»¤ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ bl ä¼šæŠŠå…¶ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å­˜å‚¨åˆ° x30(lr) ä¸­ã€‚é‚£æ­¤æ—¶çš„ lr å·²ç»åˆ°äº†å¦ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæœ€ç»ˆå°±ä¼šå‡ºç°å‡½æ•°å †æ ˆçš„ç¼ºå¤±</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„ lr è·å–ä»¥åéœ€è¦ -4(arm64 æŒ‡ä»¤ä¸º 4å­—èŠ‚)ï¼Œè¿™æ ·æ‰ä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜</p>
<h2 id="ç»“å°¾">ç»“å°¾</h2>
<p>é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥çª¥æ¢äº† c å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæ˜ç™½äº† fp unwind çš„åŸºæœ¬åŸç†</p>
<p>è™½ç„¶åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œè¿™äº›çŸ¥è¯†å¯èƒ½æ²¡ä»€ä¹ˆä½œç”¨ï¼Œä½†æ˜¯æœ‰æ¸…æ™°çš„åŸºç¡€ç†è®ºï¼Œæ€»ä¼šé‡å˜äº§ç”Ÿè´¨å˜çš„</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2023-11-27</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/C/C&#43;&#43;/">C/C&#43;&#43;</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E8%B5%84%E6%BA%90%E5%8E%BB%E9%87%8D/" class="prev" rel="prev" title="èµ„æºå»é‡"><i class="fas fa-angle-left fa-fw"></i>èµ„æºå»é‡</a>
            <a href="/posts/20231208-Kotlin-Native/" class="next" rel="next" title="Kotlin/Native">Kotlin/Native<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.1">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrainbow"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2023-11-27T00:00:00Z","owner":"PTrainbow","repo":"PTrainbow.github.io","title":"fp unwind"}},"data":{"id-1":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog","id-2":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
