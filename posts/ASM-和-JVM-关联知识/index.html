<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>ASM å’Œ JVM å…³è”çŸ¥è¯† - åŒ—é‚™å±±ä¹‹å…‰çš„ Blog</title><meta name="Description" content=""><meta property="og:url" content="http://PTrainbow.github.io/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/">
  <meta property="og:site_name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
  <meta property="og:title" content="ASM å’Œ JVM å…³è”çŸ¥è¯†">
  <meta property="og:description" content="èƒŒæ™¯ æœ€è¿‘åšæ—¥å¿—æ²»ç†(å…¶å®ä¹Ÿæ²¡å•¥æ²»ç†çš„)ï¼Œå‘ç°æ—¥å¿—å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œå› ä¸ºå„ä¸ªä¸šåŠ¡æ–¹çš„æ—¥å¿—æ±‡æ€»åœ¨ä¸€ä¸ªå®ä¾‹é‡Œï¼Œæœ‰ä»»ä½•æ— ç”¨æ—¥å¿—é¢‘ç¹æ‰“å°ï¼Œéƒ½ä¼šæŠŠæ—¥å¿—è¦†ç›–æ‰
é‚£å…¶å®ï¼Œæ²»ç†çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼š">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-21T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-07-21T00:00:00+00:00">
    <meta property="article:tag" content="Java">
    <meta property="og:image" content="http://PTrainbow.github.io/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://PTrainbow.github.io/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg">
  <meta name="twitter:title" content="ASM å’Œ JVM å…³è”çŸ¥è¯†">
  <meta name="twitter:description" content="èƒŒæ™¯ æœ€è¿‘åšæ—¥å¿—æ²»ç†(å…¶å®ä¹Ÿæ²¡å•¥æ²»ç†çš„)ï¼Œå‘ç°æ—¥å¿—å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œå› ä¸ºå„ä¸ªä¸šåŠ¡æ–¹çš„æ—¥å¿—æ±‡æ€»åœ¨ä¸€ä¸ªå®ä¾‹é‡Œï¼Œæœ‰ä»»ä½•æ— ç”¨æ—¥å¿—é¢‘ç¹æ‰“å°ï¼Œéƒ½ä¼šæŠŠæ—¥å¿—è¦†ç›–æ‰
é‚£å…¶å®ï¼Œæ²»ç†çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼š">
<meta name="application-name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
<meta name="apple-mobile-web-app-title" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrainbow.github.io/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/" /><link rel="prev" href="http://PTrainbow.github.io/posts/LearnJVM-%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8F%91%E7%8E%B0/" /><link rel="next" href="http://PTrainbow.github.io/posts/2024%E6%8F%90%E5%89%8D%E6%80%BB%E7%BB%93/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ASM å’Œ JVM å…³è”çŸ¥è¯†",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrainbow.github.io\/posts\/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/PTrainbow.github.io\/posts\/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86\/asm.jpg",
                            "width":  1540 ,
                            "height":  594 
                        }],"genre": "posts","keywords": "Java","wordcount":  4222 ,
        "url": "http:\/\/PTrainbow.github.io\/posts\/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86\/","datePublished": "2024-07-21T00:00:00+00:00","dateModified": "2024-07-21T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "åŒ—é‚™å±±ä¹‹å…‰"},"author": {
                "@type": "Person",
                "name": "åŒ—é‚™å±±ä¹‹å…‰"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a>
                <a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a>
        </div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">ASM å’Œ JVM å…³è”çŸ¥è¯†</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>åŒ—é‚™å±±ä¹‹å…‰</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2024-07-21">2024-07-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 4222 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ&nbsp;
            </div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg"
        data-srcset="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg, /posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg 1.5x, /posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg 2x"
        data-sizes="auto"
        alt="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg"
        title="/posts/ASM-%E5%92%8C-JVM-%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86/asm.jpg" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
    <li><a href="#å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</a>
      <ul>
        <li><a href="#1æ–¹æ³•è°ƒç”¨å’Œæ ˆå¸§çš„é€šç”¨æ¦‚å¿µ">1.æ–¹æ³•è°ƒç”¨å’Œæ ˆå¸§çš„é€šç”¨æ¦‚å¿µ</a></li>
        <li><a href="#2java-classfile-format-ä¸­çš„-operand-stack-å’Œ-local-variable">2.Java ClassFile Format ä¸­çš„ Operand Stack å’Œ Local Variable</a></li>
        <li><a href="#3java-æ–¹æ³•æ‰§è¡Œæµç¨‹">3.Java æ–¹æ³•æ‰§è¡Œæµç¨‹</a></li>
        <li><a href="#4asm-ç®€å•äº†è§£">4.ASM ç®€å•äº†è§£</a></li>
        <li><a href="#5transform-ç®€å•äº†è§£">5.Transform ç®€å•äº†è§£</a></li>
      </ul>
    </li>
    <li><a href="#å…·ä½“å®ç°">å…·ä½“å®ç°</a>
      <ul>
        <li><a href="#plugin-åˆ›å»º">Plugin åˆ›å»º</a></li>
        <li><a href="#asm-å¤„ç†">ASM å¤„ç†</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æœ€è¿‘åšæ—¥å¿—æ²»ç†(å…¶å®ä¹Ÿæ²¡å•¥æ²»ç†çš„)ï¼Œå‘ç°æ—¥å¿—å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œå› ä¸ºå„ä¸ªä¸šåŠ¡æ–¹çš„æ—¥å¿—æ±‡æ€»åœ¨ä¸€ä¸ªå®ä¾‹é‡Œï¼Œæœ‰ä»»ä½•æ— ç”¨æ—¥å¿—é¢‘ç¹æ‰“å°ï¼Œéƒ½ä¼šæŠŠæ—¥å¿—è¦†ç›–æ‰</p>
<p>é‚£å…¶å®ï¼Œæ²»ç†çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼š</p>
<ol>
<li>å¢å¤§æ—¥å¿—ç¼“å­˜å¤§å°</li>
<li>æ²»ç†æ— ç”¨æ—¥å¿—</li>
</ol>
<p>å¯¹äº1ï¼Œæ”¹ä¸ªå‚æ•°å°±å®Œäº‹å„¿äº†ï¼Œå®é™…è¿™ä¹Ÿæ˜¯æœ€æœ‰æ•ˆçš„åŠæ³•ã€‚<br>
å¯¹äº2ï¼Œè¿™å¾—æ·±å…¥ä¸šåŠ¡ï¼Œå¾€å¾€å°±æ˜¯ä¸€äº›æ‰¯çš®å’Œç”©é”…çš„äº‹æƒ…</p>
<p>ä½†æ˜¯ï¼Œ<code>â€œè¿½æ±‚æè‡´â€</code>çš„ä»·å€¼è§‚å‘Šè¯‰æˆ‘ä»¬ï¼Œå¤„ç†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±è¦å›´ç»•è¿™ä¸ªé—®é¢˜å»ºè®¾ä¸€ç³»åˆ—çš„å·¥å…·ï¼Œæ¯”å¦‚ï¼šæ—¥å¿—å‡ºé—®é¢˜äº†ï¼Œèƒ½ä¸»åŠ¨å‘ç°å—ï¼Ÿæœ‰æ— ç”¨æ—¥å¿—ï¼Œé‚£èƒ½ä¸èƒ½ç›´æ¥çŸ¥é“å“ªé‡Œæ˜¯æ— ç”¨çš„ï¼Ÿç­‰ç­‰å¤šç§å·æ³•ï¼Œè¿™ä¹Ÿæ˜¯æ‰€è°“ <code>â€œæ€è€ƒâ€</code> çš„ä½“ç°</p>
<p>é‚£æŠ˜ä¸­çš„åŠæ³•ï¼Œå°±æ˜¯å„ä¸ªä¸šåŠ¡è‡ªå·±ä½¿ç”¨è‡ªå·±çš„æ—¥å¿—å®ä¾‹æ‰“å°æ—¥å¿—(æ—¥å¿—åç»­æ˜¯å¯ä»¥åˆå¹¶çš„)ï¼Œå¦‚æœæœ‰ä¸šåŠ¡æ–¹æ—¥å¿—é¢‘ç¹æ‰“å°ä¹Ÿåªæ˜¯è¦†ç›–è‡ªå·±çš„æ—¥å¿—ï¼Œè‡ªå·±å»å¤„ç†</p>
<p>éšä¹‹è€Œæ¥çš„å°±æ˜¯å¦ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä¿®æ”¹è¿™éƒ¨åˆ†çš„ä»£ç å‘¢ï¼Ÿ</p>
<p>ä¹Ÿå¾ˆç®€å•ï¼š</p>
<ol>
<li>å†™ä¸ªè„šæœ¬ï¼ŒæŠŠè°ƒç”¨ä¹‹å‰æ—§çš„æ—¥å¿—æ–¹æ³•çš„åœ°æ–¹ï¼Œå…¨æ”¹æˆæ–°çš„</li>
<li>ç¼–è¯‘æœŸå¤„ç†</li>
</ol>
<p>å¯¹äº1ï¼Œç®€å•ç›´æ¥ï¼Œæ²¡æœ‰äºŒä¹‰æ€§ï¼Œä½†æ˜¯æ”¶åˆ°äº†åå¯¹æ„è§ï¼šlog æ–¹æ³•åœ¨ base ä¸­ï¼Œå¤šåŒ…ä¾èµ–ï¼Œä¸å¯ä»¥å«æœ‰ä¸šåŠ¡ä»»ä½•å±æ€§ã€‚</p>
<p>é‚£å°±åªèƒ½èµ°2äº†ï¼Œäºæ˜¯æ‰æœ‰äº†ä»Šå¤©è¿™ç¯‡æ–‡ç« </p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹è¦åšçš„äº‹æƒ…ï¼š</p>
<p>åœ¨ç¼–è¯‘æœŸï¼Œå°†æ‰€æœ‰çš„ Log.v/d/i/w/e(tag, msg) ç­‰æ–¹æ³•ï¼Œä¿®æ”¹ä¸º LogV2.v/d/i/w/e(biz, tag, msg)ï¼Œä¹Ÿå°±æ˜¯åŠ ä¸Šäº†ä¸€ä¸ª biz å‚æ•°</p>
<p>è¿™ä¸ªæœ¬èº«å¯ä»¥ä½¿ç”¨ lancet ç®€å•è§£å†³ï¼Œä½†æ˜¯ lancet ä¼šå¯¼è‡´æ‰€æœ‰æ–°å¢çš„ api ä¸º publicï¼Œå¹¶ä¸” biz çš„å€¼éœ€è¦å­˜å‚¨åœ¨å†…å­˜ä¹‹ä¸­ã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆè‡ªå·±å®ç°ä¸€ä¸ªç±»ä¼¼ç®€å•ç‰ˆ lancet åŠŸèƒ½çš„æ’ä»¶</p>
<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2>
<h3 id="1æ–¹æ³•è°ƒç”¨å’Œæ ˆå¸§çš„é€šç”¨æ¦‚å¿µ">1.æ–¹æ³•è°ƒç”¨å’Œæ ˆå¸§çš„é€šç”¨æ¦‚å¿µ</h3>
<p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ï¼šä¸€ä¸ªæ–¹æ³•ç©¶ç«Ÿæ˜¯æ€ä¹ˆè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•çš„ï¼Ÿ</p>
<p>å‡å¦‚ï¼Œæˆ‘ä»¬è€ƒè™‘æœ€æœ€åº•å±‚çš„å¯„å­˜å™¨è§†è§’ï¼Œå…¶å®å°±æ˜¯ä¸æ–­çš„æ‰§è¡Œå„ç§ cpu æŒ‡ä»¤åšè®¡ç®—ï¼Œç„¶åä»å¯„å­˜å™¨ä¸­å­˜å€¼å’Œå–å€¼</p>
<p>é‚£æˆ‘ä»¬å½“ç„¶ä¹ŸçŸ¥é“ï¼Œcpu æ¶æ„æœ‰å¤šç§ï¼Œæ¯ç§æ¶æ„éƒ½æœ‰è‡ªå·±çš„è§„åˆ™ï¼Œçº¦å®šå‚æ•°ä»å“ªé‡Œæ‹¿ï¼Ÿè¿”å›å€¼å¡åˆ°å“ªé‡Œï¼Ÿç­‰ç­‰ï¼Œå°±äº›è§„åˆ™å°±å«åš <code>è°ƒç”¨çº¦å®š</code>(calling convention)</p>
<p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ frame pointer æ ˆå›æº¯çš„æ–‡ç« ï¼Œä¹Ÿä¸ä¹‹ç›¸å…³ã€‚æ¯”å¦‚ï¼Œåœ¨ arm64 ä¸‹ x29 å¯„å­˜å™¨å°±æ˜¯ç”¨æ¥å­˜å‚¨ frame pointer çš„ï¼Œè¿™å°±æ˜¯çº¦å®š</p>
<p>å…¶æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šä¸ºè¿™ä¸ªæ–¹æ³•åœ¨æ ˆä¸Šå¼€è¾Ÿä¸€ç‰‡ç©ºé—´ï¼Œç„¶ååœ¨è¿™ç‰‡ç©ºé—´ä¸Šå»å­˜ä¸€äº›å€¼ï¼Œæ¯”å¦‚è¿”å›åœ°å€ï¼Œæ–¹æ³•å‚æ•°åœ°å€ï¼Œæ¯”å¦‚ frame pointer çš„å€¼(å¦‚æœæœ‰)ï¼Œè¿™äº›éƒ½æ˜¯<code>ç¼–è¯‘å™¨</code>å¸®ä½ å¤„ç†çš„ï¼Œæ‰€ä»¥æ¯ç§ç¼–è¯‘å™¨æœ€ç»ˆäº§ç”Ÿçš„æ ˆå¸§çš„å†…å­˜å¸ƒå±€ï¼Œå¯èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œä½†æ˜¯æœ‰å„è‡ªçš„è§„å¾‹ï¼Œç¨³å®šçš„å®ç°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹</p>
<p>wiki ä¸Šç»™çš„ä¸€ä¸ªå®½æ³›çš„è§„å®šå¦‚ä¸‹ï¼š
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/call_stack_layout.png"
        data-srcset="/img/in-post/call_stack_layout.png, /img/in-post/call_stack_layout.png 1.5x, /img/in-post/call_stack_layout.png 2x"
        data-sizes="auto"
        alt="/img/in-post/call_stack_layout.png"
        title="/img/in-post/call_stack_layout.png" /></p>
<h3 id="2java-classfile-format-ä¸­çš„-operand-stack-å’Œ-local-variable">2.Java ClassFile Format ä¸­çš„ Operand Stack å’Œ Local Variable</h3>
<p>ä¸Šé¢ç®€å•è¯´äº†ä¸€ä¸ª C æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ï¼Œé‚£ä¸€ä¸ª Java æ–¹æ³•åˆæ˜¯å¦‚ä½•è°ƒç”¨çš„å‘¢ï¼Ÿæ¦‚å¿µä¸ŠåŸºæœ¬æ˜¯ä¸€è‡´çš„</p>
<p>java æ¥æ”¶çš„æ˜¯ class æ–‡ä»¶ï¼Œclass æ–‡ä»¶ä¸­åŒ…å«è®¸å¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿™ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™æœ¬åœ°å˜é‡æœ‰å¤šå°‘ä¸ª(<code>local variable</code>)ï¼Ÿæ“ä½œæ ˆæœ‰å¤šå¤§(<code>operand stack</code>)ï¼Ÿ(å…¶å®è¦å¼€è¾Ÿå¤šå°‘å†…å­˜ç©ºé—´)ç­‰ç­‰</p>
<p>è¿™ä¸¤ä¸ªä¸œè¥¿éƒ½æ˜¯<code>ç¼–è¯‘æœŸå·²ç»ç¡®å®š</code>çš„ï¼Œå¦‚æœè§£æè¿‡ class æ–‡ä»¶çš„è¯ï¼Œå¤§å®¶å°±çŸ¥é“åœ¨ code attribute ä¸­å­˜åœ¨è¿™ä¸¤é¡¹å€¼ï¼Œåœ¨åˆ›å»º stack frame çš„æ—¶å€™è‡ªç„¶ä¼šç”¨åˆ°</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/operand_stack.png"
        data-srcset="/img/in-post/operand_stack.png, /img/in-post/operand_stack.png 1.5x, /img/in-post/operand_stack.png 2x"
        data-sizes="auto"
        alt="/img/in-post/operand_stack.png"
        title="/img/in-post/operand_stack.png" /></p>
<p>å½“æˆ‘ä»¬è¿è¡Œä»£ç çš„æ—¶å€™ï¼Œå°±æ˜¯ä¸æ–­çš„ä» local variable ä¸­ load ä¸€ä¸ªå€¼åˆ° operand stack ä¸Šï¼Œæˆ–è€…ä» operand stack ä¸Š store ä¸€ä¸ªå€¼åˆ° local variable ä¸­ï¼Œå¦‚æ­¤åå¤å¾ªç¯~~</p>
<h3 id="3java-æ–¹æ³•æ‰§è¡Œæµç¨‹">3.Java æ–¹æ³•æ‰§è¡Œæµç¨‹</h3>
<p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªéå¸¸ç®€å•çš„ kotlin æ–¹æ³•è°ƒç”¨çš„å­—èŠ‚ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">a</span> <span class="p">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">b</span> <span class="p">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">c</span><span class="p">=</span> <span class="n">a</span><span class="p">+</span><span class="n">b</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;hello world! </span><span class="si">$c</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯¹åº”å­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>  L0
    LINENUMBER 6 L0
    ICONST_1
    ISTORE 0
   L1
    LINENUMBER 7 L1
    ICONST_2
    ISTORE 1
   L2
    LINENUMBER 8 L2
    ILOAD 0
    ILOAD 1
    IADD
    ISTORE 2
   L3
    LINENUMBER 9 L3
    NEW java/lang/StringBuilder
    DUP
    INVOKESPECIAL java/lang/StringBuilder.&lt;init&gt; ()V
    LDC &#34;hello world! &#34;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    ILOAD 2
    INVOKEVIRTUAL java/lang/StringBuilder.append (I)Ljava/lang/StringBuilder;
    INVOKEVIRTUAL java/lang/StringBuilder.toString ()Ljava/lang/String;
    GETSTATIC java/lang/System.out : Ljava/io/PrintStream;
    SWAP
    INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/Object;)V
   L4
    LINENUMBER 10 L4
    RETURN
   L5
    LOCALVARIABLE a I L1 L5 0
    LOCALVARIABLE b I L2 L5 1
    LOCALVARIABLE c I L3 L5 2
    MAXSTACK = 2
    MAXLOCALS = 3
</code></pre><p>é€šè¿‡ä¸Šé¢çš„å­—èŠ‚ç æˆ‘ä»¬ä¹Ÿå¯ä»¥æ„å¤–çš„å‘ç°ï¼Œkotlin ${} è¡¨è¾¾å¼ï¼Œå…¶å®å°±æ˜¯ StringBuilder~~</p>
<p>æˆ‘ä»¬é€è¡Œè§£æ</p>
<h4 id="l0">L0</h4>
<p><code>LINENUMBER</code>ï¼š è¡¨ç¤ºæºç ä¸­çš„è¡Œå·ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯ class æ–‡ä»¶ä¸­å­˜åœ¨çš„ï¼Œç”¨äºå›æº¯ä»£ç è¡Œå·ï¼Œæˆ‘è¿™é‡Œæ˜¯ç¬¬å…­è¡Œå¼€å§‹å†™çš„ç¬¬ä¸€è¡Œä»£ç </p>
<p><code>ICONST_1</code>ï¼š è¡¨ç¤ºå°†1 load åˆ° operand stack ä¸Š</p>
<blockquote>
<p>æ­¤æ—¶ stack[0] = 1</p>
</blockquote>
<p><code>ISTORE 0</code>ï¼š è¡¨ç¤ºå°† operand stack ä¸Šç¬¬ä¸€ä¸ªå…ƒç´  store åˆ° local variable çš„ index = 0 çš„ä½ç½®ä¸Š</p>
<blockquote>
<p>æ­¤æ—¶ï¼švalue = pop stack[0], local_variable[0] = value</p>
</blockquote>
<h4 id="l1">L1</h4>
<p>åŸºæœ¬åŒ L0, ä¸åŒçš„å°±æ˜¯ï¼š<br>
<code>ICONST_2</code>ï¼š è¡¨ç¤ºå°† 2 load åˆ° operand stack ä¸Š<br>
<code>ISTORE 1</code>ï¼š è¡¨ç¤ºå°† operand stack ä¸Šç¬¬ä¸€ä¸ªå…ƒç´  store åˆ° local variable çš„ index = 1 çš„ä½ç½®ä¸Š</p>
<h4 id="l2">L2</h4>
<p><code>ILOAD 0</code> å’Œ 1ï¼š è¡¨ç¤ºå°† local_variable çš„ index = 0 å’Œ index = 1 çš„å…ƒç´  load åˆ° operand stack ä¸­<br>
<code>IADD</code>ï¼šè¡¨ç¤ºæ‰§è¡Œæ±‚å’ŒæŒ‡ä»¤ï¼Œé‚£å…·ä½“ç»†èŠ‚åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ<br>
çœ‹å®˜æ–¹æ–‡æ¡£:</p>
<blockquote>
<p>Both value1 and value2 must be of type int. The values are popped from the operand stack. The int result is value1 + value2. The result is pushed onto the operand stack.<br>
The result is the 32 low-order bits of the true mathematical result in a sufficiently wide two&rsquo;s-complement format, represented as a value of type int. If overflow occurs, then the sign of the result may not be the same as the sign of the mathematical sum of the two values.<br>
Despite the fact that overflow may occur, execution of an iadd instruction never throws a run-time exception.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>IADD ä¼šä» operand stack ä¸­ pop ä¸¤ä¸ªå€¼ï¼Œç„¶åæ±‚å’Œï¼Œç„¶åå°†ç»“æœ push å› operand stack ä¸­</code>ã€‚è€Œæˆ‘ä»¬åˆšå¥½æ‰§è¡Œäº† ILOAD 0 å’Œ ILOAD 1ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åˆšå¥½æ˜¯å°† local variable ä¸­çš„å€¼ load åˆ° operand stack ä¸­å»ã€‚æ‰€ä»¥ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ operand stack ä¸Šå°±æ˜¯ 1 å’Œ 2ï¼Œæ±‚å’Œåå¾—åˆ° 3ï¼Œé‡æ–° push å› operand stackï¼Œæ­¤æ—¶ operand_stack[0] = 3</p>
<p>IADD åï¼Œæ‰§è¡Œäº† ISTORE 2ï¼Œè¿™æ¡å‘½ä»¤å°±æ˜¯å°† operand stack ä¸Šçš„å€¼ä¿å­˜åˆ° local variable index = 2 çš„åœ°æ–¹</p>
<blockquote>
<p>æ­¤æ—¶ï¼švalue = pop stack[0], local_variable[2] = value</p>
</blockquote>
<h4 id="l3">L3</h4>
<p><code>NEW</code>ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”æŠŠ object ref å­˜å‚¨åˆ° operand stack ä¸Š</p>
<blockquote>
<p>æ­¤æ—¶ï¼š operand_stack[0] = StringBuilderRef</p>
</blockquote>
<p><code>DUP</code>ï¼šcopy operand stack ä¸Šçš„å€¼ï¼Œå¹¶ push åˆ° operand stack ä¸Šï¼Œå¤åˆ¶äº†ä¸€ä»½ï¼Œå› ä¸ºåˆå§‹åŒ–æ–¹æ³•ä¼šæ¶ˆè€—æ‰ä¸€ä¸ª obj ref</p>
<blockquote>
<p>æ­¤æ—¶ï¼šoperand_stack[1] = copy(operan_stack[0]) = StringBuilderRef</p>
</blockquote>
<p><code>INVOKESPECIAL</code>ï¼šåˆå§‹åŒ–æ–¹æ³•çš„è°ƒç”¨ï¼Œå®ƒä¼š pop æ‰ operand stack ä¸Šçš„å€¼ï¼Œåˆšå¥½æˆ‘ä»¬çš„ operand stack ä¸Šæ˜¯ StringBuilder çš„ obj refï¼Œæ²¡æœ‰å…¶ä»–æ„å¤–çš„è¯ï¼Œæˆ‘ä»¬çš„ StringBuilder å°±åˆå§‹åŒ–æˆåŠŸäº†</p>
<blockquote>
<p>æ­¤æ—¶ï¼š pop operand_stack[1]ï¼Œoperand_stack åªå‰©ä¸‹äº† operand_stack[0]</p>
</blockquote>
<p><code>LDC</code>ï¼šä»å¸¸é‡æ± ä¸­åŠ è½½æˆ‘ä»¬çš„ hello world å­—ç¬¦ä¸²åˆ° operand stack(ä»€ä¹ˆæ˜¯å¸¸é‡æ± ï¼Ÿç ”ç©¶ä¸€ä¸‹ class file å°±çŸ¥é“äº†)</p>
<blockquote>
<p>æ­¤æ—¶ï¼š operand_stack[0] = StringBuilderRef, operand_stack[1] = &ldquo;hello world!&rdquo;</p>
</blockquote>
<p><code>INVOKEVIRTUAL</code>ï¼šè°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ StringBuilder çš„ append æ–¹æ³•ï¼Œéœ€è¦ä¸€ä¸ª obj ref å’Œ ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°å·²ç»é€šè¿‡ ldc æŒ‡ä»¤åŠ è½½åˆ° operand stack ä¸Šäº†ï¼Œobj ref æœ¬æ¥å› ä¸º DUP ä¹Ÿè¿˜åœ¨(è¿™ä¸¤ä¸ªå‚æ•°ä¸€åŒè¢«æ¶ˆè€—æ‰)ã€‚åŒæ—¶å› ä¸º append æ–¹æ³•è¿˜ä¼šè¿”å›ä¸€ä¸ª StringBuilder å¯¹è±¡ï¼Œæ‰€ä»¥è¿˜ä¼š push ä¸€ä¸ª obj ref å›æ¥</p>
<blockquote>
<p>æ­¤æ—¶ï¼špop operand_stack[1] = &ldquo;hello world!&rdquo;, operand_stack[0] = obj ref<br>
push StringBuilderRef<br>
operand_stack[0] = StringBuilderRef<br>
åŒæ—¶ï¼Œè§£é‡Šä¸‹ï¼šæ–¹æ³•å‚æ•°éœ€è¦å“ªäº›ä»æ–¹æ³•ç­¾åå¯ä»¥è·å–</p>
</blockquote>
<p><code>ILOAD 2</code>ï¼š å°† local_variable[2] push åˆ° operand stack ä¸Šã€‚ä¹‹å‰æˆ‘ä»¬å°†æ±‚å’Œçš„ç»“æœå­˜å‚¨åˆ°äº† local_variable[2] ä¸Š(å…¶å®å°±æ˜¯1+2=3)</p>
<blockquote>
<p>æ­¤æ—¶ï¼š operand_stack[0] = StringBuilderRef, operad_stack[1] = 3</p>
</blockquote>
<p><code>INVOKEVIRTUAL</code>ï¼š åŒä¹‹å‰ï¼ŒæŠŠ 3 æ‹¼äº†ä¸Šå»ï¼Œé¡ºä¾¿åˆè¿”å›äº†ä¸€ä¸ª obj ref å›æ¥</p>
<blockquote>
<p>æ­¤æ—¶ï¼š pop operand_stack[1] = 3, operand_stack[0] = obj ref<br>
push StringBuilderRef<br>
operand_stack[0] = StringBuilderRef</p>
</blockquote>
<p><code>INVOKEVIRTUAL</code>ï¼šåŒä¹‹å‰ï¼Œè°ƒç”¨çš„æ˜¯ toString æ–¹æ³•ï¼Œä¸éœ€è¦å‚æ•°ï¼Œæ¶ˆè€—æ‰ obj refï¼Œè¿”å›å€¼å† push ä¸€ä¸ª string å›æ¥</p>
<blockquote>
<p>æ­¤æ—¶ï¼š operand_stack[0] = StringRef</p>
</blockquote>
<p><code>GETSTATIC</code>:  è·å–ä¸€ä¸ªé™æ€å±æ€§ï¼Œå¹¶ push åˆ° operand stackï¼Œè¿™ä¸ªé™æ€å±æ€§å°±æ˜¯ System.out ç±»å‹æ˜¯ java/io/PrintStream</p>
<blockquote>
<p>æ­¤æ—¶ï¼š operand_stack[0] = StringRef, operand_stack[1] = PrintStreamRef</p>
</blockquote>
<p><code>SWAP</code>ï¼šäº¤æ¢æ ˆé¡¶å…ƒç´ </p>
<blockquote>
<p>ğŸ’¡æ³¨æ„ï¼ï¼ï¼ä¸ºä»€ä¹ˆéœ€è¦ swapï¼Ÿ
å› ä¸º bytecode çº¦å®šï¼Œè°ƒç”¨æŸä¸ªæ–¹æ³•å°±æ˜¯è¦ obj ref æ”¾åœ¨å‰é¢ï¼Œåé¢è·Ÿç€æ–¹æ³•ç­¾åæ‰€è¦æ±‚çš„æ–¹æ³•å‚æ•°ï¼è€Œç°åœ¨ operand_stack[0] = StringRef, operand_stack[1] = PrintStreamRef æ˜¾ç„¶ä¸å¯¹ã€‚éœ€è¦äº¤æ¢ä¸€ä¸‹ï¼Œå˜æˆï¼šoperand_stack[0] = PrintStreamRef, operand_stack[1] = StringRef</p>
</blockquote>
<p><code>INVOKEVIRTUAL</code>ï¼š è°ƒç”¨ println æ–¹æ³•</p>
<blockquote>
<p>æ³¨æ„ï¼š
å…¶å®è¿™é‡Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œæ¯”å¦‚ï¼Œæ— è®ºå€¼æ˜¯åœ¨ local variable è¿˜æ˜¯åœ¨ operand stack ä¸Šï¼Œ<code>ç©¶ç«Ÿå ç”¨å‡ ä¸ªå­—èŠ‚</code>ï¼Ÿä¹Ÿæ˜¯æ ¼å±€ type åŒºåˆ†çš„</p>
</blockquote>
<h3 id="4asm-ç®€å•äº†è§£">4.ASM ç®€å•äº†è§£</h3>
<p>é€šè¿‡ä¸Šé¢çš„ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œå…¶å®å°±æ˜¯é€šè¿‡å„ç§è¿ç®—æŒ‡ä»¤ï¼Œç„¶åé…åˆç€ operand stack å’Œ local variable ä¸Šçš„å†…å­˜ç©ºé—´ï¼Œåå¤çš„å­˜å–è€Œå·²</p>
<p>é‚£æˆ‘ä»¬ä¹Ÿä¼šæ„è¯†åˆ°ï¼Œå¦‚æœæƒ³è¦é€šè¿‡ä¿®æ”¹ class æ–‡ä»¶æ¥æ”¹å˜ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå…¶å®æ˜¯å¾ˆå±é™©çš„ï¼Œå› ä¸º operand stack å’Œ local variable åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®šäº†æ•°ç›®ï¼Œindex æœ€å¤§å€¼å·²ç»å›ºå®šï¼Œå¦‚æœæˆ‘ä»¬è´¸ç„¶æ·»åŠ ä¸€äº›å¥‡æ€ªçš„æŒ‡ä»¤ï¼Œå¯èƒ½ä¼šåœ¨ç¼–è¯‘æˆ–è€…è¿è¡ŒæœŸé—´å­˜åœ¨ä¸¥é‡é—®é¢˜</p>
<p>å¹¶ä¸”ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ class æ–‡ä»¶çš„æ–¹å¼å»ä¿®æ”¹æºç ï¼Œæ˜¯ååˆ†å¤æ‚çš„ã€‚å•å• class file format å°±ååˆ†æƒŠäººã€‚å¦‚æœä½ è§£æè¿‡ï¼Œä½ å°±ä¼šè®°å¾— constant pool å’Œ attribute info æœ‰å¤šçƒ¦äººï¼Œè€Œä¸”å†…éƒ¨å…¨æ˜¯ index çš„å¼•ç”¨ï¼Œç‰µä¸€å‘åŠ¨å…¨èº«~~</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œ<code>ASM å¸®æˆ‘ä»¬å¤„ç†äº†è¿™æ‰€æœ‰çš„ä¸€åˆ‡~~</code></p>
<p>è§£æ Class æœ‰ <code>ClassVisitor</code>ï¼Œå…·ä½“åˆ° Method åˆæœ‰ <code>MethodVisitor</code>ï¼Œå¦‚æœä½ æƒ³ä¿®æ”¹æ–¹æ³•ç»†èŠ‚ï¼Œè¿˜æœ‰ <code>AdviceAdapter</code>(è¿™ä¸ªç»å¸¸åœ¨ä»£ç æ’è£…ä¸­ä½¿ç”¨ï¼Œæ–¹æ³•å‰åå¢åŠ ä»»æ„ä»£ç ï¼Œasm å·²ç»å¸®æˆ‘ä»¬å°è£…å®Œæ¯•) å’Œ <code>LocalVariableSorter</code>(å¯ä»¥éšæ„åˆ›å»ºå±€éƒ¨å˜é‡)</p>
<p><code>ClassWriter</code> åˆä¼šå¸®åŠ©æˆ‘ä»¬é‡æ–°å›å†™æ•´ä¸ª class fileï¼ŒåŒ…æ‹¬ max local å’Œ max stack çš„è®¡ç®—</p>
<p>ç•™ç»™æˆ‘ä»¬éœ€è¦äº²è‡ªå®ç°çš„å°±æ˜¯å…·ä½“çš„ ASM æŒ‡ä»¤äº†</p>
<h3 id="5transform-ç®€å•äº†è§£">5.Transform ç®€å•äº†è§£</h3>
<p>å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¿®æ”¹ class æ–‡ä»¶å¯ä»¥ä½¿ç”¨ asm æ¥å®ç°ï¼Œé‚£ä¹ˆåœ¨ Android ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»€ä¹ˆåœ°æ–¹å¯ä»¥è®©æˆ‘ä»¬å¤„ç† class å‘¢ï¼Ÿ</p>
<p>é‚£å°±æ˜¯ Transform äº†(é«˜ç‰ˆæœ¬ API è¢«åºŸå¼ƒäº†ï¼Œè¿™é‡Œå°±æ˜¯é€‚é…çš„é—®é¢˜äº†ï¼Œä¸å¤šç‰µæ‰¯)</p>
<p>æˆ‘ä»¬å¯ä»¥ç»§æ‰¿ Pluginï¼Œç„¶åæ³¨å†Œè‡ªå·±çš„ Transformï¼Œä½¿ç”¨ ASM æ¥å®ç°å…·ä½“çš„åŠŸèƒ½</p>
<p>æœ€ç»ˆä¸Šä¼ æˆ‘ä»¬çš„ pluginï¼Œåœ¨éœ€è¦ä½¿ç”¨çš„åœ°æ–¹ apply plugin å³å¯ï¼Œè¿™å°±æ˜¯å¦ä¸€å°å—çš„çŸ¥è¯†äº†</p>
<h2 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h2>
<p>å…·ä½“å®ç°ä¸€ä¸ª Log.e(tag, msg) æ›¿æ¢ä¸º LogV2.e(biz, tag, msg)</p>
<p>å› ä¸ºè¿™é‡Œä½¿ç”¨ bytexï¼Œplugin çš„ä»£ç å®ç°ä¸Šï¼Œå›è°ƒç•¥æœ‰ä¸åŒ</p>
<h3 id="plugin-åˆ›å»º">Plugin åˆ›å»º</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="c1">// bytex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@PluginConfig</span><span class="p">(</span><span class="s2">&#34;bytex.alog_replace&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="k">class</span> <span class="nc">ALogPlugin</span> <span class="p">:</span> <span class="n">CommonPlugin</span><span class="p">&lt;</span><span class="n">ALogExtension</span><span class="p">,</span> <span class="n">ALogContext</span><span class="p">&gt;(){</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// bytex transform å›è°ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">override</span> <span class="k">fun</span> <span class="nf">transform</span><span class="p">(</span><span class="n">relativePath</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">chain</span><span class="p">:</span> <span class="n">ClassVisitorChain</span><span class="p">):</span> <span class="n">Boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="asm-å¤„ç†">ASM å¤„ç†</h3>
<p>ç›´æ¥ä» MethodVisitor çš„å…·ä½“å®ç°æ¥çœ‹</p>
<p>å› ä¸ºæˆ‘ä»¬è¦æŠŠåŸæ–¹æ³•è°ƒç”¨Log.e(tag, msg)ï¼Œæ›¿æ¢ä¸ºå¦ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ LogV2.e(biz, tag, msg)ï¼Œå¹¶ä¸”æ–¹æ³•å‚æ•°è¦å¤šä¸€ä¸ª(è€Œä¸”<code>æ–°å¢å‚æ•°é¡ºåºæ’åœ¨ç¬¬ä¸€ä½</code>)</p>
<p>ç”±ä¸Šé¢æˆ‘ä»¬åˆ†æ java æ–¹æ³•æµç¨‹å¯çŸ¥ï¼š</p>
<p>Log.e è§¦å‘è°ƒç”¨æ—¶ï¼Œå®é™…æ‰§è¡Œçš„ opcode ä¸º <code>invoke-static</code>ï¼Œæ­¤æ—¶ operand stack ä¸Šå­˜å‚¨äº† tag å’Œ msg</p>
<p>åœ¨ <code>visitMethodInsn</code> å›è°ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬åˆ° invoke-static è¿™ä¸ª opcode çš„è°ƒç”¨</p>
<p>å¦‚æœæˆ‘ä»¬æ­¤æ—¶ç›´æ¥æ›¿æ¢ Log å˜ä¸º LogV2ï¼Œæ˜¾ç„¶ä¸å¯¹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨æˆ LogV2.e(tag, msg)ï¼Œ<code>ä¸¢å¤±äº† biz å‚æ•°</code></p>
<p>å¦‚æœæˆ‘ä»¬æ›¿æ¢ Log ä¸º LogV2ï¼Œå¹¶ä¸”é€šè¿‡ ALOAD æˆ–è€… LDC æŒ‡ä»¤ï¼Œå°† biz å‚æ•°æ”¾åˆ° operand stack ä¸Šï¼Œä¹Ÿä¸å¯¹ï¼Œæœ€ç»ˆè°ƒç”¨æˆ LogV2.e(tag, msg, biz)ï¼Œ<code>biz å‚æ•°é¡ºåºä¸å¯¹</code></p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯ï¼š</p>
<ol>
<li>å°† operand stack ä¸Šçš„ tag å’Œ msg å­˜å‚¨ä¸‹æ¥</li>
<li>å°† biz tag msg æŒ‰é¡ºåºæ”¾åˆ° operand stack ä¸Š</li>
</ol>
<p>æ€ä¹ˆæŠŠ operand stack ä¸Šçš„å€¼å­˜å‚¨ä¸‹æ¥å‘¢ï¼Ÿéœ€è¦ä½¿ç”¨ STORE ç³»åˆ—æŒ‡ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œéƒ½æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥ä½¿ç”¨ ASTORE å³å¯</p>
<p>å…¶æ¬¡ï¼ŒASTORE è¡¨ç¤ºå°† operand stack ä¸Šçš„å€¼å­˜å‚¨åˆ° local variable ä¸­ï¼Œlocal variable æˆ‘ä»¬åœ¨ä¹‹å‰çŸ¥é“å¤§å°æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±• local variable</p>
<p>å¥½åœ¨ <code>LocalVariableSorter</code> å¯ä»¥å¸®æˆ‘ä»¬å¤„ç†å¥½è¿™äº›äº‹æƒ…ï¼Œé€šè¿‡ <code>newLocal</code> æ–¹æ³•å³å¯ï¼Œè¿”å›å€¼å°±æ˜¯å¯¹åº” local varaible ä¸Šçš„æ§½ä½</p>
<p>é‚£æˆ‘ä»¬çš„æµç¨‹å°±å˜ä¸ºï¼š</p>
<ol>
<li>newLocal åˆ›å»ºå­˜å‚¨ tag å’Œ msg éœ€è¦çš„ç©ºé—´</li>
<li>ASTORE åˆ°å¯¹åº”çš„ local variable çš„æ§½ä½ä¸Š</li>
<li>LDC åŠ è½½ biz å‚æ•°(å¦‚æœæ˜¯å¸¸é‡ï¼Œå¦åˆ™éœ€è¦å…¶ä»–æ–¹å¼) åˆ° operand stack ä¸Š</li>
<li>ALOAD æŠŠä¹‹å‰å­˜å‚¨çš„ tag å’Œ msgï¼ŒæŒ‰éœ€è¦çš„é¡ºåºåŠ è½½åˆ° operand stack ä¸Š</li>
<li>è°ƒç”¨ LogV2.e</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ALogMethodVisitor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">access</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span></span><span class="line"><span class="cl">    <span class="n">mv</span><span class="p">:</span> <span class="n">MethodVisitor</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">:</span> <span class="n">LocalVariablesSorter</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">mv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitMethodInsn</span><span class="p">(</span><span class="n">opcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span> <span class="n">isInterface</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">isLoge</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ‹¿åˆ° method å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">val</span> <span class="py">methodParamTypes</span> <span class="p">=</span> <span class="nc">Type</span><span class="p">.</span><span class="n">getArgumentTypes</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// local variable slot æ§½ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">val</span> <span class="py">slotList</span> <span class="p">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">methodParamTypes</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="m">0</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">methodParamTypes</span><span class="p">.</span><span class="n">reversed</span><span class="p">().</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">type</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// åˆ›å»ºæœ¬åœ°å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">val</span> <span class="py">slotIndex</span> <span class="p">=</span> <span class="n">newLocal</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æ³¨æ„é¡ºåº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">slotList</span><span class="p">[</span><span class="n">methodParamTypes</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">slotIndex</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ä» operand stack pop åˆ° local variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">mv</span><span class="p">.</span><span class="n">visitVarInsn</span><span class="p">(</span><span class="nc">Opcodes</span><span class="p">.</span><span class="n">ASTORE</span><span class="p">,</span> <span class="n">slotIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ldc biz å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">mv</span><span class="p">.</span><span class="n">visitLdcInsn</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æŠŠ local variable ä¸Šçš„å˜é‡é‡æ–° load åˆ° operand stack ä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">methodParamTypes</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">type</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="n">mv</span><span class="p">.</span><span class="n">visitVarInsn</span><span class="p">(</span><span class="nc">Opcodes</span><span class="p">.</span><span class="n">ALOAD</span><span class="p">,</span> <span class="n">slotList</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LogV2.e ä¾ç„¶æ˜¯é™æ€æ–¹æ³•ï¼Œæ–¹æ³•åä¸å˜ï¼Œä½†æ˜¯æ–¹æ³•å‚æ•°æ”¹å˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰€ä»¥ï¼Œéœ€è¦ç”¨ä¿®æ”¹ owner å’Œ descriptor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œä¿®æ”¹ methodParamTypes å¢åŠ ä¸€ä¸ª String ç±»å‹å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">val</span> <span class="py">newDescriptor</span> <span class="p">=</span>  <span class="n">addStringParam</span><span class="p">(</span><span class="n">methodParamTypes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è°ƒç”¨ LogV2.e
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">mv</span><span class="p">.</span><span class="n">visitMethodInsn</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™æ€æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nc">Opcodes</span><span class="p">.</span><span class="n">INVOKESTATIC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">newOwner</span><span class="p">,</span> <span class="c1">// LogV2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">newDescriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">isInterface</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">super</span><span class="p">.</span><span class="n">visitMethodInsn</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">isInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä¹‹å‰é»˜é»˜åšè¿‡ä¸€ä¸ª <a href="https://github.com/PTrainbow/LearnJVM" target="_blank" rel="noopener noreffer">toy jvm</a>ï¼Œåœ¨å®ç° opcode çš„æ—¶å€™ï¼ŒæŠŠ LOAD å’Œ STORE ç³»åˆ—çš„æŒ‡ä»¤å®ç°äº†ï¼Œåªè®°å¾—æœ‰è¿™äº›ä¸ªæŒ‡ä»¤ï¼Œéœ€è¦åœ¨ local variable slot å’Œ operand stack ä¸Šåå¤ç§»åŠ¨</p>
<p>å¦‚ä»Šï¼Œé€šè¿‡ ASM åˆè¿›è¡Œäº†åŠ æ·±ç†è§£</p>
<p>å…¶å®ï¼Œåœ¨å®ç° LOAD å’Œ STORE æŒ‡ä»¤çš„æ—¶å€™ï¼Œè¿˜æœ‰ç±»å‹åŒºåˆ†ï¼Œæ¯”å¦‚ LONG éœ€è¦ä¸¤ä¸ªå­—èŠ‚ã€‚å†æ¯”å¦‚ï¼ŒGOTO æŒ‡ä»¤çš„å®ç° offset è·³è½¬ç­‰ç­‰</p>
<p>å¸Œæœ›æ¬¡ç¯‡æ–‡ç« å¯¹äºåˆæ¬¡ä½¿ç”¨ asm çš„ç¨‹åºçŒ¿æœ‰æ‰€å¸®åŠ©</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2024-07-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/Java/">Java</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/LearnJVM-%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8F%91%E7%8E%B0/" class="prev" rel="prev" title="LearnJVM æœ‰è¶£çš„å‘ç°"><i class="fas fa-angle-left fa-fw"></i>LearnJVM æœ‰è¶£çš„å‘ç°</a>
            <a href="/posts/2024%E6%8F%90%E5%89%8D%E6%80%BB%E7%BB%93/" class="next" rel="next" title="2024æå‰æ€»ç»“">2024æå‰æ€»ç»“<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.139.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrainbow"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2024-07-21T00:00:00Z","owner":"PTrainbow","repo":"PTrainbow.github.io","title":"ASM å’Œ JVM å…³è”çŸ¥è¯†"}},"data":{"id-1":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog","id-2":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
