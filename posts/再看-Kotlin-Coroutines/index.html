<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>å†çœ‹ Kotlin Coroutines - åŒ—é‚™å±±ä¹‹å…‰çš„ Blog</title><meta name="Description" content=""><meta property="og:title" content="å†çœ‹ Kotlin Coroutines" />
<meta property="og:description" content="å‰è¨€ https://www.youtube.com/watch?v=Mj5P47F6nJg è¿™ä¸ªæ¼”è®²å¤ªæ£’äº†ï¼Œæ¼”è®²äººæ˜¯ Roman Elizarov - Project Lead for the Kotlin Programming Language æŒ‰ç…§ä»–çš„ PPT æˆ‘è‡ªå·±æ€»ç»“äº†ä¸€ä¸‹ Kotlin Coroutines Design Story é¦–å…ˆ kotlin çš„åç¨‹åº“ = çº¿ç¨‹æ±  &#43; ä»»åŠ¡è°ƒåº¦ï¼Œä½†æ˜¯è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹æ¯”è¾ƒå¤" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://PTrain666.github.io/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/" /><meta property="og:image" content="http://PTrain666.github.io/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-05-30T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://PTrain666.github.io/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png"/>
<meta name="twitter:title" content="å†çœ‹ Kotlin Coroutines"/>
<meta name="twitter:description" content="å‰è¨€ https://www.youtube.com/watch?v=Mj5P47F6nJg è¿™ä¸ªæ¼”è®²å¤ªæ£’äº†ï¼Œæ¼”è®²äººæ˜¯ Roman Elizarov - Project Lead for the Kotlin Programming Language æŒ‰ç…§ä»–çš„ PPT æˆ‘è‡ªå·±æ€»ç»“äº†ä¸€ä¸‹ Kotlin Coroutines Design Story é¦–å…ˆ kotlin çš„åç¨‹åº“ = çº¿ç¨‹æ±  &#43; ä»»åŠ¡è°ƒåº¦ï¼Œä½†æ˜¯è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹æ¯”è¾ƒå¤"/>
<meta name="application-name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
<meta name="apple-mobile-web-app-title" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrain666.github.io/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/" /><link rel="prev" href="http://PTrain666.github.io/posts/%E5%A5%BD%E7%8E%A9%E7%9A%84-Kotlin/" /><link rel="next" href="http://PTrain666.github.io/posts/%E5%85%AD%E4%B8%83%E6%9C%88%E4%BB%BD/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "å†çœ‹ Kotlin Coroutines",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrain666.github.io\/posts\/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/PTrain666.github.io\/posts\/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines\/coroutines_cover.png",
                            "width":  800 ,
                            "height":  320 
                        }],"genre": "posts","keywords": "Android","wordcount":  3089 ,
        "url": "http:\/\/PTrain666.github.io\/posts\/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines\/","datePublished": "2021-05-30T00:00:00+00:00","dateModified": "2021-05-30T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "åŒ—é‚™å±±ä¹‹å…‰"},"author": {
                "@type": "Person",
                "name": "åŒ—é‚™å±±ä¹‹å…‰"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">å†çœ‹ Kotlin Coroutines</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>åŒ—é‚™å±±ä¹‹å…‰</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-05-30">2021-05-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 3089 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 7 åˆ†é’Ÿ&nbsp;
            </div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png"
        data-srcset="/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png, /posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png 1.5x, /posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png 2x"
        data-sizes="auto"
        alt="/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png"
        title="/posts/%E5%86%8D%E7%9C%8B-Kotlin-Coroutines/coroutines_cover.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#å‰è¨€">å‰è¨€</a></li>
    <li><a href="#kotlin-coroutines-design-story">Kotlin Coroutines Design Story</a>
      <ul>
        <li><a href="#inspired-by-asyncawait">Inspired by async/await</a></li>
        <li><a href="#kotlin-dsl">Kotlin DSL</a></li>
        <li><a href="#prototyping-librariesdsl-for-kotlin">Prototyping Libraries(dsl for kotlin)</a></li>
        <li><a href="#scope-and-context-å°æ’æ›²">Scope and Context å°æ’æ›²</a></li>
        <li><a href="#cancellation">Cancellation</a></li>
        <li><a href="#lifetime-prototype">Lifetime Prototype</a></li>
        <li><a href="#children-coroutines">Children Coroutines</a></li>
        <li><a href="#error-propagation">Error Propagation</a></li>
        <li><a href="#scope">Scope</a></li>
        <li><a href="#structured-concurrency">Structured Concurrency</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="å‰è¨€">å‰è¨€</h2>
<p><a href="https://www.youtube.com/watch?v=Mj5P47F6nJg" target="_blank" rel="noopener noreffer">https://www.youtube.com/watch?v=Mj5P47F6nJg</a></p>
<p>è¿™ä¸ªæ¼”è®²å¤ªæ£’äº†ï¼Œæ¼”è®²äººæ˜¯ Roman Elizarov - Project Lead for the Kotlin Programming Language</p>
<p>æŒ‰ç…§ä»–çš„ PPT æˆ‘è‡ªå·±æ€»ç»“äº†ä¸€ä¸‹</p>
<h2 id="kotlin-coroutines-design-story">Kotlin Coroutines Design Story</h2>
<p>é¦–å…ˆ kotlin çš„åç¨‹åº“ = çº¿ç¨‹æ±  + ä»»åŠ¡è°ƒåº¦ï¼Œä½†æ˜¯è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”æ•´ä¸ªè¿‡ç¨‹ä¹Ÿå¹¶æ²¡æœ‰ç›´æ¥æ¥ç®¡ JVM æˆ–è€… æ“ä½œç³»ç»Ÿå±‚é¢çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰ go routines çš„ç¥å¥‡çš„æŠ¢å è°ƒåº¦ã€‚
ç„¶ååªæœ‰ä¸€ä¸ªå…³é”®å­— suspend, suspend å‡½æ•°æœºåˆ¶</p>
<p><a href="https://www.youtube.com/watch?v=YrrUCSi72E8" target="_blank" rel="noopener noreffer">https://www.youtube.com/watch?v=YrrUCSi72E8</a></p>
<p>(è§†é¢‘è®²çš„å¦‚ä½• resume å›æ¥ï¼Œæ¼”è®²äººä¾ç„¶æ˜¯ Roman Elizarov)ï¼Œå¹¶ä¸”ä¸€å†å¼ºè°ƒ async/await ç­‰å…¶ä»–è¯­è¨€çš„å…³é”®å­—ï¼Œåœ¨ kotlin ä¸­åªæ˜¯ä¸€ä¸ªåŸºç¡€æ–¹æ³•ï¼Œkotlin æƒ³æ›´é€šç”¨ã€‚</p>
<h3 id="inspired-by-asyncawait">Inspired by async/await</h3>
<p>Roman Elizarov è¯´ï¼Œkotlin coroutines çš„è®¾è®¡åŸå‹å—åˆ°äº† C# çš„ async/await çš„å¯å‘</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/inspired_async.jpeg"
        data-srcset="/img/in-post/inspired_async.jpeg, /img/in-post/inspired_async.jpeg 1.5x, /img/in-post/inspired_async.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/inspired_async.jpeg"
        title="/img/in-post/inspired_async.jpeg" /></p>
<p>å¹¶åˆ—ä¸¾äº†å‡ ä¸ªå…¶ä»–è¯­è¨€çš„ä¾‹å­ï¼Œè¦ä¹ˆè¯­è¨€å¤©ç„¶æ”¯æŒ async/awaitï¼Œè¦ä¹ˆæœ‰ç›¸åº”çš„å¹¿æ³›ä½¿ç”¨çš„ lib åº“æ”¯æŒç±»ä¼¼çš„ä¸œè¥¿</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/inspired_by_other.jpeg"
        data-srcset="/img/in-post/inspired_by_other.jpeg, /img/in-post/inspired_by_other.jpeg 1.5x, /img/in-post/inspired_by_other.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/inspired_by_other.jpeg"
        title="/img/in-post/inspired_by_other.jpeg" /></p>
<h3 id="kotlin-dsl">Kotlin DSL</h3>
<p>æŒ‰ç…§å‰é¢è¯´çš„ async/await çš„åŸå‹ï¼Œkotlin coroutines å°±å¯ä»¥æ˜¯ç±»ä¼¼è¿™ç§æ ·å­(æœ€ç»ˆå½“ç„¶ä¸æ˜¯è¿™æ ·å­çš„ï¼Œä¸ºäº†å¼•å‡ºæ¥ suspend)ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">=</span> <span class="n">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">await</span><span class="p">(</span><span class="n">requestToken</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="k">val</span> <span class="py">post</span> <span class="p">=</span> <span class="n">await</span><span class="p">(</span><span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œä»–è¿˜è§£é‡Šäº†ä¸€ä¸‹ï¼Œasync åœ¨è¿™é‡Œå…¶å®å°±æ˜¯ä¸ªå‡½æ•°ï¼Œä¸è¿‡ kotlin æ”¯æŒ trailing lambdaï¼Œå‡½æ•°ä½“ç§»åŠ¨åˆ°äº†å¤–é¢</p>
<blockquote>
<p>è¿™ä¸ª Trailing Lambda çš„å­˜åœ¨ï¼Œå¯ä»¥æå‡ºä»»æ„çš„ dslï¼Œå› ä¸ºå‡½æ•°ä½“å¯ä»¥ä½œä¸ºå‚æ•°ï¼ŒåŠ ä¸Šå¯ä»¥åšä¸ºæ‰©å±•å‡½æ•°ï¼Œå¹¶ä¸”ç§»åŠ¨åˆ°äº†å¤§æ‹¬å·å å¦‚æœä½ æ˜¯ä½œè€…ï¼Œä½ ä¹Ÿå¯ä»¥ä¸å«å®ƒ async(kotlin ä¸­ç¡®å®ä¹Ÿä¸å« asnyc)
ä½†æ˜¯ï¼Œè¿™ä¸ª await æ˜¾ç„¶å¾ˆ trickï¼Œæ‰€ä»¥åœ¨ kotlin ä¸­æå‡ºäº† suspend å…³é”®å­—ï¼Œä»£ç ä¿®æ”¹æˆäº†è¿™æ ·ï¼š</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">requestToken</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="k">val</span> <span class="py">post</span> <span class="p">=</span> <span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç é™¤äº† suspend æ²¡æœ‰ä»»ä½•å¤šä½™çš„å…³é”®å­—æˆ–è€…è®©äººéš¾ç†è§£çš„åœ°æ–¹ï¼Œä»£ç å’Œæ™®é€šå‡½æ•°æ²¡æœ‰ä»»ä½•åŒºåˆ«
å¹¶ä¸”è¯´ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§èƒ†çš„è®¾è®¡ï¼Œæˆ–è€…è¯´æ˜¯ä¸ç¬¦åˆä¹ æƒ¯çš„è®¾è®¡</p>
<p>å› ä¸ºè¿™å’Œ go å¾ˆç›¸ä¼¼ï¼Œå‡½æ•°è¿˜æ˜¯å¸¸è§„å‡½æ•°ï¼Œé€šè¿‡ä¸€ä¸ª go å…³é”®å­—ï¼Œå°±å¼€å¯äº†åç¨‹(è¿˜å¥½ä»¥å‰å†™è¿‡ goï¼Œå¦‚æ­¤çœ‹æ¥ go çš„å“²å­¦è¿˜æ˜¯å¾ˆç‰›é€¼çš„å‘€)ã€‚</p>
<h3 id="prototyping-librariesdsl-for-kotlin">Prototyping Libraries(dsl for kotlin)</h3>
<p>è¿™é‡Œåˆè®²äº†ä¸€æ³¢ go çš„è®¾è®¡ï¼Œgo ç‰›é€¼ï¼(ç ´éŸ³)</p>
<p>ä»¿ç…§ go çš„å¼€å¯åç¨‹çš„æ–¹å¼ï¼Œkotlin çš„ dsl æˆä¸ºäº†è¿™æ ·ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">say</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">0.</span><span class="p">.</span><span class="m">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="c1">// è¿™é‡Œæ˜¯å› ä¸ºä¹‹å‰ä¸¾äº†ä¸ªä¾‹å­ï¼Œgo çš„åç¨‹ä¸­å¯ä»¥ sleepï¼Œä½†æ˜¯å¹¶ä¸æ˜¯çœŸçš„ Java ä¸­çš„ Thread.sleep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">mainBlocking</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">go</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">say</span><span class="p">(</span><span class="err">â€œ</span><span class="n">hello</span><span class="s2">&#34;)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å®é™…ä¸Šå‘¢ï¼Ÿä¸Šè¿°çš„ go å’Œ mainBlocking å‡½æ•°ï¼Œåœ¨ kotlin çš„å®ç°ä¸­ï¼Œå¯¹åº”äº† launch å’Œ runBlocking è¿™ä¸¤ä¸ªå‡½æ•°</p>
<p>æ‰€ä»¥ï¼Œè¿™é‡Œæ¥çœ‹ï¼Œå¾ˆå¤šä¸œè¥¿åœ¨æ¦‚å¿µä¸Šéƒ½æ˜¯åŒä¸€ä¸ªæ„ä¹‰ï¼Œåªä¸è¿‡å–äº†ä¸åŒçš„åå­—è€Œå·²</p>
<p>Roman Elizarov è¯´ï¼Œä¸ºäº†è®©åŸºç¡€åº“æ›´å¥½ï¼Œè®©å¤§å®¶ happy programming</p>
<p>kotlin å¤©ç„¶æ”¯æŒ <code>Thread-bound UI programming</code></p>
<p>ä¸¾ä¾‹è¯´ï¼Œåœ¨ Android ç»å¸¸ä¼šåšä¸€ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œç„¶åæœ€ç»ˆè¦æŠŠç»“æœç”¨äº UI æ›´æ–°ï¼Œè€Œ UI æ“ä½œåªèƒ½åœ¨ä¸»çº¿ç¨‹</p>
<p>è¿™é‡Œå°±å¼•å‡ºæ¥äº† <code>Coroutine Context</code>ï¼Œcontext ç»‘å®šäº†åç¨‹ä»»åŠ¡æ‰€éœ€è¦çš„ä»»ä½•ä¿¡æ¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š context æ¥æŒ‡å®šè¿è¡Œæ—¶çš„çº¿ç¨‹</p>
<p>çœ‹è¿‡æºç çš„è¯å°±ä¼šå‘ç°ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½ç»§æ‰¿è‡ª contextï¼Œéƒ½å¯ä»¥ä½œä¸º context çš„ elementï¼Œè¢«å­˜èµ·æ¥
Dispatchers ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¬åå­—å°±çŸ¥é“é€‚ç”¨äºè°ƒåº¦ä»»åŠ¡çš„ï¼Œé€šè¿‡ launch(Dispatchers.IO) ä¼ å…¥çš„ io dispatcher æ›¿æ¢æ‰äº† parent context ä¸­é»˜è®¤çš„ dispatcher</p>
<p>å†™äº†ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">runBlocking</span> <span class="p">{</span> <span class="c1">// éšå¼å­˜åœ¨ä¸€ä¸ª coroutineScope å¯¹è±¡(å°±ç†è§£ä¸º context) ä½œä¸º parent context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ä¼ å…¥äº† dispatcher æ›¿æ¢äº† parent ä¸­çš„ dispatcher 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;thread name = </span><span class="si">${Thread.currentThread().name}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;thread name = </span><span class="si">${Thread.currentThread().name}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;end&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åé¢åˆè¯´äº†é«˜é˜¶å‡½æ•°çš„æƒ…å†µï¼Œæ²¡å’‹å¬æ‡‚ä¹Ÿæ²¡çœ‹æ‡‚ã€‚æ„Ÿè§‰å°±è¿˜æ˜¯è¯´ CoroutineContext æ˜¯å¯ä»¥å±‚å±‚ä¼ é€’ä¸‹å»çš„ï¼Ÿ</p>
<p>è¯´åˆ°è¿™é‡Œï¼Œ<code>Coroutine Scope å’Œ Coroutine Context ä»€ä¹ˆå…³ç³»ï¼Ÿ</code></p>
<h3 id="scope-and-context-å°æ’æ›²">Scope and Context å°æ’æ›²</h3>
<p>å…¶å®æŸ¥çœ‹æºç ä½ å°±ä¼šå‘ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">interface</span> <span class="nc">CoroutineScope</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The context of this scope.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Context is encapsulated by the scope and used for implementation of coroutine builders that are extensions on the scope.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Accessing this property in general code is not recommended for any purposes except accessing the [Job] instance for advanced usages.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * By convention, should contain an instance of a [job][Job] to enforce structured concurrency.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">val</span> <span class="py">coroutineContext</span><span class="p">:</span> <span class="n">CoroutineContext</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>CoroutineScope å°±æ˜¯æŒæœ‰äº†ä¸€ä¸ª CoroutineContextï¼Œé‚£åˆ°åº•ä¸ºå•¥æœ‰ä¿©ï¼Ÿ</p>
<p>è¿™é‡Œæ˜¯ Roman Elizarov çš„æ–‡ç« </p>
<p><a href="https://elizarov.medium.com/coroutine-context-and-scope-c8b255d59055" target="_blank" rel="noopener noreffer">https://elizarov.medium.com/coroutine-context-and-scope-c8b255d59055</a></p>
<p>æ–‡ç« çš„å¼€å¤´å°±è¯´ï¼ŒåŒæ ·çš„ä¸œè¥¿åœ¨ä¸åŒçš„ç”¨é€”ä¸Šï¼Œé€šå¸¸ä¼šæœ‰ä¸åŒçš„åå­—ã€‚æ‰€ä»¥è¯´ï¼Œä»–ä»¬å¯ä»¥ç†è§£ä¸ºåŒä¸€ä¸ªä¸œè¥¿ï¼Œåªæ˜¯ä¸åŒåœºæ™¯ä¸‹çš„å«æ³•ã€‚</p>
<p>CoroutineScope æ˜¯ä¸ºäº†æŒ‡å‡ºåç¨‹å¯åŠ¨çš„ scope</p>
<p>CoroutineContext æä¾›äº†é¢å¤–çš„ã€å¯ä»¥è¦†ç›–ç»§æ‰¿è‡ª parent scope çš„å†…å®¹</p>
<p>æ¯”å¦‚ä¹‹å‰ä¸¾å¾—åˆ‡æ¢çº¿ç¨‹çš„ä¾‹å­ï¼Œé€šè¿‡ä¼ å…¥ Dispatcher(extends CoroutineContext) æ›¿æ¢äº† child scope è¿è¡Œæ—¶æ‰€å¤„çš„çº¿ç¨‹</p>
<p>æ€ä¹ˆç†è§£å‘¢ï¼Ÿ</p>
<p>å…¶å®ï¼Œæ¯å½“ä½ ä¼ å…¥ context çš„æ—¶å€™(æ¯”å¦‚ä¼ å…¥ dispatcher)ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ contextï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">actual</span> <span class="k">fun</span> <span class="nf">CoroutineScope</span><span class="p">.</span><span class="n">newCoroutineContext</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">CoroutineContext</span><span class="p">):</span> <span class="n">CoroutineContext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">combined</span> <span class="p">=</span> <span class="n">coroutineContext</span> <span class="p">+</span> <span class="n">context</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">debug</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="n">combined</span> <span class="p">+</span> <span class="n">CoroutineId</span><span class="p">(</span><span class="n">COROUTINE_ID</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">())</span> <span class="k">else</span> <span class="n">combined</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">combined</span> <span class="o">!==</span> <span class="n">Dispatchers</span><span class="p">.</span><span class="n">Default</span> <span class="o">&amp;&amp;</span> <span class="n">combined</span><span class="p">[</span><span class="n">ContinuationInterceptor</span><span class="p">]</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">debug</span> <span class="p">+</span> <span class="n">Dispatchers</span><span class="p">.</span><span class="n">Default</span> <span class="k">else</span> <span class="n">debug</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>coroutineContext + context è¿™ä¸ªå°±å¾ˆæœ‰æ„æ€ï¼Œå…¶å®æ˜¯è¿ç®—ç¬¦é‡è½½ã€‚context çš„ plus æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"> <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns a context containing elements from this context and elements from  other [context].
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The elements from this context with the same key as in the other one are dropped.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">operator</span> <span class="k">fun</span> <span class="nf">plus</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">CoroutineContext</span><span class="p">):</span> <span class="n">CoroutineContext</span> <span class="p">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">===</span> <span class="n">EmptyCoroutineContext</span><span class="p">)</span> <span class="k">this</span> <span class="k">else</span> <span class="c1">// fast path -- avoid lambda creation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">context</span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span> <span class="n">acc</span><span class="p">,</span> <span class="n">element</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">removed</span> <span class="p">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">minusKey</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">removed</span> <span class="o">===</span> <span class="n">EmptyCoroutineContext</span><span class="p">)</span> <span class="n">element</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// make sure interceptor is always last in the context (and thus is fast to get when present)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">val</span> <span class="py">interceptor</span> <span class="p">=</span> <span class="n">removed</span><span class="p">[</span><span class="n">ContinuationInterceptor</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">interceptor</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="n">CombinedContext</span><span class="p">(</span><span class="n">removed</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">val</span> <span class="py">left</span> <span class="p">=</span> <span class="n">removed</span><span class="p">.</span><span class="n">minusKey</span><span class="p">(</span><span class="n">ContinuationInterceptor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">===</span> <span class="n">EmptyCoroutineContext</span><span class="p">)</span> <span class="n">CombinedContext</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">interceptor</span><span class="p">)</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">                            <span class="n">CombinedContext</span><span class="p">(</span><span class="n">CombinedContext</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">element</span><span class="p">),</span> <span class="n">interceptor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><p>æ³¨é‡Šä¸­ä¹Ÿè¯´äº†ï¼Œå…¶å® context åƒæ˜¯ä¸€ä¸ªå¤§ Mapï¼Œä¸¤ä¸ª context çš„ç»„åˆå°±åƒæ˜¯ä¸¤ä¸ª map çš„ç»„åˆï¼Œç›¸åŒçš„ key ä¼šè¢«è¦†ç›–ï¼Œå°±æ˜¯æ–‡ä¸­çš„è¿™å¼ å›¾ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/conroutines_scope.png"
        data-srcset="/img/in-post/conroutines_scope.png, /img/in-post/conroutines_scope.png 1.5x, /img/in-post/conroutines_scope.png 2x"
        data-sizes="auto"
        alt="/img/in-post/conroutines_scope.png"
        title="/img/in-post/conroutines_scope.png" /></p>
<h3 id="cancellation">Cancellation</h3>
<p>Roman Elizarov åˆä»‹ç»äº†ä¸€äº›å…³äºåç¨‹ä»»åŠ¡å–æ¶ˆçš„è®¾è®¡
è¿™é‡Œåˆæäº† goã€‚go å¯ä»¥ä¼ å…¥ channel ä½œä¸ºä¸€ä¸ª cancellation tokenï¼Œæ¥é€€å‡ºä»»åŠ¡ï¼Œä½†æ˜¯ä»–è¯´è¿™æ ·ä½ è¦è‡ªå·±è®°å¾—è‡ªå·±æ€ä¹ˆå¤„ç†çš„</p>
<p>ä»£ç å¦‚ä¸‹(ä¸ºå•¥ä¸¾äº†ä¸ªè²æ³¢é‚£åˆ‡æ•°åˆ—çš„ä¾‹å­ï¼Œæ„Ÿè§‰å’Œå¹¶å‘æ²¡å•¥å…³ç³»é¢ï¼Œä¸çŸ¥é“æœ‰ä½•æ·±æ„ï¼Œæ²¡ç†è§£)ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">func</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">quit</span> <span class="n">chan</span> <span class="n">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:=</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">case</span> <span class="n">c</span> <span class="p">&lt;-</span> <span class="n">x</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">+</span><span class="n">y</span>
</span></span><span class="line"><span class="cl">      <span class="n">case</span> <span class="p">&lt;-</span><span class="n">quit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">quit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åŒæ—¶åˆè¯´äº† go ä¹Ÿæœ‰ Contextï¼Œä½†æ˜¯åªè¦ä½ éœ€è¦åœ¨æŸä¸€çº§å­ä»»åŠ¡ä½¿ç”¨çš„è¯ï¼Œåº”è¯¥æ˜¯éœ€è¦è‡ªå·±ä¸€å±‚å±‚ä¼ é€’ä¸‹å»çš„(è¿™é‡Œ gopher æœ‰è¯è¯´ï¼Œå¬è¯´ go è¯­è¨€æœ‰ä¸€ä¸ªå“²å­¦æ˜¯ï¼Œ<code>æ˜¾å¼ä¼˜äºéšå¼</code>)ï¼Œæ‰€ä»¥å®ƒåº”è¯¥å°±æ˜¯æƒ³è¿™ä¹ˆè®¾è®¡ã€‚</p>
<p>kotlin ä¸­æ˜¯ lib åº“å¸®æˆ‘ä»¬ä¼ å…¥äº† parent scope çš„ context(å¦‚æœæœ‰)ï¼Œå¹¶ä¸”åˆå¹¶äº†è‡ªå·±çš„ contextã€‚</p>
<p>ç„¶åè¯´ï¼Œgo ç»å¸¸å¤„ç†çš„æ˜¯ä¸€æ¬¡è¯·æ±‚ï¼Œä» request åˆ° responseï¼Œè´¯ç©¿æ•´ä¸ªè¿‡ç¨‹ï¼Œæ‰€ä»¥å¼•å‡ºäº† Lifetime prototypeã€‚</p>
<h3 id="lifetime-prototype">Lifetime Prototype</h3>
<p>è¿™é‡Œä»‹ç»äº†ä¸€ä¸‹åç¨‹çš„ç”Ÿå‘½å‘¨æœŸçš„è®¾è®¡åŸå‹
å› ä¸ºä¸Šé¢è¯´çš„æ˜¯æœ‰å…³å–æ¶ˆä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œ Roman Elizarov ä¸¾äº†ä¸ªä¾‹å­</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/lifetime_prototype.jpeg"
        data-srcset="/img/in-post/lifetime_prototype.jpeg, /img/in-post/lifetime_prototype.jpeg 1.5x, /img/in-post/lifetime_prototype.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/lifetime_prototype.jpeg"
        title="/img/in-post/lifetime_prototype.jpeg" /></p>
<p>å½“ç„¶ï¼Œæœ€ç»ˆè¿™ä¸ªæ‰€è°“çš„ Lifetimeï¼Œä¹Ÿå°±æ˜¯åæ¥çš„ kotlin coroutines é‡Œé¢çš„ Job è¿™ä¸ªç±»(extends Context)ã€‚</p>
<p>launch ç­‰å‡½æ•°éƒ½å¯ä»¥è¿”å›ä¸€ä¸ª Job å¯¹è±¡ï¼Œä»è€Œå¯¹äºæ•´ä¸ªä»»åŠ¡è¿›è¡Œç®¡ç†ã€‚</p>
<h3 id="children-coroutines">Children Coroutines</h3>
<p>Roman Elizarov åˆä¸¾äº†ä¸ªå°ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">job1</span> <span class="p">=</span> <span class="n">launch</span> <span class="p">{</span> <span class="n">say</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">job2</span> <span class="p">=</span> <span class="n">launch</span> <span class="p">{</span> <span class="n">say</span><span class="p">(</span><span class="s2">&#34;world&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¸¸è§„çš„å–æ¶ˆä»»åŠ¡çš„åŠæ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="py">jobs</span> <span class="p">=</span> <span class="n">CompositeJob</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">jobs</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">job1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jobs</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">job2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jobs</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span></code></pre></div><p>ä»£ç é‡Œï¼Œä»‹ç»äº†å–æ¶ˆå¤šä¸ªä»»åŠ¡çš„ä¸€ç§åŠæ³•ï¼Œä½†æ˜¯ Roman Elizarov è§‰å¾—è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œæ— æ•…å¢åŠ äº†å¾ˆå¤šä¸ªæ¦‚å¿µã€apiã€ä»£ç é‡ç­‰ç­‰ã€‚(è¿™ä¸ªå¥½ç†Ÿæ‚‰å•Šï¼ŒRxJava CompositiDisposable)</p>
<p>kotlin coroutine çš„ context æ˜¯å¯ä»¥ä¼ é€’ä¸‹å»çš„ï¼Œcontext åŒ…å«äº†åç¨‹ä»»åŠ¡çš„æ‰€æœ‰ä¸œè¥¿ï¼Œlaunch å¯ä»¥è¿”å› Job å¯¹è±¡ï¼ŒJob ä¹Ÿæ˜¯ CoroutineContext å­ç±»</p>
<p>context ä¼ é€’ä¸‹å»åï¼Œå¯ä»¥è¯´æ˜¯åœ¨ parent context ä¸­å¯åŠ¨äº†åç¨‹ä»»åŠ¡ï¼Œè¿™å°±æœ‰äº†å…³è”æ€§ã€‚
æ‰€ä»¥ kotlin æœ‰äº†è¿™æ ·çš„è®¾è®¡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">job</span> <span class="p">=</span>  <span class="n">launch</span><span class="p">(</span><span class="n">UI</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">launch</span><span class="p">(</span><span class="n">coroutineContext</span><span class="p">)</span> <span class="p">{</span> <span class="n">say</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">launch</span><span class="p">(</span><span class="n">coroutineContext</span><span class="p">)</span> <span class="p">{</span> <span class="n">say</span><span class="p">(</span><span class="s2">&#34;world&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">job</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span></code></pre></div><p>è¿™é‡Œ job çš„å–æ¶ˆï¼Œå°±ä¼šå–æ¶ˆ UI context ä¸‹çš„ä»»åŠ¡(scope è¿™æ—¶å€™è¿˜æ²¡å‡ºç°ï¼Œè€Œä¸” scope æœ¬èº«ä¹Ÿæ˜¯ context)</p>
<h3 id="error-propagation">Error Propagation</h3>
<p>ä¸Šè¿°è¿™æ ·è®¾è®¡å¾ˆå¥½ï¼Œä½†æ˜¯è¿™æ ·é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆå¤„ç†é”™è¯¯çŠ¶å†µ?</p>
<p>æ¯”å¦‚ä¹‹å‰çš„ä»£ç ä¸­å¯åŠ¨çš„ä¸¤ä¸ªåç¨‹ä»»åŠ¡ï¼Œé‚£ä¹ˆä»–ä»¬éƒ½æœ‰å¯èƒ½ä¼šå¤±è´¥ï¼Œè€Œä¸”æ˜¯å¹¶å‘çš„ï¼Œæ‰€ä»¥å¤–å±‚çš„åç¨‹ä»»åŠ¡åªèƒ½ç­‰å¾…</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/error_propagation.jpeg"
        data-srcset="/img/in-post/error_propagation.jpeg, /img/in-post/error_propagation.jpeg 1.5x, /img/in-post/error_propagation.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/error_propagation.jpeg"
        title="/img/in-post/error_propagation.jpeg" /></p>
<p>å¹¶ä¸”ç»™å‡ºäº†ä¸€ä¸ª Job çš„ç”Ÿå‘½å‘¨æœŸ</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/job.jpeg"
        data-srcset="/img/in-post/job.jpeg, /img/in-post/job.jpeg 1.5x, /img/in-post/job.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/job.jpeg"
        title="/img/in-post/job.jpeg" /></p>
<h3 id="scope">Scope</h3>
<p>å‰é¢ä¹ŸçŸ¥é“äº†ï¼Œå¦‚æœå­˜åœ¨çˆ¶å­å…³ç³»çš„ä¸¤ä¸ªåç¨‹ä»»åŠ¡ï¼Œå­ä»»åŠ¡ä¸­å‡ºç°å¼‚å¸¸ï¼Œçˆ¶ä»»åŠ¡ä¹Ÿä¼šç»“æŸ
æ‰€ä»¥ Roman Elizarov ä¸¾äº†ä¸ªä¾‹å­</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/decomposition.jpeg"
        data-srcset="/img/in-post/decomposition.jpeg, /img/in-post/decomposition.jpeg 1.5x, /img/in-post/decomposition.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/decomposition.jpeg"
        title="/img/in-post/decomposition.jpeg" /></p>
<p>æ‰€ä»¥æƒ³è¦ sayHelloWorld å‡½æ•°è·Ÿç€ä¸€èµ·æŠ›å¼‚å¸¸ï¼ŒScope å°±å‡ºç°äº†ï¼Œé€šè¿‡åŠ ä¸€ä¸ª withScope è¿”å›äº†ä¸€ä¸ªæ–°çš„ Jobï¼Œå¦‚æœ scope ç›¸åŒï¼ŒsayHelloWorld åŒæ ·ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œçˆ¶ä»»åŠ¡ç»“æŸï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/scope_concurrency.jpeg"
        data-srcset="/img/in-post/scope_concurrency.jpeg, /img/in-post/scope_concurrency.jpeg 1.5x, /img/in-post/scope_concurrency.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/scope_concurrency.jpeg"
        title="/img/in-post/scope_concurrency.jpeg" /></p>
<p>ä½†æ˜¯è¿™æ ·çš„å†™æ³•ä¸å¥½ï¼Œverbose and error-pone å³ ä»£ç å†—é•¿ä¸”å®¹æ˜“å‡ºé”™</p>
<p>æ‰€ä»¥å‘¢ï¼Ÿæœ€ç»ˆå½¢æˆäº†ç°åœ¨åç¨‹åº“çš„å†™æ³•(å…¶å®è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º scope æ˜¯ä¸ªæŠ½è±¡å±‚çš„æ¦‚å¿µï¼Œå®ä½“å°±æ˜¯ context)</p>
<p>è€Œä¸” launch åªæ˜¯ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯ coroutineScope çš„ extension function(æ‰©å±•æ–¹æ³•)ï¼Œæ‰€ä»¥æ²¡æœ‰ scope æ— æ³•è°ƒç”¨ launch æ–¹æ³•ï¼Œä¹Ÿé¿å…äº†å®¹æ˜“å‡ºé”™çš„é—®é¢˜</p>
<p>åŒæ—¶ suspend æ–¹æ³•ï¼Œè‡ªå·±ä¼šçŸ¥é“è‡ªå·±æ‰€å¤„çš„ scope</p>
<h3 id="structured-concurrency">Structured Concurrency</h3>
<p>Roman Elizarov è¯´æå®Œäº†è¿™ä¸€å¥—ä¸œè¥¿ï¼Œåæ¥å‘ç°äº†ä¸€ç¯‡æ–‡ç« </p>
<p><a href="https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful" target="_blank" rel="noopener noreffer">https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful</a></p>
<p>è¿™å¥—ä¸œè¥¿ç§°ä¹‹ä¸º Structured Concurrency</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/structured_concurrency.jpeg"
        data-srcset="/img/in-post/structured_concurrency.jpeg, /img/in-post/structured_concurrency.jpeg 1.5x, /img/in-post/structured_concurrency.jpeg 2x"
        data-sizes="auto"
        alt="/img/in-post/structured_concurrency.jpeg"
        title="/img/in-post/structured_concurrency.jpeg" /></p>
<p>åŒæ—¶ï¼Œå¤šç§è¯­è¨€éƒ½æœ‰ç›¸åº”çš„å®ç°æˆ–è€…åŸºäºä¸€äº› lib åº“çš„å®ç°
è¿œè¿œä¸æ­¢è¿™äº›</p>
<p>kotlin coroutines è¿œè¿œä¸æ­¢è¿™äº›ï¼Œè¿˜æœ‰è®¸è®¸å¤šå¤šçš„ç»†èŠ‚ï¼Œå¹¶ä¸” scope ä¸Šç»‘äº†å¾ˆå¤šæ‰©å±•å‡½æ•°ï¼Œæ¯”å¦‚ async ç­‰ç­‰</p>
<p>è€Œä¸”ï¼Œå…¶å®æˆ‘è‡ªå·±ä¹Ÿæ²¡å®é™…å·¥ç¨‹ä½¿ç”¨è¿‡ kotlin coroutinesï¼Œåªæ˜¯å†™äº†å‡ ä¸ª hello world ğŸ˜†</p>
<p>ä¹Ÿè®¸å¯èƒ½ä¼šæœ‰ä¸€äº›ç†è§£åå·®ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ã€‚å› ä¸ºæ¡†æ¶åœ¨è„‘æµ·é‡Œï¼Œå¦‚æœå®é™…ä½¿ç”¨æ—¶å‘ç°ç»“æœå’Œé¢„æƒ³ä¸ä¸€è‡´ï¼Œå†å»æ¨æ•²ï¼Œåè€Œå—ç›Šæ›´å¤š</p>
<p>çœ‹å®Œè¿™ä¸ªæ¼”è®²ï¼Œæ„Ÿè§‰è‡ªå·±åŸºç¡€ä¸æ˜¯å¾ˆæ‰å®ï¼Œå¾ˆå¤šè¯­è¨€æ–¹é¢çš„ç†å¿µæœ‰äº›æ— æ³•ç†è§£ï¼Œä½†æ˜¯ä¼¼ä¹åˆæœ‰æ‰€ç²¾è¿›ï¼Ÿ
å¯¹äº kotlin coroutines ä»¥åæœ‰æœºä¼šçš„è¯å¤šå¤šä½¿ç”¨ï¼Œæ‰æ›´æœ‰ä½“ä¼š</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2021-05-30</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/Android/">Android</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E5%A5%BD%E7%8E%A9%E7%9A%84-Kotlin/" class="prev" rel="prev" title="å¥½ç©çš„ Kotlin"><i class="fas fa-angle-left fa-fw"></i>å¥½ç©çš„ Kotlin</a>
            <a href="/posts/%E5%85%AD%E4%B8%83%E6%9C%88%E4%BB%BD/" class="next" rel="next" title="å…­ä¸ƒæœˆä»½">å…­ä¸ƒæœˆä»½<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrain666"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2021-05-30T00:00:00Z","owner":"PTrain666","repo":"PTrain666.github.io","title":"å†çœ‹ Kotlin Coroutines"}},"data":{"id-1":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog","id-2":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
