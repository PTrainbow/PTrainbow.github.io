<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜ - åŒ—é‚™å±±ä¹‹å…‰çš„ Blog</title><meta name="Description" content=""><meta property="og:url" content="http://PTrainbow.github.io/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/">
  <meta property="og:site_name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
  <meta property="og:title" content="Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜">
  <meta property="og:description" content="å‰è¨€ Handlerã€Looperã€MessageQueue æ˜¯è€ç”Ÿå¸¸è°ˆçš„è¯é¢˜äº†ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—æ²¡ä»€ä¹ˆå¥½è®²çš„å•Šï¼Œç½‘ä¸Šæ–‡ç« ä¹Ÿä¸€å †ã€‚
è¿™é‡Œæˆ‘æœ‰å‡ ä¸ªé—®é¢˜é—®ä¸€ä¸‹ï¼Œå¦‚æœä½ éƒ½å¾ˆæ¸…æ™°ï¼Œé‚£å°±å®Œå…¨ä¸éœ€è¦çœ‹æ­¤æ–‡ã€‚">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-03-04T00:00:00+00:00">
    <meta property="article:tag" content="Android">
    <meta property="og:image" content="http://PTrainbow.github.io/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://PTrainbow.github.io/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png">
  <meta name="twitter:title" content="Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜">
  <meta name="twitter:description" content="å‰è¨€ Handlerã€Looperã€MessageQueue æ˜¯è€ç”Ÿå¸¸è°ˆçš„è¯é¢˜äº†ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—æ²¡ä»€ä¹ˆå¥½è®²çš„å•Šï¼Œç½‘ä¸Šæ–‡ç« ä¹Ÿä¸€å †ã€‚
è¿™é‡Œæˆ‘æœ‰å‡ ä¸ªé—®é¢˜é—®ä¸€ä¸‹ï¼Œå¦‚æœä½ éƒ½å¾ˆæ¸…æ™°ï¼Œé‚£å°±å®Œå…¨ä¸éœ€è¦çœ‹æ­¤æ–‡ã€‚">
<meta name="application-name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
<meta name="apple-mobile-web-app-title" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrainbow.github.io/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/" /><link rel="prev" href="http://PTrainbow.github.io/posts/MMKV-%E5%92%8C-mmap/" /><link rel="next" href="http://PTrainbow.github.io/posts/ReferenceQueue-and-GC/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrainbow.github.io\/posts\/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/PTrainbow.github.io\/posts\/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98\/epoll.png",
                            "width":  1160 ,
                            "height":  1071 
                        }],"genre": "posts","keywords": "Android","wordcount":  2649 ,
        "url": "http:\/\/PTrainbow.github.io\/posts\/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98\/","datePublished": "2021-03-04T00:00:00+00:00","dateModified": "2021-03-04T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "åŒ—é‚™å±±ä¹‹å…‰"},"author": {
                "@type": "Person",
                "name": "åŒ—é‚™å±±ä¹‹å…‰"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a>
                <a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a>
        </div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>åŒ—é‚™å±±ä¹‹å…‰</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-03-04">2021-03-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 2649 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 6 åˆ†é’Ÿ&nbsp;
            </div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png"
        data-srcset="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png, /posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png 1.5x, /posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png 2x"
        data-sizes="auto"
        alt="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png"
        title="/posts/Handler-Looper-MQ-%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/epoll.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#å‰è¨€">å‰è¨€</a></li>
    <li><a href="#é—®é¢˜è§£æ">é—®é¢˜è§£æ</a>
      <ul>
        <li><a href="#question-1">Question 1</a></li>
        <li><a href="#question-2">Question 2</a>
          <ul>
            <li><a href="#looperquit">Looper.quit()</a></li>
            <li><a href="#queuenext-ä¸ºä»€ä¹ˆä¸ä¼šæ˜¯-null">queue.next() ä¸ºä»€ä¹ˆä¸ä¼šæ˜¯ null</a></li>
          </ul>
        </li>
        <li><a href="#question-3">Question 3</a>
          <ul>
            <li><a href="#å¦‚ä½•å”¤é†’çš„å‘¢">å¦‚ä½•å”¤é†’çš„å‘¢ï¼Ÿ</a></li>
            <li><a href="#äº‹ä»¶å¦‚ä½•æ¥">äº‹ä»¶å¦‚ä½•æ¥ï¼Ÿ</a></li>
          </ul>
        </li>
        <li><a href="#question-4--5">Question 4 &amp; 5</a></li>
        <li><a href="#question-6">Question 6</a></li>
      </ul>
    </li>
    <li><a href="#worker-pool">Worker Pool</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
    <li><a href="#å¼•ç”¨">å¼•ç”¨</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>Handlerã€Looperã€MessageQueue æ˜¯è€ç”Ÿå¸¸è°ˆçš„è¯é¢˜äº†ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—æ²¡ä»€ä¹ˆå¥½è®²çš„å•Šï¼Œç½‘ä¸Šæ–‡ç« ä¹Ÿä¸€å †ã€‚</p>
<p>è¿™é‡Œæˆ‘æœ‰å‡ ä¸ªé—®é¢˜é—®ä¸€ä¸‹ï¼Œå¦‚æœä½ éƒ½å¾ˆæ¸…æ™°ï¼Œé‚£å°±å®Œå…¨ä¸éœ€è¦çœ‹æ­¤æ–‡ã€‚</p>
<blockquote>
<p>1.å¤šä¸ª Handler å¯ä»¥å¾€åŒä¸€ä¸ª MQ é‡Œå‘æ¶ˆæ¯ä¹ˆï¼Ÿå¦‚æœå¯ä»¥ï¼Œå¤šä¸ª Handler éƒ½ä¼šå¤„ç†å¯¹åº”çš„æ¶ˆæ¯ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<blockquote>
<p>2.Looper ä¼š <code>å•çº¯</code> çš„å› ä¸ºå–ä¸åˆ°æ¶ˆæ¯è€Œå¯¼è‡´æ­»å¾ªç¯é€€å‡ºä¹ˆï¼Ÿ</p>
</blockquote>
<blockquote>
<p>3.<del>Looper æ˜¯æ­»å¾ªç¯ï¼Œä¸ºä»€ä¹ˆä¸»çº¿ç¨‹æ²¡æœ‰å¡æ­»</del>(è¿™ä¸ªçœ‹ <a href="https://www.zhihu.com/question/34652589" target="_blank" rel="noopener noreffer">https://www.zhihu.com/question/34652589</a>)</p>
</blockquote>
<blockquote>
<p>4.æ˜¯æ¥ç€é—®é¢˜2çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚çœ‹è¿‡ MQ.next() æ–¹æ³•ä¹ˆï¼Ÿçœ‹è¿‡ nativePollOnce() çš„ä»£ç ï¼Ÿå¦‚æœçœ‹è¿‡ä¼šå‘ç°è°ƒç”¨æµç¨‹æ˜¯ï¼š nativePollOnce() -&gt; pollOnce() -&gt; pollInner()ã€‚ä½†æ˜¯ pollOnce() æ˜¯ä¸ªæ­»å¾ªç¯ï¼ŒnativePollOnce() æ€ä¹ˆè·³å‡ºå»çš„ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>5.Java å±‚å’Œ Native å±‚çš„ MQã€Looper æœ‰ä»€ä¹ˆå…³ç³»å—ï¼Ÿæœ‰ä»€ä¹ˆä¼˜å…ˆçº§ä¹ˆï¼Ÿ</p>
</blockquote>
<blockquote>
<p>6.å¦‚æœä¸»çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç‚¹å‡»å±å¹•çš„æ—¶å€™åˆæ˜¯æ€ä¹ˆè¢«å”¤é†’çš„ï¼Ÿç‚¹å‡»äº‹ä»¶æ˜¯é€šè¿‡ä»€ä¹ˆæœºåˆ¶ä¼ é€’è¿‡æ¥çš„ï¼Ÿ(IMS)</p>
</blockquote>
<h2 id="é—®é¢˜è§£æ">é—®é¢˜è§£æ</h2>
<h3 id="question-1">Question 1</h3>
<p>Handler æœ‰ä¼—å¤šä¼ é€’äº‹ä»¶çš„æ–¹æ³•</p>
<p>è¯¸å¦‚ï¼š sendMessage()ã€post() ç­‰ç­‰</p>
<p>ä¸è¿‡è¿™äº›æ–¹æ³•æœ€ç»ˆéƒ½æ±‡èšäºä¸€ä¸ªæ–¹æ³• enqueueMessage()</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">enqueueMessage</span><span class="p">(</span><span class="n">MessageQueue</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">uptimeMillis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// this å°±æ˜¯ Handler å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="na">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mAsynchronous</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">setAsynchronous</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">uptimeMillis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Handler çš„æ„é€ å‡½æ•°ä¹Ÿæœ‰å¤šä¸ª</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Handler</span><span class="p">(</span><span class="n">Looper</span><span class="w"> </span><span class="n">looper</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">async</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mLooper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">looper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">looper</span><span class="p">.</span><span class="na">mQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mAsynchronous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">Handler</span><span class="p">(</span><span class="n">Callback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">async</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// çœç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mLooper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Looper</span><span class="p">.</span><span class="na">myLooper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLooper</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;Can&#39;t create handler inside thread &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; that has not called Looper.prepare()&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mLooper</span><span class="p">.</span><span class="na">mQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mAsynchronous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é€šè¿‡ä»¥ä¸Šå¯çŸ¥ï¼ŒHandler åˆå§‹åŒ–è¦ä¹ˆå½“å‰çº¿ç¨‹å·²ç»å­˜åœ¨ Looperï¼Œè¦ä¹ˆè‡ªå·±ç»‘å®šä¸€ä¸ª Looperã€‚</p>
<p>ä¸»çº¿ç¨‹çš„ Looper åœ¨ AcitivityThread.main æ–¹æ³•(App è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™)å·²ç»é€šè¿‡ Looper.prepareMainLooper() åˆ›å»ºå®Œæˆäº†ã€‚</p>
<p>é‚£ä¹ˆï¼Œå½“ç„¶æ˜¯å¯ä»¥åœ¨ä¸»çº¿ç¨‹åˆ›å»ºå¤šä¸ª Handler ç»‘å®šåˆ°åŒä¸€ä¸ª Looper(MQ ä¸ Looper ç›¸å¯¹åº”)çš„ï¼Œè¿™äº› Handler.enqueueMessage() æ–¹æ³•å‡æ˜¯å¾€åŒä¸€ä¸ª Looper æ‰€å¯¹åº”çš„åŒä¸€ä¸ª MQ é‡Œå‘é€æ¶ˆæ¯ã€‚</p>
<p>ä½†æ˜¯å¯ä»¥çœ‹åˆ° enqueueMessage() æ—¶ï¼Œæ¯ä¸€ä¸ª Message å¯¹è±¡çš„ target å±æ€§éƒ½è¢«è®¾ç½®ä¸ºäº†å‘é€æ­¤æ¶ˆæ¯çš„ Handler(è§ä¸Šæ–¹æºç )ï¼Œæ‰€ä»¥è°å‘çš„ Message è°è‡ªå·±å¤„ç†ï¼Œè¿™å½“ç„¶ä¹Ÿæ˜¯åˆæƒ…åˆç†çš„ã€‚</p>
<blockquote>
<p>ç­”ï¼š<br>
å¤šä¸ª Handler å¯ä»¥å¾€åŒä¸€ä¸ª MQ å‘æ¶ˆæ¯ï¼Œä½†æ˜¯è°å‘çš„æ¶ˆæ¯è°å¤„ç†ï¼Œå› ä¸º Message ä¿ç•™äº† Handler å¯¹è±¡çš„å¼•ç”¨ã€‚(å½“ç„¶ Looper å…¶å®ä¹Ÿæ˜¯é€šè¿‡å–å¾— Message ä¹‹åï¼Œç”¨ Message.target å›è°ƒåˆ° Handler.handleMessage() çš„)</p>
</blockquote>
<h3 id="question-2">Question 2</h3>
<p>Looper.loop() ä¼—æ‰€å‘¨çŸ¥æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä½†æ˜¯ç»†çœ‹ä»£ç ä½ ä¼šå‘ç°ä¸€äº›é—®é¢˜</p>
<p>loop() æ–¹æ³•éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w"> </span><span class="c1">// might block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// No message indicates that the message queue is quitting.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// çœç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>çœç•¥äº†å¾ˆå¤šä»£ç ï¼Œåªçœ‹è¿™ä¸ª queue.next() æ–¹æ³•ï¼Œå‘ç°åªè¦ msg == null å°± return äº†ï¼Œä¸å°±é€€å‡ºäº†ï¼Ÿä½†æ˜¯ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œåé¢è¯´åŸå› ã€‚</p>
<h4 id="looperquit">Looper.quit()</h4>
<p>å…ˆçœ‹çœ‹ quit() æ–¹æ³•ï¼Œå…¶å®å®ƒè°ƒç”¨çš„æ˜¯ MQ.quit() æ–¹æ³•ï¼Œå¯ä»¥ä¼ ä¸€ä¸ª safe å‚æ•°åˆ¤æ–­æ˜¯å¦ç®¡ç†å‰©ä½™çš„æ¶ˆæ¯ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">quit</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">safe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mQuitAllowed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Main thread not allowed to quit.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mQuitting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mQuitting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">safe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">removeAllFutureMessagesLocked</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">removeAllMessagesLocked</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// We can assume mPtr != 0 because mQuitting was previously false.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">nativeWake</span><span class="p">(</span><span class="n">mPtr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é€šè¿‡æºç ä¼šå‘ç° mQuitAllowed è¿™ä¸ªå€¼ï¼Œå¦‚æœæ˜¯ false, å°±æ˜¯ä¸è®© Looper é€€å‡ºç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸”è¿™ä¸ªå‚æ•°æ˜¯ Looper åˆå§‹åŒ–æ—¶ä¼ å…¥çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œå…¶å®å³ä½¿æˆ‘ä»¬æƒ³è¦ <code>ä¸»åŠ¨</code> è°ƒç”¨ quit() æ–¹æ³•è®© Looper é€€å‡ºï¼Œä¹Ÿè¦çœ‹åˆ›å»º Looper æ—¶çš„ <code>mQuitAllowed</code> å‚æ•°ã€‚MainLooper æ­¤å¤„å°±æ˜¯ falseï¼Œæ‰€ä»¥æ²¡æ³•è°ƒ quit æ–¹æ³•ã€‚</p>
<h4 id="queuenext-ä¸ºä»€ä¹ˆä¸ä¼šæ˜¯-null">queue.next() ä¸ºä»€ä¹ˆä¸ä¼šæ˜¯ null</h4>
<p>å…ˆçœ‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Message</span><span class="w"> </span><span class="nf">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPtr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pendingIdleHandlerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// -1 only during first iteration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nextPollTimeoutMillis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextPollTimeoutMillis</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Binder</span><span class="p">.</span><span class="na">flushPendingCommands</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">nativePollOnce</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">nextPollTimeoutMillis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// çœç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>mPtr å¦‚æœä¸º 0 è‡ªç„¶è¿”å› nullï¼Œä½†æ˜¯æ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªä¸å¯èƒ½çš„ï¼Œå› ä¸º mPtr æ˜¯ MQ åˆå§‹åŒ–æ—¶è°ƒç”¨çš„ nativeInit è¿”å›çš„ä¸€ä¸ª NativeMQ æŒ‡é’ˆã€‚</p>
<p>åé¢çš„ä»£ç å‡åŒ…å«åœ¨äº† for æ­»å¾ªç¯ä¸­ï¼Œä¸”åªä¼š return å®ä½“ messageï¼Œè€Œ nativePollOnce æœ€ç»ˆä¼šè°ƒç”¨åˆ° epoll_wait() è€Œä½¿å¾—çº¿ç¨‹è¢«æŒ‚èµ·ä¼‘çœ ï¼Œå…·ä½“æŸ¥çœ‹é—®é¢˜3ã€‚</p>
<p>æ‰€ä»¥é™¤éæœ‰ä»€ä¹ˆç³»ç»Ÿæ•…éšœï¼Œå¦åˆ™ Looper è¦ä¹ˆå› ä¸ºå–ä¸åˆ°æ¶ˆæ¯è€Œä¼‘çœ ï¼Œè¦ä¹ˆå°±è¿”å›ä¸€ä¸ªéç©ºæ¶ˆæ¯ã€‚</p>
<blockquote>
<p>ç­”ï¼š<br>
é™¤éæœ‰ç³»ç»Ÿæ•…éšœï¼Œå¦åˆ™ä¸ä¼š <code>å•çº¯</code> çš„å› ä¸ºå–ä¸åˆ°æ¶ˆæ¯è€Œå¯¼è‡´æ­»å¾ªç¯é€€å‡ºã€‚è¿™ä¹Ÿåˆæƒ…åˆç†ï¼Œä¸» Looper é€€å‡ºäº†ï¼Œåç»­çš„äº‹ä»¶åˆå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
</blockquote>
<h3 id="question-3">Question 3</h3>
<p>è¿™ä¸ªæŸ¥çœ‹çŸ¥ä¹é“¾æ¥å³å¯ã€‚</p>
<p><a href="https://www.zhihu.com/question/34652589" target="_blank" rel="noopener noreffer">https://www.zhihu.com/question/34652589</a>)</p>
<p>é¦–å…ˆæ˜¯å› ä¸º epoll_wait() çš„æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹åªæ˜¯è¢«æŒ‚èµ·ï¼Œå¹¶ä¸è€—è´¹ CPUã€‚å…¶æ¬¡ï¼Œå¦‚æœæœ‰äº‹ä»¶åˆ°æ¥ï¼Œä¹Ÿä¼šé€šè¿‡ epoll æœºåˆ¶å”¤é†’ä¸»çº¿ç¨‹ã€‚å†å…¶æ¬¡ï¼Œbinder çº¿ç¨‹æ± çš„å­˜åœ¨ä½¿å¾—å¯ä»¥ä»å…¶æ‰€åœ¨çº¿ç¨‹é€šè¿‡ Handler å‘é€æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹æˆ–è€…å…¶ä»–æ–¹å¼ï¼Œæœ€ç»ˆèƒ½å¤Ÿå”¤é†’ä¸»çº¿ç¨‹ã€‚</p>
<h4 id="å¦‚ä½•å”¤é†’çš„å‘¢">å¦‚ä½•å”¤é†’çš„å‘¢ï¼Ÿ</h4>
<p>é¦–å…ˆéœ€è¦ä¸€ä¸ª <code>æ–‡ä»¶æè¿°ç¬¦(fdï¼ŒLinux ä¸€åˆ‡çš†æ–‡ä»¶)</code> ä¸”æ”¯æŒ <code>poll</code> æ“ä½œã€‚ä¹‹åé€šè¿‡ epoll_ctl() æ³¨å†Œï¼Œepoll_wait() ç­‰å¾…äº‹ä»¶åˆ°æ¥ã€‚</p>
<h4 id="äº‹ä»¶å¦‚ä½•æ¥">äº‹ä»¶å¦‚ä½•æ¥ï¼Ÿ</h4>
<p>å¾€ fd é‡Œå†™å…¥æ•°æ®ç­‰ç­‰ï¼Œæ ¹æ® epoll_ctl æ³¨å†Œçš„æ¶ˆæ¯ç±»å‹ä¼šè¿›è¡Œç›¸åº”çš„å”¤é†’ã€‚</p>
<p>Looper å¤„ç† Java å±‚ enqueueMessage å”¤é†’æ—¶ï¼Œè€ç‰ˆæœ¬ä½¿ç”¨äº† pipeï¼Œæ–°ç‰ˆæœ¬ä½¿ç”¨äº† eventfd</p>
<h3 id="question-4--5">Question 4 &amp; 5</h3>
<p>MessageQueue.next() æ–¹æ³• Question 2 å·²ç»çœ‹è¿‡äº†ã€‚</p>
<p>ä¹‹åçš„ native è°ƒç”¨è¿‡ç¨‹æ˜¯ nativePollOnce() -&gt; pollOnce() -&gt; pollInner()</p>
<p>ä¼ªä»£ç å¤§æ¦‚å¦‚ä¸‹(æºç å¤ªé•¿è‡ªå·±å»çœ‹)ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// pollOnce
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">mResponseIndex</span> <span class="o">&lt;</span> <span class="n">mResponses</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">Response</span><span class="o">&amp;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">mResponses</span><span class="p">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">mResponseIndex</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">ident</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="n">ident</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">pollInner</span><span class="p">(</span><span class="n">timeoutMillis</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// pollInner
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">Looper</span><span class="o">::</span><span class="n">pollInner</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeoutMillis</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="nc">epoll_event</span> <span class="n">eventItems</span><span class="p">[</span><span class="n">EPOLL_MAX_EVENTS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">eventCount</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">mEpollFd</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">eventItems</span><span class="p">,</span> <span class="n">EPOLL_MAX_EVENTS</span><span class="p">,</span> <span class="n">timeoutMillis</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eventCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">eventItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pushResponse</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">mRequests</span><span class="p">.</span><span class="n">valueAt</span><span class="p">(</span><span class="n">requestIndex</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mResponses</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Response</span><span class="o">&amp;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">mResponses</span><span class="p">.</span><span class="n">editItemAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">ident</span> <span class="o">==</span> <span class="n">POLL_CALLBACK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">callbackResult</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">callback</span><span class="o">-&gt;</span><span class="n">handleEvent</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">callbackResult</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">removeFd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// çœç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€è¿›å…¥ pollOnce() å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ã€‚ä½†æ˜¯ï¼Œæ˜¯æœ‰å‡ ä¸ª return æ¡ä»¶çš„ï¼Œresult çš„å€¼é€šè¿‡ pollInner() è¿”å›ï¼ŒpollInner() æ‰çœŸæ­£è°ƒç”¨äº† epoll_wait() ä½¿å¾—çº¿ç¨‹æŒ‚èµ·ã€‚</p>
<p>å½“æœ‰äº‹ä»¶æ¥æ—¶ï¼Œæˆ‘ä»¬ä¼šé¦–å…ˆè¯»å–ç›‘å¬çš„ event äº‹ä»¶(pushResponse)ï¼Œä¹‹ååœ¨å¾ªç¯æ‰€æœ‰çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œè€Œä¸”åªè¦æœ‰å¯¹åº”çš„äº‹ä»¶å‘ç”Ÿï¼Œresult çš„è¿”å›å€¼æ€»ä¸ä¼šæ˜¯ 0ã€‚</p>
<p>result æœ‰å‡ ç§å–å€¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Result from Looper_pollOnce() and Looper_pollAll():
</span></span></span><span class="line"><span class="cl"><span class="cm">        * The poll was awoken using wake() before the timeout expired
</span></span></span><span class="line"><span class="cl"><span class="cm">        * and no callbacks were executed and no other file descriptors were ready.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="n">POLL_WAKE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Result from Looper_pollOnce() and Looper_pollAll():
</span></span></span><span class="line"><span class="cl"><span class="cm">        * One or more callbacks were executed.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="n">POLL_CALLBACK</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Result from Looper_pollOnce() and Looper_pollAll():
</span></span></span><span class="line"><span class="cl"><span class="cm">        * The timeout expired.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="n">POLL_TIMEOUT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Result from Looper_pollOnce() and Looper_pollAll():
</span></span></span><span class="line"><span class="cl"><span class="cm">        * An error occurred.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">    <span class="n">POLL_ERROR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>æ‰€ä»¥ï¼ŒpollOnce() çš„æ­»å¾ªç¯ <code>ä¸ä¼šé€€ä¸å‡ºå»</code>ï¼Œä¹Ÿä¸ä¼šå› æ­¤ä¸€ç›´å¡åœ¨ nativePollOnce() æ–¹æ³•ä¸­ã€‚å½“ pollOnce() å’Œ nativePollOnce() è¿”å›ä»¥åï¼ŒJava å±‚çš„ MQ.next() æ–¹æ³•ç»§ç»­æ‰§è¡Œï¼Œæ‰å–åˆ°äº† MQ.java ä¸­çš„ Messageï¼Œè¿›è¡Œåç»­çš„è°ƒç”¨ã€‚</p>
<blockquote>
<p>ç­”ï¼š<br>
pollOnce() ä¸ä¼šä¸€ç›´è·³ä¸å‡ºï¼Œåªè¦æœ‰äº‹ä»¶åˆ°æ¥ï¼Œéƒ½èƒ½è·³å‡ºæ­»å¾ªç¯ã€‚åŒæ—¶ï¼ŒJava å±‚å’Œ Native å±‚çš„åŒæ ·çš„ä¸€å¥—æœºåˆ¶å¯ä»¥äº’ç›¸å¼•ç”¨ï¼Œä½†æ˜¯ï¼Œæ˜¯å®Œå…¨çš„ä¸¤å¥—ä¸œè¥¿ï¼ŒåŒ…æ‹¬ MQ ä¹Ÿæ˜¯å„è‡ªç®¡ç†å„è‡ªçš„ã€‚ä½†æ˜¯ Native çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› ä¸ºå¤„ç†å®Œäº† Native çš„äº‹ä»¶ä»¥åï¼Œæ‰å¼€å§‹å¤„ç† Java å±‚çš„äº‹ä»¶ã€‚</p>
</blockquote>
<h3 id="question-6">Question 6</h3>
<p>çœ‹è¿‡ InputManagerService éƒ½çŸ¥é“ï¼Œè¾“å…¥äº‹ä»¶çš„ä¼ é€’æ˜¯ä¾èµ– socket é€šä¿¡çš„ã€‚é‚£ä¹ˆå®ƒåˆæ˜¯æ€ä¹ˆå”¤é†’ä¸»çº¿ç¨‹çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ Native å±‚çš„ Looper ä¸­æœ‰ addFd() æ–¹æ³•ï¼Œsocket åŒæ ·æ˜¯ä¸€ä¸ª fdï¼ŒLooper.addFd() é€šè¿‡ epoll_ctl æ³¨å†Œ socket ç›‘å¬ã€‚</p>
<p>å½“æœ‰è¾“å…¥äº‹ä»¶éœ€è¦ä¼ é€’æ—¶ï¼Œåªéœ€è¦å¾€ socket ä¸­å†™å…¥æ•°æ®ï¼Œå°±å¯ä»¥å”¤é†’ä¸»çº¿ç¨‹ã€‚</p>
<p>ä¾ç„¶æ˜¯ä¼šå›åˆ° pollInner() ç›¸å…³çš„ä»£ç </p>
<p><code>response.request.callback-&gt;handleEvent(fd, events, data)</code></p>
<p>è¿™é‡Œå…¶å®å·²ç»å¼€å§‹åˆ°äº†ä¸»çº¿ç¨‹ç›¸å…³çš„äº‹ä»¶åˆ†å‘éƒ¨åˆ†ï¼Œå¹¶ä¸”é€šè¿‡ Native å±‚ç›´æ¥è°ƒç”¨ Java å±‚ä»£ç çš„æ–¹å¼è°ƒäº†å›å»ï¼Œç›´åˆ° ViewRootImpl.deliverInputEvent()</p>
<p>è¯¦è§ï¼š
<a href="http://gityuan.com/2016/12/31/input-ipc/" target="_blank" rel="noopener noreffer">http://gityuan.com/2016/12/31/input-ipc/</a></p>
<blockquote>
<p>ç­”ï¼šåŒæ ·æ˜¯é€šè¿‡ epoll æœºåˆ¶å”¤é†’</p>
</blockquote>
<h2 id="worker-pool">Worker Pool</h2>
<p>å…¶å®æ— è®ºæ˜¯ Android è¿˜æ˜¯å…¶ä»–çš„äº‹ä»¶é©±åŠ¨çš„æ¨¡å‹ï¼ŒåŸç†éƒ½ç›¸ä¼¼ï¼Œä¸‹æ–‡å°±æ˜¯ä»‹ç»ä¸€ä¸ª Worker Pool çš„è®¾è®¡ã€‚</p>
<p>å…¶å®ï¼Œæˆ‘ä»¬çš„ä¸»çº¿ç¨‹å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸æ–­æ¶ˆè´¹å„ç§äº‹ä»¶ï¼Œè€Œå„ç§å…¶ä»–çš„çº¿ç¨‹(Android ä¸­ï¼Œå¦‚ InputManagerService ç­‰ç­‰ç³»ç»ŸæœåŠ¡)éƒ½å¯ä»¥çœ‹åšæ˜¯ç”Ÿäº§è€…ï¼Œä¸æ–­çš„äº§ç”Ÿäº‹ä»¶é€šçŸ¥ï¼Œäº¤ç»™ä¸»çº¿ç¨‹å¤„ç†ï¼Œä»è€Œè®©æ•´ä¸ªç¨‹åºå¾—ä»¥è¿è½¬ã€‚</p>
<p><a href="https://www.yangyang.cloud/blog/2018/11/09/worker-pool-with-eventfd/" target="_blank" rel="noopener noreffer">https://www.yangyang.cloud/blog/2018/11/09/worker-pool-with-eventfd/</a></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å…¶å®äº†è§£è¿™äº›å¯¹äºå®é™…å¼€å‘ä½œç”¨å¹¶ä¸å¤§ï¼Œè€Œä¸”æ•´ä¸ªè¿‡ç¨‹ä¾ç„¶æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰æ·±ç©¶ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¯¹äºåŸç†å’Œæ¨¡å‹çš„äº†è§£æ˜¯ååˆ†å¿…è¦çš„ï¼Œäº†è§£äº†è¿™äº›æ‰èƒ½ä¸¾ä¸€åä¸‰ã€‚</p>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<p><a href="https://www.yangyang.cloud/blog/2018/11/09/worker-pool-with-eventfd/" target="_blank" rel="noopener noreffer">https://www.yangyang.cloud/blog/2018/11/09/worker-pool-with-eventfd/</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2021-03-04</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/Android/">Android</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/MMKV-%E5%92%8C-mmap/" class="prev" rel="prev" title="MMKV å’Œ mmap"><i class="fas fa-angle-left fa-fw"></i>MMKV å’Œ mmap</a>
            <a href="/posts/ReferenceQueue-and-GC/" class="next" rel="next" title="ReferenceQueue and Rumtime.gc()">ReferenceQueue and Rumtime.gc()<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.1">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="true"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrainbow"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2021-03-04T00:00:00Z","owner":"PTrainbow","repo":"PTrainbow.github.io","title":"Handler Looper MQ çš„å‡ ä¸ªé—®é¢˜"}},"data":{"id-1":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog","id-2":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
