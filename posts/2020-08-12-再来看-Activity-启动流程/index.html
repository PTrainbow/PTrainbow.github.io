<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹ - åŒ—é‚™å±±ä¹‹å…‰çš„ Blog</title><meta name="Description" content=""><meta property="og:url" content="http://PTrainbow.github.io/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">
  <meta property="og:site_name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
  <meta property="og:title" content="å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹">
  <meta property="og:description" content="å¾ˆä¹…ä¹‹å‰çš„ä¸€ç¯‡ Activity å¯åŠ¨æµç¨‹ å½“æ—¶åˆšæ¯•ä¸šï¼Œæœ‰å¾ˆå¤šé”™è¯¯å’Œæ²¡æœ‰ç†è§£ï¼Œä»Šå¤©é‡æ–°å†™ä¸€ç¯‡æ¯”è¾ƒå®Œæ•´çš„ï¼Œæºç åŸºäº Android 9.0
1.æ¦‚è§ˆ startActivity æµç¨‹ï¼Œä¸»è¦æ¶‰åŠ APP è¿›ç¨‹å’Œ ActivityManagerService(ç®€å†™ä¸º AMSï¼Œsystem_process ä¸ºå…¶æ‰€åœ¨è¿›ç¨‹å) ä¹‹é—´çš„ IPC é€šä¿¡">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-12-07T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-12-07T00:00:00+00:00">
    <meta property="article:tag" content="Android">
    <meta property="og:image" content="http://PTrainbow.github.io/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://PTrainbow.github.io/logo.png">
  <meta name="twitter:title" content="å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹">
  <meta name="twitter:description" content="å¾ˆä¹…ä¹‹å‰çš„ä¸€ç¯‡ Activity å¯åŠ¨æµç¨‹ å½“æ—¶åˆšæ¯•ä¸šï¼Œæœ‰å¾ˆå¤šé”™è¯¯å’Œæ²¡æœ‰ç†è§£ï¼Œä»Šå¤©é‡æ–°å†™ä¸€ç¯‡æ¯”è¾ƒå®Œæ•´çš„ï¼Œæºç åŸºäº Android 9.0
1.æ¦‚è§ˆ startActivity æµç¨‹ï¼Œä¸»è¦æ¶‰åŠ APP è¿›ç¨‹å’Œ ActivityManagerService(ç®€å†™ä¸º AMSï¼Œsystem_process ä¸ºå…¶æ‰€åœ¨è¿›ç¨‹å) ä¹‹é—´çš„ IPC é€šä¿¡">
<meta name="application-name" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog">
<meta name="apple-mobile-web-app-title" content="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrainbow.github.io/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" /><link rel="prev" href="http://PTrainbow.github.io/posts/2020-07-31-ffmpeg-%E7%AE%80%E6%98%93%E6%92%AD%E6%94%BE%E5%99%A8/" /><link rel="next" href="http://PTrainbow.github.io/posts/2020-12-24-%E5%8D%8A%E5%A4%A9%E5%85%A5%E9%97%A8%E4%BA%86%E4%B8%8B-kotlin/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrainbow.github.io\/posts\/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/"
        },"genre": "posts","keywords": "Android","wordcount":  3555 ,
        "url": "http:\/\/PTrainbow.github.io\/posts\/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/","datePublished": "2020-12-07T00:00:00+00:00","dateModified": "2020-12-07T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "åŒ—é‚™å±±ä¹‹å…‰"},"author": {
                "@type": "Person",
                "name": "åŒ—é‚™å±±ä¹‹å…‰"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"><span class="header-title-pre">ğŸ’</span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢å¤±æ•ˆäº†å“ˆï¼å»ºè®®æ”¾å¼ƒ" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/PTrainbow" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a>
                <a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a>
        </div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>åŒ—é‚™å±±ä¹‹å…‰</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-12-07">2020-12-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 3555 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ&nbsp;
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1æ¦‚è§ˆ">1.æ¦‚è§ˆ</a></li>
    <li><a href="#2æµç¨‹åˆ†æ">2.æµç¨‹åˆ†æ</a>
      <ul>
        <li><a href="#21-activityastartactivity-çš„ä¸€äº›é€»è¾‘">2.1 ActivityA.startActivity çš„ä¸€äº›é€»è¾‘</a></li>
        <li><a href="#22-activityb-å³å°†å¯åŠ¨çš„å„ç§é€»è¾‘">2.2 ActivityB å³å°†å¯åŠ¨çš„å„ç§é€»è¾‘</a>
          <ul>
            <li><a href="#221-activitya-onpause-çš„æ‰§è¡Œ">2.2.1 ActivityA onPause çš„æ‰§è¡Œ</a></li>
            <li><a href="#222-startspecificactivitylocked">2.2.2 startSpecificActivityLocked</a></li>
            <li><a href="#223-realstartactivitylocked">2.2.3 realStartActivityLocked</a></li>
          </ul>
        </li>
        <li><a href="#23-activityb-çš„-oncreate-onstart-onresume">2.3 ActivityB çš„ onCreate onStart onResume</a></li>
        <li><a href="#24-activitya-çš„-onstop-ondestroy-æ–¹æ³•">2.4 ActivityA çš„ onStop onDestroy æ–¹æ³•</a>
          <ul>
            <li><a href="#241-onstop-çš„æ‰§è¡Œ">2.4.1 onStop çš„æ‰§è¡Œ</a></li>
            <li><a href="#242-ondestroy-çš„æ‰§è¡Œ">2.4.2 onDestroy çš„æ‰§è¡Œ</a></li>
          </ul>
        </li>
        <li><a href="#3å‰©ä¸‹çš„ä¸¤ä¸ªé—®é¢˜">3.å‰©ä¸‹çš„ä¸¤ä¸ªé—®é¢˜</a>
          <ul>
            <li><a href="#31-é—®é¢˜5">3.1 é—®é¢˜5</a></li>
            <li><a href="#32-é—®é¢˜4">3.2 é—®é¢˜4</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4æ€»ç»“">4.æ€»ç»“</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>å¾ˆä¹…ä¹‹å‰çš„ä¸€ç¯‡ <a href="../2017-10-26-Activity-%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b" rel="">Activity å¯åŠ¨æµç¨‹</a> å½“æ—¶åˆšæ¯•ä¸šï¼Œæœ‰å¾ˆå¤šé”™è¯¯å’Œæ²¡æœ‰ç†è§£ï¼Œä»Šå¤©é‡æ–°å†™ä¸€ç¯‡æ¯”è¾ƒå®Œæ•´çš„ï¼Œæºç åŸºäº Android 9.0</p>
<h2 id="1æ¦‚è§ˆ">1.æ¦‚è§ˆ</h2>
<p>startActivity æµç¨‹ï¼Œä¸»è¦æ¶‰åŠ APP è¿›ç¨‹å’Œ ActivityManagerService(ç®€å†™ä¸º AMSï¼Œsystem_process ä¸ºå…¶æ‰€åœ¨è¿›ç¨‹å) ä¹‹é—´çš„ IPC é€šä¿¡</p>
<p>æˆ‘ä¸€ç›´å¸¦ç€å‡ ä¸ªé—®é¢˜åœ¨çœ‹ä»£ç </p>
<blockquote>
<p>é—®é¢˜1<br>
ActivityA.startActivityBï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä¸º A.onPause -&gt; B.onCreate -&gt; B.onStart -&gt; B.onResumeï¼Œå…·ä½“æµç¨‹æ˜¯æ€æ ·çš„ï¼ŒonPause å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>é—®é¢˜2<br>
å½“æœ‰å¤šä¸ª Activity å¯ä»¥å¤„ç† Intent æ—¶ï¼Œé€‰æ‹©å¼¹çª—å¦‚ä½•å‡ºç°çš„ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>é—®é¢˜3<br>
è¿›ç¨‹ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åˆ›å»ºè¿›ç¨‹ï¼Œå¹¶ä¸”å¦‚ä½•å†æ¬¡ç»§ç»­æ‰§è¡Œ startActivity æµç¨‹çš„?</p>
</blockquote>
<blockquote>
<p>é—®é¢˜4<br>
onNewIntent ä½•æ—¶è¢«æ‰§è¡Œï¼Œå¯åŠ¨æ¨¡å¼å¦‚ä½•å¤„ç†çš„ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>é—®é¢˜5<br>
åˆ°åº•ä»€ä¹ˆæ˜¯ ActivityStackï¼Œä»€ä¹ˆæ˜¯ TaskRecordï¼Œä»€ä¹ˆåˆæ˜¯ ActivityRecordï¼Ÿ</p>
</blockquote>
<p>æç®€æ˜“ IPC æµç¨‹å›¾(çœç•¥äº† PMS å’Œ WMS ç­‰å„ç§ç›¸å…³æµç¨‹)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/startActivity.jpg"
        data-srcset="/img/in-post/startActivity.jpg, /img/in-post/startActivity.jpg 1.5x, /img/in-post/startActivity.jpg 2x"
        data-sizes="auto"
        alt="/img/in-post/startActivity.jpg"
        title="/img/in-post/startActivity.jpg" /></p>
<h2 id="2æµç¨‹åˆ†æ">2.æµç¨‹åˆ†æ</h2>
<p>ActivityA.startActivityB æµç¨‹åˆ†æ</p>
<h3 id="21-activityastartactivity-çš„ä¸€äº›é€»è¾‘">2.1 ActivityA.startActivity çš„ä¸€äº›é€»è¾‘</h3>
<p>å½“ startActivity è¢«è°ƒç”¨åï¼Œå±‚å±‚é€»è¾‘ä¼šå»è·å– AMS ä»£ç†å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œä¸€æ¬¡ IPC è°ƒç”¨ï¼Œè¿›å…¥ AMS æ‰€åœ¨è¿›ç¨‹ã€‚<br>
è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">execStartActivity</span><span class="p">:</span><span class="n">1666</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityForResult</span><span class="p">:</span><span class="n">4586</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityForResult</span><span class="p">:</span><span class="n">54</span><span class="p">,</span><span class="w"> </span><span class="n">BaseFragmentActivityApi16</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">support</span><span class="p">.</span><span class="na">v4</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityForResult</span><span class="p">:</span><span class="n">65</span><span class="p">,</span><span class="w"> </span><span class="n">FragmentActivity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">support</span><span class="p">.</span><span class="na">v4</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityForResult</span><span class="p">:</span><span class="n">4544</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityForResult</span><span class="p">:</span><span class="n">711</span><span class="p">,</span><span class="w"> </span><span class="n">FragmentActivity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">support</span><span class="p">.</span><span class="na">v4</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">4905</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">4873</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onResult</span><span class="p">:</span><span class="n">2337</span><span class="p">,</span><span class="w"> </span><span class="n">AccountManager$AmsTask$Response</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">accounts</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">IAccountManagerResponse$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">accounts</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>æ ¸å¿ƒä»£ç  Instrumentation.execStartActivity</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">startActivity</span><span class="p">(</span><span class="n">whoThread</span><span class="p">,</span><span class="w"> </span><span class="n">who</span><span class="p">.</span><span class="na">getBasePackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">who</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">()),</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="na">mEmbeddedID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æ­¤å¤„æ‰§è¡Œåœ¨ ActivityB æ‰€åœ¨è¿›ç¨‹ï¼Œæœ€åé€šè¿‡å– AMS Binder ä»£ç†å¯¹è±¡ï¼Œå®ç°è·¨è¿›ç¨‹è°ƒç”¨</p>
<h3 id="22-activityb-å³å°†å¯åŠ¨çš„å„ç§é€»è¾‘">2.2 ActivityB å³å°†å¯åŠ¨çš„å„ç§é€»è¾‘</h3>
<p>å½“ startActivity è·¨è¿›ç¨‹è°ƒç”¨åˆ°äº† AMS ä¸­åï¼ŒAMS å¤„ç†äº†å¤§é‡é€»è¾‘å¹¶ä¸”å­˜åœ¨å¤§é‡å®¹é”™å’Œå„ç§å¤æ‚æƒ…å†µï¼Œæˆ‘è‡³ä»Šæ²¡æ³•å®Œå…¨ç†è§£ä¸€äº›æ–¹æ³•çš„ä½œç”¨ï¼Œä½†æ˜¯ä¸»çº¿æ˜¯å¾ˆæ¸…æ™°çš„ã€‚</p>
<p>è¿›å…¥ AMS ä¹‹åçš„å‰åŠéƒ¨åˆ†è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯å‰åŠéƒ¨åˆ†å‘¢ï¼Ÿå› ä¸º ActivityA.onPause æ‰§è¡Œè¿˜è¦é€šè¿‡ IPC å›åˆ° APP è¿›ç¨‹ã€‚</p>
<p>å‰éƒ¨åˆ†è°ƒç”¨æ ˆ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">resumeTopActivityInnerLocked</span><span class="p">:</span><span class="n">2448</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">resumeTopActivityUncheckedLocked</span><span class="p">:</span><span class="n">2302</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">resumeFocusedStackTopActivityLocked</span><span class="p">:</span><span class="n">2229</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityUnchecked</span><span class="p">:</span><span class="n">1466</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">1200</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">868</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">544</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityMayWait</span><span class="p">:</span><span class="n">1099</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execute</span><span class="p">:</span><span class="n">486</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStarter</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityAsUser</span><span class="p">:</span><span class="n">5120</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivityAsUser</span><span class="p">:</span><span class="n">5094</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">startActivity</span><span class="p">:</span><span class="n">5085</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact$startActivity$</span><span class="p">:</span><span class="n">10084</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">122</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">3291</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>å…¶ä¸­ ActivityStarter.startActivityMayWait å¯ä»¥è§£é‡Š <code>é—®é¢˜2</code></p>
<p>å…¶å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">rInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSupervisor</span><span class="p">.</span><span class="na">resolveIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="cm">/* matchFlags */</span><span class="p">,</span><span class="w"> </span><span class="n">computeResolveFilterUid</span><span class="p">(</span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="n">mRequest</span><span class="p">.</span><span class="na">filterCallingUid</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ActivityInfo</span><span class="w"> </span><span class="n">aInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSupervisor</span><span class="p">.</span><span class="na">resolveActivity</span><span class="p">(</span><span class="n">intent</span><span class="err">ï¼Œ</span><span class="w"> </span><span class="n">rInfo</span><span class="p">,</span><span class="w"> </span><span class="n">startFlags</span><span class="p">,</span><span class="w"> </span><span class="n">profilerInfo</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>mSupervisor.resolveIntent ä¸­ä¼šè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mService</span><span class="p">.</span><span class="na">getPackageManagerInternalLocked</span><span class="p">().</span><span class="na">resolveIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">modifiedFlags</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">filterCallingUid</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œåˆæ˜¯é€šè¿‡ Binder IPC è¿›å…¥ PMS ä¸­å¤„ç† intentï¼Œdebug å‘ç° resolveIntent æ–¹æ³•å·²ç»è§£æå‡ºäº†ç¬¦åˆè¦æ±‚çš„ Activityï¼Œå¦‚æœ &gt;= 2ï¼Œé‚£ä¹ˆä¼šå˜ä¸º ResolverActivityï¼Œè¿™ä¸ª Activity ä¾¿æ˜¯é€‰æ‹©åº”ç”¨çš„å¼¹çª— Activity</p>
<p>resumeTopActivityInnerLocked æ–¹æ³•åœ¨å­˜åœ¨ resumeActivity æ—¶ä¼šè§¦å‘ onPause çš„å›è°ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥ startSpecificActivityLocked èµ°åç»­æµç¨‹</p>
<h4 id="221-activitya-onpause-çš„æ‰§è¡Œ">2.2.1 ActivityA onPause çš„æ‰§è¡Œ</h4>
<p>å‰åŠéƒ¨çš„è°ƒç”¨æ ˆæœ€åä¸€ä¸ªæ–¹æ³•å°±æ˜¯ resumeTopActivityInnerLockedï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ä¸€è¡Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mResumedActivity</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pausing</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">startPausingLocked</span><span class="p">(</span><span class="n">userLeaving</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>startPausingLocked åç»­ä¼šé€šè¿‡ Binder IPC è°ƒç”¨å›åˆ° APP è¿›ç¨‹ï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mService</span><span class="p">.</span><span class="na">getLifecycleManager</span><span class="p">().</span><span class="na">scheduleTransaction</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">thread</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">.</span><span class="na">appToken</span><span class="p">,</span><span class="w"> </span><span class="n">PauseActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="na">finishing</span><span class="p">,</span><span class="w"> </span><span class="n">userLeaving</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">.</span><span class="na">configChangeFlags</span><span class="p">,</span><span class="w"> </span><span class="n">pauseImmediately</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p>scheduleTransaction æœ€ç»ˆä¼šè¿›å…¥ ClientTransaction.scheduleTransactionï¼Œé‡Œé¢çš„ mClient å³ ApplicationThread(ApplicationThread æ˜¯è·Ÿéš APP åˆ›å»ºè€Œå‡ºç°çš„) çš„ Binder ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œè¿˜æ˜¯é€šè¿‡ Binder IPC è°ƒç”¨åˆ° APP è¿›ç¨‹ä¸­ã€‚</p>
<p>è€Œåˆ°äº† APP è¿›ç¨‹ä¸­å°±æ˜¯ ActivityThread é€šè¿‡ Handler å¤„ç†å„ç§ Messageï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° TransactionExecutor.executeï¼</p>
<p><code>è¿™é‡Œçœ‹ä»£ç æ³¨æ„ ActivityThread extends ClientTransactionHandler</code> å°±å¥½ï¼Œæ‰¾ä¸åˆ°çš„ transaction ç›¸å…³æ–¹æ³•ï¼Œéƒ½åœ¨è¿™ä¸ªçˆ¶ç±»ä¸­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">ClientTransaction</span><span class="w"> </span><span class="n">transaction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transaction</span><span class="p">.</span><span class="na">getActivityToken</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Start resolving transaction for client: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mTransactionHandler</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;, token: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">executeCallbacks</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">executeLifecycleState</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mPendingActions</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;End resolving transaction&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>execute æ–¹æ³•ä¸­çš„ executeLifecycleState æ–¹æ³•å¾ˆå…³é”®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/** Transition to the final state if requested by the transaction. */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeLifecycleState</span><span class="p">(</span><span class="n">ClientTransaction</span><span class="w"> </span><span class="n">transaction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ActivityLifecycleItem</span><span class="w"> </span><span class="n">lifecycleItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transaction</span><span class="p">.</span><span class="na">getLifecycleStateRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lifecycleItem</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// No lifecycle request, return early.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Resolving lifecycle state: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lifecycleItem</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transaction</span><span class="p">.</span><span class="na">getActivityToken</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mTransactionHandler</span><span class="p">.</span><span class="na">getActivityClient</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Ignore requests for non-existent client records for now.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Cycle to the state right before the final requested state.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cycleToPath</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">lifecycleItem</span><span class="p">.</span><span class="na">getTargetState</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* excludeLastState */</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Execute the final transition with proper parameters.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lifecycleItem</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">mTransactionHandler</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">mPendingActions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lifecycleItem</span><span class="p">.</span><span class="na">postExecute</span><span class="p">(</span><span class="n">mTransactionHandler</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">mPendingActions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>lifecycleItem.execute å’Œ postExecuteï¼ŒåŸºæœ¬å°±åŒ…å«äº† onPause éœ€è¦çš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p>
<p>çœ‹ä¸€ä¸‹ PauseActivityItem çš„ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">ClientTransactionHandler</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PendingTransactionActions</span><span class="w"> </span><span class="n">pendingActions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;activityPause&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">handlePauseActivity</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">mFinished</span><span class="p">,</span><span class="w"> </span><span class="n">mUserLeaving</span><span class="p">,</span><span class="w"> </span><span class="n">mConfigChanges</span><span class="p">,</span><span class="w"> </span><span class="n">pendingActions</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;PAUSE_ACTIVITY_ITEM&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postExecute</span><span class="p">(</span><span class="n">ClientTransactionHandler</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PendingTransactionActions</span><span class="w"> </span><span class="n">pendingActions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mDontReport</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// TODO(lifecycler): Use interface callback instead of AMS.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">activityPaused</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>execute ä¸­è°ƒç”¨äº† handlePauseActivityï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° Activity.onPause æ–¹æ³•ï¼Œè€Œ postExecute ä¸­ï¼Œåˆä¼šé€šè¿‡ Binder IPC è°ƒç”¨åˆ° AMS è¿›ç¨‹ï¼Œç»§ç»­æ‰§è¡Œ Activity å¯åŠ¨çš„åç»­æµç¨‹ã€‚</p>
<p>handlePauseActivity åˆ° Activity.onPause çš„è°ƒç”¨æ ˆå¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">onPause</span><span class="p">:</span><span class="n">1731</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onPause</span><span class="p">:</span><span class="n">395</span><span class="p">,</span><span class="w"> </span><span class="n">FragmentActivity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">support</span><span class="p">.</span><span class="na">v4</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">performPause</span><span class="p">:</span><span class="n">7329</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">callActivityOnPause</span><span class="p">:</span><span class="n">1465</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">performPauseActivityIfNeeded</span><span class="p">:</span><span class="n">4021</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityThread</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">performPauseActivity</span><span class="p">:</span><span class="n">3986</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityThread</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">handlePauseActivity</span><span class="p">:</span><span class="n">3938</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityThread</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execute</span><span class="p">:</span><span class="n">45</span><span class="p">,</span><span class="w"> </span><span class="n">PauseActivityItem</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">servertransaction</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">executeLifecycleState</span><span class="p">:</span><span class="n">145</span><span class="p">,</span><span class="w"> </span><span class="n">TransactionExecutor</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">servertransaction</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execute</span><span class="p">:</span><span class="n">70</span><span class="p">,</span><span class="w"> </span><span class="n">TransactionExecutor</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">servertransaction</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">handleMessage</span><span class="p">:</span><span class="n">1808</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityThread$H</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">dispatchMessage</span><span class="p">:</span><span class="n">106</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">loop</span><span class="p">:</span><span class="n">193</span><span class="p">,</span><span class="w"> </span><span class="n">Looper</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">main</span><span class="p">:</span><span class="n">6669</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityThread</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">invoke</span><span class="p">:</span><span class="o">-</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">run</span><span class="p">:</span><span class="n">493</span><span class="p">,</span><span class="w"> </span><span class="n">RuntimeInit$MethodAndArgsCaller</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">internal</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">main</span><span class="p">:</span><span class="n">858</span><span class="p">,</span><span class="w"> </span><span class="n">ZygoteInit</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">internal</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>å›è°ƒåˆ° AMS ä¸­çš„åç»­æµç¨‹è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">startSpecificActivityLocked</span><span class="p">:</span><span class="n">1688</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">resumeTopActivityInnerLocked</span><span class="p">:</span><span class="n">2764</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">resumeTopActivityUncheckedLocked</span><span class="p">:</span><span class="n">2302</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">resumeFocusedStackTopActivityLocked</span><span class="p">:</span><span class="n">2229</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">completePauseLocked</span><span class="p">:</span><span class="n">1606</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">activityPausedLocked</span><span class="p">:</span><span class="n">1530</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">activityPaused</span><span class="p">:</span><span class="n">8161</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">224</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">3291</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼Œæœ€ç»ˆåˆä¼šå›åˆ° startSpecificActivityLockedï¼Œè¿™ä¸ªå…³é”®çš„æ–¹æ³•</p>
<p>ä¸Šè¿°çš„ ActivityA.startActivity -&gt; AcitivtyA.onPause è§£é‡Šäº† <code>é—®é¢˜1</code></p>
<h4 id="222-startspecificactivitylocked">2.2.2 startSpecificActivityLocked</h4>
<p>æ— è®ºéœ€ä¸éœ€è¦ onPauseï¼Œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œåˆ° startSpecificActivityLockedã€‚è¿™ä¸ªæ–¹æ³•ä¸­åˆ¤æ–­äº†è¿›ç¨‹æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œåœ¨æ•´ä¸ªæµç¨‹ä¸­ï¼Œç»å¸¸æœ‰ app.thread å­—æ ·å‡ºç°ï¼Œapp.thread == ApplicationThread æ˜¯ä¸ª Binder å¯¹è±¡ã€‚å®ƒè·Ÿéšç€ APP è¿›ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºå¹¶ä¸”ä¼ é€’ç»™ AMS è¿›ç¨‹çš„ã€‚</p>
<p>startSpecificActivityLocked ç®€æ´çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">thread</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">realStartActivityLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">andResume</span><span class="p">,</span><span class="w"> </span><span class="n">checkConfig</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mService</span><span class="p">.</span><span class="na">startProcessLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;activity&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼Œå¦‚æœè¿›ç¨‹å­˜åœ¨ï¼Œåˆ™è¿›å…¥ realStartActivityLocked èµ°ä¸‹ä¸€æ­¥æµç¨‹ã€‚å¦‚æœè¿›ç¨‹ä¸å­˜åœ¨åˆ™ startProcessLockedï¼Œå¯åŠ¨ä¸€ä¸ª APP è¿›ç¨‹ã€‚</p>
<p>å¯åŠ¨è¿›ç¨‹çš„æµç¨‹å…¶å®å¾ˆå¤æ‚ï¼Œä¹ŸåŒ…æ‹¬äº† socket çš„è·¨è¿›ç¨‹è°ƒç”¨ï¼Œfork è¿›ç¨‹ï¼Œåå°„å¯åŠ¨ ActivityThread.main æ–¹æ³•ç­‰ç­‰</p>
<p>ActivityThread.main æ–¹æ³•é¦–å…ˆåˆ›å»ºäº† ActivityThread å¯¹è±¡ï¼Œä¸æ­¤åŒæ—¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span><span class="w"> </span><span class="n">ApplicationThread</span><span class="w"> </span><span class="n">mAppThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApplicationThread</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>ä½œä¸ºæˆå‘˜å˜é‡çš„ ApplicationThread ä¹Ÿä¼šè¢«åˆå§‹åŒ–ï¼Œä¹‹åè°ƒç”¨åˆ° ActivityThread.attach æ–¹æ³•ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span><span class="w"> </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mgr</span><span class="p">.</span><span class="na">attachApplication</span><span class="p">(</span><span class="n">mAppThread</span><span class="p">,</span><span class="w"> </span><span class="n">startSeq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼Œåˆé€šè¿‡ Binder IPC å›åˆ° AMS ä¸­ï¼Œè¿™å°±æ˜¯ ApplicationThread çš„æºå¤´ã€‚</p>
<p>AMS.attachApplication çš„åç»­è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">realStartActivityLocked</span><span class="p">:</span><span class="n">1393</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">attachApplicationLocked</span><span class="p">:</span><span class="n">989</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">attachApplicationLocked</span><span class="p">:</span><span class="n">7872</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">attachApplication</span><span class="p">:</span><span class="n">7940</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">198</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">3291</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>realStartActivityLocked è¿™ä¸ªæ–¹æ³•å†æ¬¡å‡ºç°ï¼Œæ‰€ä»¥ä¸€åˆ‡åˆå›åˆ°äº†å¯åŠ¨ Activity çš„æµç¨‹ä¸­ã€‚</p>
<p>è¿™é‡Œçš„æ•´ä¸ªæµç¨‹è§£é‡Šäº† <code>é—®é¢˜3</code></p>
<p>æ‰€ä»¥æ— è®ºæ˜¯å¦éœ€è¦åˆ›å»ºè¿›ç¨‹ï¼Œæˆ‘ä»¬æœ€ç»ˆéƒ½ä¼šè¿›å…¥ realStartActivityLocked æ–¹æ³•ä¸­</p>
<h4 id="223-realstartactivitylocked">2.2.3 realStartActivityLocked</h4>
<p>realStartActivityLocked æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Create activity launch transaction.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">final</span><span class="w"> </span><span class="n">ClientTransaction</span><span class="w"> </span><span class="n">clientTransaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientTransaction</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">thread</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">appToken</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">clientTransaction</span><span class="p">.</span><span class="na">addCallback</span><span class="p">(</span><span class="n">LaunchActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">info</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// TODO: Have this take the merged configuration instead of separate global</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// and override configs.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mergedConfiguration</span><span class="p">.</span><span class="na">getGlobalConfiguration</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mergedConfiguration</span><span class="p">.</span><span class="na">getOverrideConfiguration</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">compat</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">launchedFromPackage</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">voiceInteractor</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">repProcState</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">icicle</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">persistentState</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">newIntents</span><span class="p">,</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">isNextTransitionForward</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">profilerInfo</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Set desired final state.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">final</span><span class="w"> </span><span class="n">ActivityLifecycleItem</span><span class="w"> </span><span class="n">lifecycleItem</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">andResume</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lifecycleItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResumeActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">isNextTransitionForward</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lifecycleItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PauseActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">clientTransaction</span><span class="p">.</span><span class="na">setLifecycleStateRequest</span><span class="p">(</span><span class="n">lifecycleItem</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Schedule transaction.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mService</span><span class="p">.</span><span class="na">getLifecycleManager</span><span class="p">().</span><span class="na">scheduleTransaction</span><span class="p">(</span><span class="n">clientTransaction</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå’Œ 2.2.1 æ•´ä¸ªæµç¨‹å¾ˆç›¸è¿‘ï¼Œéƒ½æ˜¯é€šè¿‡ scheduleTransactionï¼Œç„¶åè¿›å…¥ APP æ‰€åœ¨è¿›ç¨‹ï¼Œé€šè¿‡ ActivityThread Handler æ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ ActivityItem æ–¹æ³•ã€‚</p>
<p>å”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ clientTransaction.addCallback(LaunchActivityItem)ï¼Œç„¶å clientTransaction.setLifecycleStateRequest(ResumeActivityItem)</p>
<p>è¿™ä¸ªä¸åŒç‚¹çš„å¤„ç†è¿‡ç¨‹çš„å…³é”®ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">preExecute</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">ClientTransactionHandler</span><span class="w"> </span><span class="n">clientTransactionHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mActivityCallbacks</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mActivityCallbacks</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mActivityCallbacks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">preExecute</span><span class="p">(</span><span class="n">clientTransactionHandler</span><span class="p">,</span><span class="w"> </span><span class="n">mActivityToken</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLifecycleStateRequest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mLifecycleStateRequest</span><span class="p">.</span><span class="na">preExecute</span><span class="p">(</span><span class="n">clientTransactionHandler</span><span class="p">,</span><span class="w"> </span><span class="n">mActivityToken</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼ŒpreExecute æ—¶å°±ä¼šå¤„ç† callback ç›¸å…³çš„ä»£ç ï¼ŒpreExecute åœ¨ ActivityThread(ClientTransactionHandler).excuteTransaction æ–¹æ³•ä¸­è¢«æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeTransaction</span><span class="p">(</span><span class="n">ClientTransaction</span><span class="w"> </span><span class="n">transaction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">transaction</span><span class="p">.</span><span class="na">preExecute</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">getTransactionExecutor</span><span class="p">().</span><span class="na">execute</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">transaction</span><span class="p">.</span><span class="na">recycle</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥æˆ‘ä»¬ä¼šå…ˆæ‰§è¡Œ LaunchActivityItem ç„¶åæ‰§è¡Œ ResumeActivityItem</p>
<h3 id="23-activityb-çš„-oncreate-onstart-onresume">2.3 ActivityB çš„ onCreate onStart onResume</h3>
<p>å‰é¢çŸ¥é“äº†ï¼Œæˆ‘ä»¬ä¼šå…ˆåæ‰§è¡Œ LaunchActivityItem å’Œ ResumeActivityItemã€‚LaunchActivityItem ä¼šè°ƒç”¨åˆ° handleLaunchActivityï¼Œä¹‹åä¼šè°ƒç”¨åˆ° Activity.onCreate æ–¹æ³•ï¼Œè¿™å…¶ä¸­æ”¯çº¿æµç¨‹å…¶å®ä¹Ÿå¾ˆå¤æ‚ï¼ŒåŒ…å«äº† Activity.attach æ–¹æ³•å’Œ WMS çš„ä¸€äº›å…³è”ã€‚</p>
<p>ResumeActivityItem ä¼šè°ƒç”¨åˆ° handleResumeActivityï¼Œä¹‹åä¼šè°ƒç”¨åˆ° onResume æ–¹æ³•ã€‚</p>
<p>onStart æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæ³¨æ„åˆ°ä¸€ä¸ªæ–¹æ³• <code>cycleToPath</code>ï¼Œåœ¨ TransactionExecutor ä¸­æ‰§è¡Œ executeLifecycleState æ—¶ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚æ­¤æ–¹æ³•æ ¹æ®ç”Ÿå‘½å‘¨æœŸçš„å€¼ï¼Œåˆ¤æ–­å½“å‰è¦æ‰§è¡Œåˆ°å“ªä¸ªç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>cycleToPath ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cycleToPath</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">finish</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">excludeLastState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getLifecycleState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Cycle from: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; to: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">finish</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; excludeLastState:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">excludeLastState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">IntArray</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHelper</span><span class="p">.</span><span class="na">getLifecyclePath</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">finish</span><span class="p">,</span><span class="w"> </span><span class="n">excludeLastState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">performLifecycleSequence</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨æ‰§è¡Œ ResumeActivityItem æ—¶ï¼Œç”Ÿå‘½å‘¨æœŸåœ¨ onCreate å’Œ onResume ä¹‹ä¸­ï¼Œä½†æ˜¯åœ¨å®šä¹‰ä¸­ï¼Œè¿˜å­˜åœ¨ onStartã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ·»åŠ  onStart å’Œ onReume ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯åˆå› ä¸ºå‚æ•°åŸå› ï¼Œåˆ æ‰äº† onResumeï¼Œæ‰€ä»¥æ­¤æ—¶åªæœ‰ onStart å³ getLifecyclePath ä¼šè¿”å› onStartã€‚ç„¶åä¼šæ‰§è¡Œ performLifecycleSequence æ–¹æ³•ï¼Œç„¶åä¼šæ‰§è¡Œåˆ° mTransactionHandler.handleStartActivity æ–¹æ³•ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° onStart æ–¹æ³•ã€‚</p>
<p>åœ¨ <code>cycleToPath</code> æ­¤æ–¹æ³•å·²ç»æ‰§è¡Œäº†ä¹‹åï¼Œæ‰ä¼šèµ°åˆ° execute æ–¹æ³•ï¼Œæ‰§è¡Œ ResumeActivityItem ç›¸å…³çš„æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡ handleResumeActivity ä¹Ÿä¼šè°ƒç”¨åˆ° onResume æ–¹æ³•ã€‚</p>
<p>æ‰€ä»¥å…¶å® AMS ä¸å…³å¿ƒ onStart è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå§</p>
<p>è‡³æ­¤é‡è¦çš„æµç¨‹åŸºæœ¬ç»“æŸäº†</p>
<p>è¿™å…¶ä¸­ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆä¸è¦åœ¨ onPause ä¸­åšè€—æ—¶çš„æ“ä½œï¼Œå› ä¸ºåä¸€ä¸ª Activity çš„å¯åŠ¨éœ€è¦ç­‰å¾…å‰ä¸€ä¸ª onPause æµç¨‹çš„ç»“æŸ</p>
<h3 id="24-activitya-çš„-onstop-ondestroy-æ–¹æ³•">2.4 ActivityA çš„ onStop onDestroy æ–¹æ³•</h3>
<h4 id="241-onstop-çš„æ‰§è¡Œ">2.4.1 onStop çš„æ‰§è¡Œ</h4>
<p>åœ¨ä¹‹å‰ ActivityThread ä¸­æ‰§è¡Œ handleResumeActivity æ—¶ï¼Œæœ‰ä¸€è¡Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Looper</span><span class="p">.</span><span class="na">myQueue</span><span class="p">().</span><span class="na">addIdleHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Idler</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Idler ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">am</span><span class="p">.</span><span class="na">activityIdle</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">createdConfig</span><span class="p">,</span><span class="w"> </span><span class="n">stopProfiling</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="na">createdConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œåˆæ˜¯ä¸€æ¬¡ Binder IPCï¼Œåç»­æµç¨‹çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">stopActivityLocked</span><span class="p">:</span><span class="n">3477</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">activityIdleInternalLocked</span><span class="p">:</span><span class="n">2092</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStackSupervisor</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">activityIdle</span><span class="p">:</span><span class="n">7952</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">216</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">3291</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>stopActivityLocked åˆä¼šæ˜¯å’Œ onCreate ç­‰ä¸€æ ·çš„æµç¨‹ï¼Œé€šè¿‡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mService</span><span class="p">.</span><span class="na">getLifecycleManager</span><span class="p">().</span><span class="na">scheduleTransaction</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">thread</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appToken</span><span class="p">,</span><span class="w"> </span><span class="n">StopActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">visible</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">configChangeFlags</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p>æ‰§è¡Œäº† onStop ç”Ÿå‘½å‘¨æœŸã€‚è¿™å…¶ä¸­è¿˜æœ‰å¾ˆå¤šé€»è¾‘ï¼Œæ¯”å¦‚è¶…æ—¶é€»è¾‘çš„å¤„ç† <code>IDLE_TIMEOUT_MSG</code></p>
<h4 id="242-ondestroy-çš„æ‰§è¡Œ">2.4.2 onDestroy çš„æ‰§è¡Œ</h4>
<p>onDestroy å’Œ onStop å…¶å®ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨ Idle æ—¶æ‰§è¡Œçš„ã€‚æ‰€ä»¥å’Œ onStop çš„æµç¨‹ä¹ŸåŸºæœ¬ä¸€è‡´ï¼Œå…¶ä¸­ä¼šæ‰§è¡Œ destroyActivityLocked æ–¹æ³•ã€‚æˆ–è€…ä¸»åŠ¨é€šè¿‡ Activity.finish è°ƒç”¨ï¼Œä½¿å¾— Activity èµ°å…¥ onDestroy æ–¹æ³•ã€‚</p>
<p>ä¸»åŠ¨ finish çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">destroyActivityLocked</span><span class="p">:</span><span class="n">4315</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">finishCurrentActivityLocked</span><span class="p">:</span><span class="n">3852</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">finishActivityLocked</span><span class="p">:</span><span class="n">3764</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">finishActivityLocked</span><span class="p">:</span><span class="n">3690</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">requestFinishActivityLocked</span><span class="p">:</span><span class="n">3530</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityStack</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">finishActivity</span><span class="p">:</span><span class="n">5708</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">147</span><span class="p">,</span><span class="w"> </span><span class="n">IActivityManager$Stub</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">app</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">onTransact</span><span class="p">:</span><span class="n">3291</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">am</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">execTransact</span><span class="p">:</span><span class="n">731</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>å…¶ä¸­ destroyActivityLocked ä¸­å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mService</span><span class="p">.</span><span class="na">getLifecycleManager</span><span class="p">().</span><span class="na">scheduleTransaction</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">thread</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appToken</span><span class="p">,</span><span class="w"> </span><span class="n">DestroyActivityItem</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">finishing</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">configChangeFlags</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p>é€šè¿‡ Binder IPC è°ƒç”¨åˆ° APP è¿›ç¨‹æ‰§è¡Œ onDestroy ç”Ÿå‘½å‘¨æœŸ</p>
<h3 id="3å‰©ä¸‹çš„ä¸¤ä¸ªé—®é¢˜">3.å‰©ä¸‹çš„ä¸¤ä¸ªé—®é¢˜</h3>
<h4 id="31-é—®é¢˜5">3.1 é—®é¢˜5</h4>
<p>é€šè¿‡é˜…è¯»ä»£ç ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼ŒActivityStack æ˜¯æœ€å¤§çš„æ¦‚å¿µï¼Œä»–æŒæœ‰å¤šä¸ª TaskRecordï¼Œæ§åˆ¶å“ªä¸ªæ˜¯å‰å°ä»»åŠ¡ç­‰ç­‰ã€‚TaskRecord æ˜¯æˆ‘ä»¬è¯´çš„ä»»åŠ¡æ ˆçš„æ¦‚å¿µï¼Œæ ˆå†…æœ‰å¾ˆå¤š Activityï¼Œè€Œ ActivityRecord æ˜¯è®°å½• Activity çš„ç»“æ„ä½“ã€‚</p>
<h4 id="32-é—®é¢˜4">3.2 é—®é¢˜4</h4>
<p>onNewIntent æºç ä½ç½®åœ¨ ActivityStarter ä¸­ deliverNewIntentï¼Œè¿™ä¸ªæ–¹æ³•æœ€åä¼šæ‰§è¡Œåˆ° onNewIntentã€‚</p>
<p>startActivityUnchecked ä¸­å¯èƒ½ä¼šè°ƒç”¨å®ƒï¼Œæ ¹æ®æ˜¯å¦æœ‰ FLAG_ACTIVITY_CLEAR_TOP æ ‡ç­¾ç­‰ç­‰ã€‚</p>
<h2 id="4æ€»ç»“">4.æ€»ç»“</h2>
<p>å…¶å®æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæµç¨‹è¿œæ¯”ä¸Šé¢çš„å¤æ‚å¤šå˜ï¼ŒåŒ…æ‹¬å„ç§æƒ…å½¢ä¸‹çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–ï¼Œå¯èƒ½å’Œæˆ‘è¿™é‡Œçš„æ™®é€šæƒ…å½¢ä¸ä¸€è‡´ï¼Œæ‰€ä»¥å¯èƒ½ä¹Ÿä¼šå¯¼è‡´ä»£ç æµç¨‹ä¸ä¸€è‡´ç­‰ç­‰ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™ä¸å½±å“å¯¹æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„è®¤è¯†ï¼å³ä½¿æµç¨‹å·²ç»å¦‚æ­¤å¤æ‚äº†ï¼Œä½†è¿™è¿˜åªæ˜¯ç”Ÿå‘½å‘¨æœŸå„ç§æƒ…å½¢ä¸‹çš„ä¸€å°éƒ¨åˆ†è€Œå·²ï¼Œå¯è§å¯åŠ¨ä¸€ä¸ª Activity å¹¶ä¸æ˜¯å¾ˆç®€å•ã€‚</p>
<p>çºµè§‚æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œéƒ½ä¼´éšç€å„ç§ Binder IPC çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ Binder ç¡®å®æ˜¯ Android çš„åŸºç¡€ä¹‹ä¸€ã€‚</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2020-12-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/Android/">Android</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2020-07-31-ffmpeg-%E7%AE%80%E6%98%93%E6%92%AD%E6%94%BE%E5%99%A8/" class="prev" rel="prev" title="FFmpeg ç®€æ˜“æ’­æ”¾å™¨"><i class="fas fa-angle-left fa-fw"></i>FFmpeg ç®€æ˜“æ’­æ”¾å™¨</a>
            <a href="/posts/2020-12-24-%E5%8D%8A%E5%A4%A9%E5%85%A5%E9%97%A8%E4%BA%86%E4%B8%8B-kotlin/" class="next" rel="next" title="åŠå¤©å…¥é—¨äº†ä¸‹ kotlin">åŠå¤©å…¥é—¨äº†ä¸‹ kotlin<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.1">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="true"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrainbow"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2020-12-07T00:00:00Z","owner":"PTrainbow","repo":"PTrainbow.github.io","title":"å†æ¥çœ‹ Activity å¯åŠ¨æµç¨‹"}},"data":{"id-1":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog","id-2":"åŒ—é‚™å±±ä¹‹å…‰çš„ Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
