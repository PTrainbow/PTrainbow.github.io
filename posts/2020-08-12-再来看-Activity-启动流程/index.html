<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>再来看 Activity 启动流程 - 北邙山之光的 Blog</title><meta name="Description" content=""><meta property="og:title" content="再来看 Activity 启动流程" />
<meta property="og:description" content="很久之前的一篇 Activity 启动流程 当时刚毕业，有很多错误和没有理解，今天重新写一篇比较完整的，源码基于 Android 9.0 1.概览 startActivity 流程，主要涉及 APP 进程和 Activi" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://PTrain666.github.io/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" /><meta property="og:image" content="http://PTrain666.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-07T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://PTrain666.github.io/logo.png"/>

<meta name="twitter:title" content="再来看 Activity 启动流程"/>
<meta name="twitter:description" content="很久之前的一篇 Activity 启动流程 当时刚毕业，有很多错误和没有理解，今天重新写一篇比较完整的，源码基于 Android 9.0 1.概览 startActivity 流程，主要涉及 APP 进程和 Activi"/>
<meta name="application-name" content="北邙山之光的 Blog">
<meta name="apple-mobile-web-app-title" content="北邙山之光的 Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrain666.github.io/posts/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" /><link rel="prev" href="http://PTrain666.github.io/posts/2020-07-31-ffmpeg-%E7%AE%80%E6%98%93%E6%92%AD%E6%94%BE%E5%99%A8/" /><link rel="next" href="http://PTrain666.github.io/posts/2020-12-24-%E5%8D%8A%E5%A4%A9%E5%85%A5%E9%97%A8%E4%BA%86%E4%B8%8B-kotlin/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "再来看 Activity 启动流程",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrain666.github.io\/posts\/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/"
        },"genre": "posts","keywords": "Android","wordcount":  3555 ,
        "url": "http:\/\/PTrain666.github.io\/posts\/2020-08-12-%E5%86%8D%E6%9D%A5%E7%9C%8B-Activity-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/","datePublished": "2020-12-07T00:00:00+00:00","dateModified": "2020-12-07T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "北邙山之光"},"author": {
                "@type": "Person",
                "name": "北邙山之光"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="北邙山之光的 Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/cv/"> 简历 </a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="北邙山之光的 Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/cv/" title="">简历</a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">再来看 Activity 启动流程</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>北邙山之光</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-12-07">2020-12-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3555 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1概览">1.概览</a></li>
    <li><a href="#2流程分析">2.流程分析</a>
      <ul>
        <li><a href="#21-activityastartactivity-的一些逻辑">2.1 ActivityA.startActivity 的一些逻辑</a></li>
        <li><a href="#22-activityb-即将启动的各种逻辑">2.2 ActivityB 即将启动的各种逻辑</a></li>
        <li><a href="#23-activityb-的-oncreate-onstart-onresume">2.3 ActivityB 的 onCreate onStart onResume</a></li>
        <li><a href="#24-activitya-的-onstop-ondestroy-方法">2.4 ActivityA 的 onStop onDestroy 方法</a></li>
        <li><a href="#3剩下的两个问题">3.剩下的两个问题</a></li>
      </ul>
    </li>
    <li><a href="#4总结">4.总结</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>很久之前的一篇 <a href="../2017-10-26-Activity-%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b" rel="">Activity 启动流程</a> 当时刚毕业，有很多错误和没有理解，今天重新写一篇比较完整的，源码基于 Android 9.0</p>
<h2 id="1概览">1.概览</h2>
<p>startActivity 流程，主要涉及 APP 进程和 ActivityManagerService(简写为 AMS，system_process 为其所在进程名) 之间的 IPC 通信</p>
<p>我一直带着几个问题在看代码</p>
<blockquote>
<p>问题1<br>
ActivityA.startActivityB，其生命周期为 A.onPause -&gt; B.onCreate -&gt; B.onStart -&gt; B.onResume，具体流程是怎样的，onPause 如何被执行的？</p>
</blockquote>
<blockquote>
<p>问题2<br>
当有多个 Activity 可以处理 Intent 时，选择弹窗如何出现的？</p>
</blockquote>
<blockquote>
<p>问题3<br>
进程不存在的情况下，如何创建进程，并且如何再次继续执行 startActivity 流程的?</p>
</blockquote>
<blockquote>
<p>问题4<br>
onNewIntent 何时被执行，启动模式如何处理的？</p>
</blockquote>
<blockquote>
<p>问题5<br>
到底什么是 ActivityStack，什么是 TaskRecord，什么又是 ActivityRecord？</p>
</blockquote>
<p>极简易 IPC 流程图(省略了 PMS 和 WMS 等各种相关流程)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/in-post/startActivity.jpg"
        data-srcset="/img/in-post/startActivity.jpg, /img/in-post/startActivity.jpg 1.5x, /img/in-post/startActivity.jpg 2x"
        data-sizes="auto"
        alt="/img/in-post/startActivity.jpg"
        title="/img/in-post/startActivity.jpg" /></p>
<h2 id="2流程分析">2.流程分析</h2>
<p>ActivityA.startActivityB 流程分析</p>
<h3 id="21-activityastartactivity-的一些逻辑">2.1 ActivityA.startActivity 的一些逻辑</h3>
<p>当 startActivity 被调用后，层层逻辑会去获取 AMS 代理对象，然后执行一次 IPC 调用，进入 AMS 所在进程。<br>
调用栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">execStartActivity:</span><span class="n">1666</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivityForResult:</span><span class="n">4586</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivityForResult:</span><span class="n">54</span><span class="o">,</span> <span class="n">BaseFragmentActivityApi16</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">v4</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivityForResult:</span><span class="n">65</span><span class="o">,</span> <span class="n">FragmentActivity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">v4</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivityForResult:</span><span class="n">4544</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivityForResult:</span><span class="n">711</span><span class="o">,</span> <span class="n">FragmentActivity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">v4</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">4905</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">4873</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onResult:</span><span class="n">2337</span><span class="o">,</span> <span class="n">AccountManager$AmsTask$Response</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">accounts</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">60</span><span class="o">,</span> <span class="n">IAccountManagerResponse$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">accounts</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>核心代码 Instrumentation.execStartActivity</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">startActivity</span><span class="o">(</span><span class="n">whoThread</span><span class="o">,</span> <span class="n">who</span><span class="o">.</span><span class="na">getBasePackageName</span><span class="o">(),</span> <span class="n">intent</span><span class="o">,</span> <span class="n">intent</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">who</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">()),</span> <span class="n">token</span><span class="o">,</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">mEmbeddedID</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</code></pre></div><p>此处执行在 ActivityB 所在进程，最后通过取 AMS Binder 代理对象，实现跨进程调用</p>
<h3 id="22-activityb-即将启动的各种逻辑">2.2 ActivityB 即将启动的各种逻辑</h3>
<p>当 startActivity 跨进程调用到了 AMS 中后，AMS 处理了大量逻辑并且存在大量容错和各种复杂情况，我至今没法完全理解一些方法的作用，但是主线是很清晰的。</p>
<p>进入 AMS 之后的前半部分调用栈如下，为什么说是前半部分呢？因为 ActivityA.onPause 执行还要通过 IPC 回到 APP 进程。</p>
<p>前部分调用栈:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">resumeTopActivityInnerLocked:</span><span class="n">2448</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span> 
<span class="nl">resumeTopActivityUncheckedLocked:</span><span class="n">2302</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">resumeFocusedStackTopActivityLocked:</span><span class="n">2229</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivityUnchecked:</span><span class="n">1466</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">1200</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">868</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">544</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivityMayWait:</span><span class="n">1099</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execute:</span><span class="n">486</span><span class="o">,</span> <span class="n">ActivityStarter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivityAsUser:</span><span class="n">5120</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivityAsUser:</span><span class="n">5094</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">startActivity:</span><span class="n">5085</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">onTransact$startActivity$:</span><span class="n">10084</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">122</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">3291</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>其中 ActivityStarter.startActivityMayWait 可以解释 <code>问题2</code></p>
<p>其关键代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ResolveInfo</span> <span class="n">rInfo</span> <span class="o">=</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">resolveIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/* matchFlags */</span><span class="o">,</span> <span class="n">computeResolveFilterUid</span><span class="o">(</span><span class="n">callingUid</span><span class="o">,</span> <span class="n">realCallingUid</span><span class="o">,</span> <span class="n">mRequest</span><span class="o">.</span><span class="na">filterCallingUid</span><span class="o">));</span>
<span class="n">ActivityInfo</span> <span class="n">aInfo</span> <span class="o">=</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">resolveActivity</span><span class="o">(</span><span class="n">intent</span><span class="err">，</span> <span class="n">rInfo</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">);</span>
</code></pre></div><p>mSupervisor.resolveIntent 中会调用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">mService</span><span class="o">.</span><span class="na">getPackageManagerInternalLocked</span><span class="o">().</span><span class="na">resolveIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">modifiedFlags</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">filterCallingUid</span><span class="o">);</span>
</code></pre></div><p>这里又是通过 Binder IPC 进入 PMS 中处理 intent，debug 发现 resolveIntent 方法已经解析出了符合要求的 Activity，如果 &gt;= 2，那么会变为 ResolverActivity，这个 Activity 便是选择应用的弹窗 Activity</p>
<p>resumeTopActivityInnerLocked 方法在存在 resumeActivity 时会触发 onPause 的回调，如果没有则进入 startSpecificActivityLocked 走后续流程</p>
<h4 id="221-activitya-onpause-的执行">2.2.1 ActivityA onPause 的执行</h4>
<p>前半部的调用栈最后一个方法就是 resumeTopActivityInnerLocked，在这个方法中有一行代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">mResumedActivity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">pausing</span> <span class="o">|=</span> <span class="n">startPausingLocked</span><span class="o">(</span><span class="n">userLeaving</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">next</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>startPausingLocked 后续会通过 Binder IPC 调用回到 APP 进程，关键代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">mService</span><span class="o">.</span><span class="na">getLifecycleManager</span><span class="o">().</span><span class="na">scheduleTransaction</span><span class="o">(</span><span class="n">prev</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span><span class="o">,</span> <span class="n">prev</span><span class="o">.</span><span class="na">appToken</span><span class="o">,</span> <span class="n">PauseActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">prev</span><span class="o">.</span><span class="na">finishing</span><span class="o">,</span> <span class="n">userLeaving</span><span class="o">,</span> <span class="n">prev</span><span class="o">.</span><span class="na">configChangeFlags</span><span class="o">,</span> <span class="n">pauseImmediately</span><span class="o">));</span>
</code></pre></div><p>scheduleTransaction 最终会进入 ClientTransaction.scheduleTransaction，里面的 mClient 即 ApplicationThread(ApplicationThread 是跟随 APP 创建而出现的) 的 Binder 代理对象，这里还是通过 Binder IPC 调用到 APP 进程中。</p>
<p>而到了 APP 进程中就是 ActivityThread 通过 Handler 处理各种 Message，最终执行到 TransactionExecutor.execute！</p>
<p><code>这里看代码注意 ActivityThread extends ClientTransactionHandler</code> 就好，找不到的 transaction 相关方法，都在这个父类中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ClientTransaction</span> <span class="n">transaction</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="na">getActivityToken</span><span class="o">();</span>
    <span class="n">log</span><span class="o">(</span><span class="s">&#34;Start resolving transaction for client: &#34;</span> <span class="o">+</span> <span class="n">mTransactionHandler</span> <span class="o">+</span> <span class="s">&#34;, token: &#34;</span> <span class="o">+</span> <span class="n">token</span><span class="o">);</span>

    <span class="n">executeCallbacks</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>

    <span class="n">executeLifecycleState</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>
    <span class="n">mPendingActions</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">log</span><span class="o">(</span><span class="s">&#34;End resolving transaction&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>execute 方法中的 executeLifecycleState 方法很关键，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="cm">/** Transition to the final state if requested by the transaction. */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">executeLifecycleState</span><span class="o">(</span><span class="n">ClientTransaction</span> <span class="n">transaction</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ActivityLifecycleItem</span> <span class="n">lifecycleItem</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="na">getLifecycleStateRequest</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lifecycleItem</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// No lifecycle request, return early.
</span><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">(</span><span class="s">&#34;Resolving lifecycle state: &#34;</span> <span class="o">+</span> <span class="n">lifecycleItem</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="na">getActivityToken</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mTransactionHandler</span><span class="o">.</span><span class="na">getActivityClient</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Ignore requests for non-existent client records for now.
</span><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Cycle to the state right before the final requested state.
</span><span class="c1"></span>    <span class="n">cycleToPath</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">lifecycleItem</span><span class="o">.</span><span class="na">getTargetState</span><span class="o">(),</span> <span class="kc">true</span> <span class="cm">/* excludeLastState */</span><span class="o">);</span>

    <span class="c1">// Execute the final transition with proper parameters.
</span><span class="c1"></span>    <span class="n">lifecycleItem</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">mTransactionHandler</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">mPendingActions</span><span class="o">);</span>
    <span class="n">lifecycleItem</span><span class="o">.</span><span class="na">postExecute</span><span class="o">(</span><span class="n">mTransactionHandler</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">mPendingActions</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>lifecycleItem.execute 和 postExecute，基本就包含了 onPause 需要的整个过程。</p>
<p>看一下 PauseActivityItem 的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ClientTransactionHandler</span> <span class="n">client</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span>
        <span class="n">PendingTransactionActions</span> <span class="n">pendingActions</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;activityPause&#34;</span><span class="o">);</span>
    <span class="n">client</span><span class="o">.</span><span class="na">handlePauseActivity</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">mFinished</span><span class="o">,</span> <span class="n">mUserLeaving</span><span class="o">,</span> <span class="n">mConfigChanges</span><span class="o">,</span> <span class="n">pendingActions</span><span class="o">,</span>
            <span class="s">&#34;PAUSE_ACTIVITY_ITEM&#34;</span><span class="o">);</span>
    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postExecute</span><span class="o">(</span><span class="n">ClientTransactionHandler</span> <span class="n">client</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span>
        <span class="n">PendingTransactionActions</span> <span class="n">pendingActions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mDontReport</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// TODO(lifecycler): Use interface callback instead of AMS.
</span><span class="c1"></span>        <span class="n">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">activityPaused</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>execute 中调用了 handlePauseActivity，最终会调用到 Activity.onPause 方法，而 postExecute 中，又会通过 Binder IPC 调用到 AMS 进程，继续执行 Activity 启动的后续流程。</p>
<p>handlePauseActivity 到 Activity.onPause 的调用栈如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">onPause:</span><span class="n">1731</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onPause:</span><span class="n">395</span><span class="o">,</span> <span class="n">FragmentActivity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">v4</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">performPause:</span><span class="n">7329</span><span class="o">,</span> <span class="n">Activity</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">callActivityOnPause:</span><span class="n">1465</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">performPauseActivityIfNeeded:</span><span class="n">4021</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">performPauseActivity:</span><span class="n">3986</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">handlePauseActivity:</span><span class="n">3938</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">execute:</span><span class="n">45</span><span class="o">,</span> <span class="n">PauseActivityItem</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">servertransaction</span><span class="o">)</span>
<span class="nl">executeLifecycleState:</span><span class="n">145</span><span class="o">,</span> <span class="n">TransactionExecutor</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">servertransaction</span><span class="o">)</span>
<span class="nl">execute:</span><span class="n">70</span><span class="o">,</span> <span class="n">TransactionExecutor</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">servertransaction</span><span class="o">)</span>
<span class="nl">handleMessage:</span><span class="n">1808</span><span class="o">,</span> <span class="n">ActivityThread$H</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">dispatchMessage:</span><span class="n">106</span><span class="o">,</span> <span class="n">Handler</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
<span class="nl">loop:</span><span class="n">193</span><span class="o">,</span> <span class="n">Looper</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
<span class="nl">main:</span><span class="n">6669</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="o">-</span><span class="n">1</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">run:</span><span class="n">493</span><span class="o">,</span> <span class="n">RuntimeInit$MethodAndArgsCaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
<span class="nl">main:</span><span class="n">858</span><span class="o">,</span> <span class="n">ZygoteInit</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>回调到 AMS 中的后续流程调用栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">startSpecificActivityLocked:</span><span class="n">1688</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">resumeTopActivityInnerLocked:</span><span class="n">2764</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">resumeTopActivityUncheckedLocked:</span><span class="n">2302</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">resumeFocusedStackTopActivityLocked:</span><span class="n">2229</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">completePauseLocked:</span><span class="n">1606</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">activityPausedLocked:</span><span class="n">1530</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">activityPaused:</span><span class="n">8161</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">224</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">3291</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>所以，最终又会回到 startSpecificActivityLocked，这个关键的方法</p>
<p>上述的 ActivityA.startActivity -&gt; AcitivtyA.onPause 解释了 <code>问题1</code></p>
<h4 id="222-startspecificactivitylocked">2.2.2 startSpecificActivityLocked</h4>
<p>无论需不需要 onPause，最终都会执行到 startSpecificActivityLocked。这个方法中判断了进程是否已经存在，在整个流程中，经常有 app.thread 字样出现，app.thread == ApplicationThread 是个 Binder 对象。它跟随着 APP 进程的创建而创建并且传递给 AMS 进程的。</p>
<p>startSpecificActivityLocked 简洁的代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">realStartActivityLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">andResume</span><span class="o">,</span> <span class="n">checkConfig</span><span class="o">);</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">mService</span><span class="o">.</span><span class="na">startProcessLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;activity&#34;</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

</code></pre></div><p>所以，如果进程存在，则进入 realStartActivityLocked 走下一步流程。如果进程不存在则 startProcessLocked，启动一个 APP 进程。</p>
<p>启动进程的流程其实很复杂，也包括了 socket 的跨进程调用，fork 进程，反射启动 ActivityThread.main 方法等等</p>
<p>ActivityThread.main 方法首先创建了 ActivityThread 对象，与此同时</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">ApplicationThread</span> <span class="n">mAppThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationThread</span><span class="o">();</span>
</code></pre></div><p>作为成员变量的 ApplicationThread 也会被初始化，之后调用到 ActivityThread.attach 方法，关键代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">IActivityManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">mgr</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>所以，又通过 Binder IPC 回到 AMS 中，这就是 ApplicationThread 的源头。</p>
<p>AMS.attachApplication 的后续调用栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">realStartActivityLocked:</span><span class="n">1393</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">attachApplicationLocked:</span><span class="n">989</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">attachApplicationLocked:</span><span class="n">7872</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">attachApplication:</span><span class="n">7940</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">198</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">3291</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>realStartActivityLocked 这个方法再次出现，所以一切又回到了启动 Activity 的流程中。</p>
<p>这里的整个流程解释了 <code>问题3</code></p>
<p>所以无论是否需要创建进程，我们最终都会进入 realStartActivityLocked 方法中</p>
<h4 id="223-realstartactivitylocked">2.2.3 realStartActivityLocked</h4>
<p>realStartActivityLocked 核心代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Create activity launch transaction.
</span><span class="c1"></span><span class="kd">final</span> <span class="n">ClientTransaction</span> <span class="n">clientTransaction</span> <span class="o">=</span> <span class="n">ClientTransaction</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">thread</span><span class="o">,</span>
        <span class="n">r</span><span class="o">.</span><span class="na">appToken</span><span class="o">);</span>
<span class="n">clientTransaction</span><span class="o">.</span><span class="na">addCallback</span><span class="o">(</span><span class="n">LaunchActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">),</span>
        <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">r</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">,</span>
        <span class="c1">// TODO: Have this take the merged configuration instead of separate global
</span><span class="c1"></span>        <span class="c1">// and override configs.
</span><span class="c1"></span>        <span class="n">mergedConfiguration</span><span class="o">.</span><span class="na">getGlobalConfiguration</span><span class="o">(),</span>
        <span class="n">mergedConfiguration</span><span class="o">.</span><span class="na">getOverrideConfiguration</span><span class="o">(),</span> <span class="n">r</span><span class="o">.</span><span class="na">compat</span><span class="o">,</span>
        <span class="n">r</span><span class="o">.</span><span class="na">launchedFromPackage</span><span class="o">,</span> <span class="n">task</span><span class="o">.</span><span class="na">voiceInteractor</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">icicle</span><span class="o">,</span>
        <span class="n">r</span><span class="o">.</span><span class="na">persistentState</span><span class="o">,</span> <span class="n">results</span><span class="o">,</span> <span class="n">newIntents</span><span class="o">,</span> <span class="n">mService</span><span class="o">.</span><span class="na">isNextTransitionForward</span><span class="o">(),</span>
        <span class="n">profilerInfo</span><span class="o">));</span>

<span class="c1">// Set desired final state.
</span><span class="c1"></span><span class="kd">final</span> <span class="n">ActivityLifecycleItem</span> <span class="n">lifecycleItem</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">andResume</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">lifecycleItem</span> <span class="o">=</span> <span class="n">ResumeActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">isNextTransitionForward</span><span class="o">());</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">lifecycleItem</span> <span class="o">=</span> <span class="n">PauseActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">clientTransaction</span><span class="o">.</span><span class="na">setLifecycleStateRequest</span><span class="o">(</span><span class="n">lifecycleItem</span><span class="o">);</span>

<span class="c1">// Schedule transaction.
</span><span class="c1"></span><span class="n">mService</span><span class="o">.</span><span class="na">getLifecycleManager</span><span class="o">().</span><span class="na">scheduleTransaction</span><span class="o">(</span><span class="n">clientTransaction</span><span class="o">);</span>
</code></pre></div><p>这里和 2.2.1 整个流程很相近，都是通过 scheduleTransaction，然后进入 APP 所在进程，通过 ActivityThread Handler 执行相应的生命周期相关的 ActivityItem 方法。</p>
<p>唯一不同的是，这里是 clientTransaction.addCallback(LaunchActivityItem)，然后 clientTransaction.setLifecycleStateRequest(ResumeActivityItem)</p>
<p>这个不同点的处理过程的关键代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">preExecute</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ClientTransactionHandler</span> <span class="n">clientTransactionHandler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mActivityCallbacks</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">mActivityCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mActivityCallbacks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">preExecute</span><span class="o">(</span><span class="n">clientTransactionHandler</span><span class="o">,</span> <span class="n">mActivityToken</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mLifecycleStateRequest</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mLifecycleStateRequest</span><span class="o">.</span><span class="na">preExecute</span><span class="o">(</span><span class="n">clientTransactionHandler</span><span class="o">,</span> <span class="n">mActivityToken</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>所以，preExecute 时就会处理 callback 相关的代码，preExecute 在 ActivityThread(ClientTransactionHandler).excuteTransaction 方法中被执行，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeTransaction</span><span class="o">(</span><span class="n">ClientTransaction</span> <span class="n">transaction</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">transaction</span><span class="o">.</span><span class="na">preExecute</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">getTransactionExecutor</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>
    <span class="n">transaction</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>所以我们会先执行 LaunchActivityItem 然后执行 ResumeActivityItem</p>
<h3 id="23-activityb-的-oncreate-onstart-onresume">2.3 ActivityB 的 onCreate onStart onResume</h3>
<p>前面知道了，我们会先后执行 LaunchActivityItem 和 ResumeActivityItem。LaunchActivityItem 会调用到 handleLaunchActivity，之后会调用到 Activity.onCreate 方法，这其中支线流程其实也很复杂，包含了 Activity.attach 方法和 WMS 的一些关联。</p>
<p>ResumeActivityItem 会调用到 handleResumeActivity，之后会调用到 onResume 方法。</p>
<p>onStart 方法呢？</p>
<p>这里注意到一个方法 <code>cycleToPath</code>，在 TransactionExecutor 中执行 executeLifecycleState 时，总会先调用这个方法。此方法根据生命周期的值，判断当前要执行到哪个生命周期。</p>
<p>cycleToPath 代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">cycleToPath</span><span class="o">(</span><span class="n">ActivityClientRecord</span> <span class="n">r</span><span class="o">,</span> <span class="kt">int</span> <span class="n">finish</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">excludeLastState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">getLifecycleState</span><span class="o">();</span>
    <span class="n">log</span><span class="o">(</span><span class="s">&#34;Cycle from: &#34;</span> <span class="o">+</span> <span class="n">start</span> <span class="o">+</span> <span class="s">&#34; to: &#34;</span> <span class="o">+</span> <span class="n">finish</span> <span class="o">+</span> <span class="s">&#34; excludeLastState:&#34;</span> <span class="o">+</span> <span class="n">excludeLastState</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">IntArray</span> <span class="n">path</span> <span class="o">=</span> <span class="n">mHelper</span><span class="o">.</span><span class="na">getLifecyclePath</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">finish</span><span class="o">,</span> <span class="n">excludeLastState</span><span class="o">);</span>
    <span class="n">performLifecycleSequence</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>在执行 ResumeActivityItem 时，生命周期在 onCreate 和 onResume 之中，但是在定义中，还存在 onStart。这个方法会添加 onStart 和 onReume 生命周期，但是又因为参数原因，删掉了 onResume，所以此时只有 onStart 即 getLifecyclePath 会返回 onStart。然后会执行 performLifecycleSequence 方法，然后会执行到 mTransactionHandler.handleStartActivity 方法中，最终调用到 onStart 方法。</p>
<p>在 <code>cycleToPath</code> 此方法已经执行了之后，才会走到 execute 方法，执行 ResumeActivityItem 相关的方法，最终通过 handleResumeActivity 也会调用到 onResume 方法。</p>
<p>所以其实 AMS 不关心 onStart 这个生命周期吧</p>
<p>至此重要的流程基本结束了</p>
<p>这其中也解释了为什么不要在 onPause 中做耗时的操作，因为后一个 Activity 的启动需要等待前一个 onPause 流程的结束</p>
<h3 id="24-activitya-的-onstop-ondestroy-方法">2.4 ActivityA 的 onStop onDestroy 方法</h3>
<h4 id="241-onstop-的执行">2.4.1 onStop 的执行</h4>
<p>在之前 ActivityThread 中执行 handleResumeActivity 时，有一行代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Looper</span><span class="o">.</span><span class="na">myQueue</span><span class="o">().</span><span class="na">addIdleHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">Idler</span><span class="o">());</span>

<span class="c1">// Idler 中
</span><span class="c1"></span><span class="k">try</span> <span class="o">{</span>
    <span class="n">am</span><span class="o">.</span><span class="na">activityIdle</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">createdConfig</span><span class="o">,</span> <span class="n">stopProfiling</span><span class="o">);</span>
    <span class="n">a</span><span class="o">.</span><span class="na">createdConfig</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>这里又是一次 Binder IPC，后续流程的调用栈如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">stopActivityLocked:</span><span class="n">3477</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">activityIdleInternalLocked:</span><span class="n">2092</span><span class="o">,</span> <span class="n">ActivityStackSupervisor</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">activityIdle:</span><span class="n">7952</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">216</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">3291</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>stopActivityLocked 又会是和 onCreate 等一样的流程，通过</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">mService</span><span class="o">.</span><span class="na">getLifecycleManager</span><span class="o">().</span><span class="na">scheduleTransaction</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appToken</span><span class="o">,</span> <span class="n">StopActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">visible</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">configChangeFlags</span><span class="o">));</span>
</code></pre></div><p>执行了 onStop 生命周期。这其中还有很多逻辑，比如超时逻辑的处理 <code>IDLE_TIMEOUT_MSG</code></p>
<h4 id="242-ondestroy-的执行">2.4.2 onDestroy 的执行</h4>
<p>onDestroy 和 onStop 其实相似，都是在 Idle 时执行的。所以和 onStop 的流程也基本一致，其中会执行 destroyActivityLocked 方法。或者主动通过 Activity.finish 调用，使得 Activity 走入 onDestroy 方法。</p>
<p>主动 finish 的调用栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nl">destroyActivityLocked:</span><span class="n">4315</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">finishCurrentActivityLocked:</span><span class="n">3852</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">finishActivityLocked:</span><span class="n">3764</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">finishActivityLocked:</span><span class="n">3690</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">requestFinishActivityLocked:</span><span class="n">3530</span><span class="o">,</span> <span class="n">ActivityStack</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">finishActivity:</span><span class="n">5708</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">147</span><span class="o">,</span> <span class="n">IActivityManager$Stub</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">)</span>
<span class="nl">onTransact:</span><span class="n">3291</span><span class="o">,</span> <span class="n">ActivityManagerService</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">am</span><span class="o">)</span>
<span class="nl">execTransact:</span><span class="n">731</span><span class="o">,</span> <span class="n">Binder</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">)</span>
</code></pre></div><p>其中 destroyActivityLocked 中关键代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">mService</span><span class="o">.</span><span class="na">getLifecycleManager</span><span class="o">().</span><span class="na">scheduleTransaction</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appToken</span><span class="o">,</span> <span class="n">DestroyActivityItem</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">finishing</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">configChangeFlags</span><span class="o">));</span>
</code></pre></div><p>通过 Binder IPC 调用到 APP 进程执行 onDestroy 生命周期</p>
<h3 id="3剩下的两个问题">3.剩下的两个问题</h3>
<h4 id="31-问题5">3.1 问题5</h4>
<p>通过阅读代码也比较清晰，ActivityStack 是最大的概念，他持有多个 TaskRecord，控制哪个是前台任务等等。TaskRecord 是我们说的任务栈的概念，栈内有很多 Activity，而 ActivityRecord 是记录 Activity 的结构体。</p>
<h4 id="32-问题4">3.2 问题4</h4>
<p>onNewIntent 源码位置在 ActivityStarter 中 deliverNewIntent，这个方法最后会执行到 onNewIntent。</p>
<p>startActivityUnchecked 中可能会调用它，根据是否有 FLAG_ACTIVITY_CLEAR_TOP 标签等等。</p>
<h2 id="4总结">4.总结</h2>
<p>其实整个生命周期流程远比上面的复杂多变，包括各种情形下的生命周期变化，可能和我这里的普通情形不一致，所以可能也会导致代码流程不一致等等。</p>
<p>但是，这不影响对整个生命周期的认识！即使流程已经如此复杂了，但这还只是生命周期各种情形下的一小部分而已，可见启动一个 Activity 并不是很简单。</p>
<p>纵观整个生命周期，都伴随着各种 Binder IPC 的过程，所以 Binder 确实是 Android 的基础之一。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-12-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/Android/">Android</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2020-07-31-ffmpeg-%E7%AE%80%E6%98%93%E6%92%AD%E6%94%BE%E5%99%A8/" class="prev" rel="prev" title="FFmpeg 简易播放器"><i class="fas fa-angle-left fa-fw"></i>FFmpeg 简易播放器</a>
            <a href="/posts/2020-12-24-%E5%8D%8A%E5%A4%A9%E5%85%A5%E9%97%A8%E4%BA%86%E4%B8%8B-kotlin/" class="next" rel="next" title="半天入门了下 kotlin">半天入门了下 kotlin<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrain666"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2020-12-07T00:00:00Z","owner":"PTrain666","repo":"PTrain666.github.io","title":"再来看 Activity 启动流程"}},"data":{"id-1":"北邙山之光的 Blog","id-2":"北邙山之光的 Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
